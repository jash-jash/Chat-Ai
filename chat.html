<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <!-- Ensure true full-height on mobile (safe-area + dynamic viewport) -->
    <meta name="viewport" content="width=device-width, initial-scale=1, height=device-height, viewport-fit=cover" />
    <title>Chat@AI - Your Intelligent Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- D3.js for data visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Lottie Player Script -->
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
    <!-- Lottie Web Components for Signup Animation -->
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Monaco Editor -->
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>

    <style>
        /* Fill the entire mobile viewport including dynamic bars */
        html, body { height: 100%; }
        /* Use dynamic viewport units with sensible fallbacks */
        body {
            min-height: 100svh; /* modern browsers */
            min-height: 100dvh; /* iOS 16+ / Chrome 108+ */
            min-height: 100vh;  /* fallback */
            background-color: rgb(var(--bg-primary));
            overscroll-behavior: none; /* avoid rubber-banding gaps */
        }
        /* iOS Safari older versions */
        @supports (-webkit-touch-callout: none) {
            html { height: -webkit-fill-available; }
            body { min-height: -webkit-fill-available; }
        }
        /* Respect device safe areas so content isn't clipped under notches */
        .safe-area {
            padding-top: env(safe-area-inset-top);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
        }
        /* Theme CSS Variables */
        /* Emoji-safe font fallback */
        body, input, button, textarea, select {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Noto Color Emoji, EmojiOne Color, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
        }
        :root {
            /* Light Theme */
            --bg-primary: 255, 255, 255;
            --bg-secondary: 248, 250, 252;
            --bg-tertiary: 241, 245, 249;
            --bg-quaternary: 226, 232, 240;
            --bg-accent: 255, 255, 255;
            --bg-accent-hover: 248, 250, 252;
            --bg-success: 34, 197, 94;
            --bg-error: 239, 68, 68;
            --bg-warning: 245, 158, 11;
            
            --text-primary: 15, 23, 42;
            --text-secondary: 51, 65, 85;
            --text-tertiary: 100, 116, 139;
            --text-quaternary: 148, 163, 184;
            --text-inverse: 51, 65, 85;
            --text-accent: 51, 65, 85;
            --text-success: 22, 163, 74;
            --text-error: 220, 38, 38;
            --text-warning: 217, 119, 6;
            
            --border-primary: 226, 232, 240;
            --border-secondary: 203, 213, 225;
            --border-accent: 226, 232, 240;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: 15, 23, 42;
            --bg-secondary: 30, 41, 59;
            --bg-tertiary: 51, 65, 85;
            --bg-quaternary: 71, 85, 105;
            --bg-accent: 6, 182, 212;
            --bg-accent-hover: 8, 145, 178;
            --bg-success: 34, 197, 94;
            --bg-error: 239, 68, 68;
            --bg-warning: 245, 158, 11;
            
            --text-primary: 248, 250, 252;
            --text-secondary: 226, 232, 240;
            --text-tertiary: 203, 213, 225;
            --text-quaternary: 148, 163, 184;
            --text-inverse: 15, 23, 42;
            --text-accent: 34, 211, 238;
            --text-success: 74, 222, 128;
            --text-error: 248, 113, 113;
            --text-warning: 251, 191, 36;
            
            --border-primary: 51, 65, 85;
            --border-secondary: 71, 85, 105;
            --border-accent: 6, 182, 212;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        [data-theme="midnight"] {
            /* Midnight Dark Theme */
            --bg-primary: 3, 7, 18;
            --bg-secondary: 15, 23, 42;
            --bg-tertiary: 30, 41, 59;
            --bg-quaternary: 51, 65, 85;
            --bg-accent: 139, 92, 246;
            --bg-accent-hover: 124, 58, 237;
            --bg-success: 34, 197, 94;
            --bg-error: 239, 68, 68;
            --bg-warning: 245, 158, 11;
            
            --text-primary: 255, 255, 255;
            --text-secondary: 241, 245, 249;
            --text-tertiary: 226, 232, 240;
            --text-quaternary: 148, 163, 184;
            --text-inverse: 3, 7, 18;
            --text-accent: 196, 181, 253;
            --text-success: 74, 222, 128;
            --text-error: 248, 113, 113;
            --text-warning: 251, 191, 36;
            
            --border-primary: 30, 41, 59;
            --border-secondary: 51, 65, 85;
            --border-accent: 139, 92, 246;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }

        /* Theme-aware classes */
        .bg-theme-primary { background-color: rgb(var(--bg-primary)); }
        .bg-theme-secondary { background-color: rgb(var(--bg-secondary)); }
        .bg-theme-tertiary { background-color: rgb(var(--bg-tertiary)); }
        .bg-theme-quaternary { background-color: rgb(var(--bg-quaternary)); }
        .bg-theme-accent { background-color:  rgb(34 197 96 / 48%);}
        .bg-theme-success { background-color: rgb(var(--bg-success)); }
        .bg-theme-error { background-color: rgb(var(--bg-error)); }
        .bg-theme-warning { background-color: rgb(var(--bg-warning)); }

        .text-theme-primary { color: rgb(var(--text-primary)); }
        .text-theme-secondary { color: rgb(var(--text-secondary)); }
        .text-theme-tertiary { color: rgb(var(--text-tertiary)); }
        .text-theme-quaternary { color: rgb(var(--text-quaternary)); }
        .text-theme-inverse { color: rgb(var(--text-inverse)); }
        .text-theme-accent { color: rgb(var(--text-accent)); }
        .text-theme-success { color: rgb(var(--text-success)); }
        .text-theme-error { color: rgb(var(--text-error)); }
        .text-theme-warning { color: rgb(var(--text-warning)); }

        .border-theme-primary { border-color: rgb(var(--border-primary)); }
        .border-theme-secondary { border-color: rgb(var(--border-secondary)); }
        .border-theme-accent { border-color: rgb(var(--border-accent)); }

        /* Micro-interactions: smooth transitions for interactive elements */
        :where(button, .btn, [role="button"], .code-action-btn, .edit-btn, .delete-btn, .tab, .nav-link, a) {
            transition: background-color 300ms ease-in-out, color 300ms ease-in-out,
                        box-shadow 300ms ease-in-out, transform 300ms ease-in-out,
                        opacity 300ms ease-in-out, border-color 300ms ease-in-out;
        }

        /* Subtle hover scale for buttons */
        :where(button, .btn, .code-action-btn):not(.no-hover-scale):hover {
            transform: translateZ(0) scale(1.03);
        }

        /* Ripple effect */
        .ripple-container { position: relative; overflow: hidden; }
        .ripple {
            position: absolute;
            border-radius: 9999px;
            transform: scale(0);
            opacity: 0.35;
            background: currentColor;
            pointer-events: none;
            animation: ripple 600ms ease-out;
        }
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }

        /* Chat history enter animation */
        .history-animate-enter { opacity: 0; transform: translateY(6px); }
        .history-animate-active { opacity: 1; transform: translateY(0); }

        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            :where(button, .btn, [role="button"], .code-action-btn, .edit-btn, .delete-btn, .tab, .nav-link, a) {
                transition: none !important;
            }
            .ripple { animation: none !important; display: none !important; }
            .history-animate-enter, .history-animate-active { transition: none !important; }
        }

        .hover\:bg-theme-accent:hover { background-color: rgb(var(--bg-accent-hover)); }
        .hover\:bg-theme-tertiary:hover { background-color: rgb(var(--bg-tertiary)); }
        .hover\:bg-theme-quaternary:hover { background-color: rgb(var(--bg-quaternary)); }

        /* ENHANCED DELETE & EDIT BUTTON STYLES */
        
        /* Professional Edit Button Styling */
        .edit-btn, button[title="Edit message"], button[onclick*="editPrompt"], button[onclick*="editScheduledTask"], .history-item-actions button[title="Rename chat"] {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            padding: 6px;
            border: 1.5px solid rgba(var(--border-primary), 0.6);
            border-radius: 8px;
            background: linear-gradient(135deg, 
                rgba(var(--bg-secondary), 0.8) 0%, 
                rgba(var(--bg-tertiary), 0.9) 100%);
            color: rgba(var(--text-secondary), 0.8);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(8px);
            overflow: hidden;
            flex-shrink: 0;
        }

        .edit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(var(--bg-accent), 0.1), 
                transparent);
            transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .edit-btn:hover, button[title="Edit message"]:hover, button[onclick*="editPrompt"]:hover, button[onclick*="editScheduledTask"]:hover, .history-item-actions button[title="Rename chat"]:hover {
            border-color: rgba(var(--bg-accent), 0.4);
            background: linear-gradient(135deg, 
                rgba(var(--bg-accent), 0.08) 0%, 
                rgba(var(--bg-tertiary), 0.95) 50%,
                rgba(var(--bg-accent), 0.08) 100%);
            color: rgb(var(--text-accent));
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 16px rgba(var(--bg-accent), 0.15),
                        0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .edit-btn:hover::before {
            left: 100%;
        }

        .edit-btn:active, button[title="Edit message"]:active, button[onclick*="editPrompt"]:active, button[onclick*="editScheduledTask"]:active, .history-item-actions button[title="Rename chat"]:active {
            transform: translateY(-1px) scale(1.01);
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Professional Delete Button Styling */
        .delete-btn, button[onclick*="deletePrompt"], button[onclick*="deleteScheduledTask"], .history-item-actions button[title="Delete chat"] {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            padding: 6px;
            border: 1.5px solid rgba(var(--border-primary), 0.6);
            border-radius: 8px;
            background: linear-gradient(135deg, 
                rgba(var(--bg-secondary), 0.8) 0%, 
                rgba(var(--bg-tertiary), 0.9) 100%);
            color: rgba(var(--text-secondary), 0.8);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(8px);
            overflow: hidden;
            flex-shrink: 0;
        }

        .delete-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(var(--bg-error), 0.1), 
                transparent);
            transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .delete-btn:hover, button[onclick*="deletePrompt"]:hover, button[onclick*="deleteScheduledTask"]:hover, .history-item-actions button[title="Delete chat"]:hover {
            border-color: rgba(var(--bg-error), 0.4);
            background: linear-gradient(135deg, 
                rgba(var(--bg-error), 0.08) 0%, 
                rgba(var(--bg-tertiary), 0.95) 50%,
                rgba(var(--bg-error), 0.08) 100%);
            color: rgb(var(--text-error));
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 16px rgba(var(--bg-error), 0.15),
                        0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .delete-btn:hover::before {
            left: 100%;
        }

        .delete-btn:active, button[onclick*="deletePrompt"]:active, button[onclick*="deleteScheduledTask"]:active, .history-item-actions button[title="Delete chat"]:active {
            transform: translateY(-1px) scale(1.01);
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Enhanced Action Button Groupings */
        .action-button-group {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 4px;
            border-radius: 12px;
            background: rgba(var(--bg-secondary), 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(var(--border-primary), 0.3);
        }

        /* Modal Delete/Edit Button Variants */
        .modal-edit-btn, .modal-delete-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .modal-edit-btn {
            border: 1.5px solid rgba(var(--bg-accent), 0.3);
            background: linear-gradient(135deg, 
                rgba(var(--bg-accent), 0.05) 0%, 
                rgba(var(--bg-secondary), 0.9) 100%);
            color: rgb(var(--text-accent));
        }

        .modal-edit-btn:hover {
            border-color: rgba(var(--bg-accent), 0.5);
            background: linear-gradient(135deg, 
                rgba(var(--bg-accent), 0.1) 0%, 
                rgba(var(--bg-accent), 0.05) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(var(--bg-accent), 0.2);
        }

        .modal-delete-btn {
            border: 1.5px solid rgba(var(--bg-error), 0.3);
            background: linear-gradient(135deg, 
                rgba(var(--bg-error), 0.05) 0%, 
                rgba(var(--bg-secondary), 0.9) 100%);
            color: rgb(var(--text-error));
        }

        .modal-delete-btn:hover {
            border-color: rgba(var(--bg-error), 0.5);
            background: linear-gradient(135deg, 
                rgba(var(--bg-error), 0.1) 0%, 
                rgba(var(--bg-error), 0.05) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(var(--bg-error), 0.2);
        }

        /* Icon Styling within Buttons */
        .edit-btn svg, .delete-btn svg, 
        button[title="Edit message"] svg, button[onclick*="editPrompt"] svg, button[onclick*="editScheduledTask"] svg,
        button[onclick*="deletePrompt"] svg, button[onclick*="deleteScheduledTask"] svg,
        .history-item-actions button svg {
            width: 18px;
            height: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .edit-btn:hover svg, button[title="Edit message"]:hover svg, 
        button[onclick*="editPrompt"]:hover svg, button[onclick*="editScheduledTask"]:hover svg,
        .history-item-actions button[title="Rename chat"]:hover svg {
            transform: scale(1.1) rotate(5deg);
        }

        .delete-btn:hover svg, button[onclick*="deletePrompt"]:hover svg, 
        button[onclick*="deleteScheduledTask"]:hover svg,
        .history-item-actions button[title="Delete chat"]:hover svg {
            transform: scale(1.1) rotate(-5deg);
        }

        /* Photo Upload Style Search Bar */
        .photo-search-container {
            position: relative;
            background: rgb(var(--bg-primary));
            border: 2px solid rgb(var(--border-secondary));
            border-radius: 12px;
            padding: 12px;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(var(--border-secondary), 0.4);
        }

        .photo-search-container:hover {
            border-color: rgb(var(--text-accent));
            border-width: 2px;
            background: linear-gradient(135deg, rgba(var(--bg-secondary), 0.95) 0%, rgba(var(--bg-tertiary), 0.95) 100%);
            box-shadow: 0 4px 12px rgba(var(--border-secondary), 0.3);
            transform: translateY(-1px);
        }

        .photo-search-container.focused {
            border-color: rgb(var(--text-accent));
            border-style: solid;
            border-width: 2px;
            background: rgba(var(--bg-primary), 0.98);
            box-shadow: 0 0 0 3px rgba(var(--text-accent), 0.2);
        }

        .photo-search-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: rgb(var(--text-primary));
            font-size: 0.875rem;
            padding: 8px;
            padding-right: 40px;
            margin-left: 8px;
        }

        .photo-search-input::placeholder {
            color: rgb(var(--text-tertiary));
            font-style: italic;
            opacity: 0.8;
        }

        .photo-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            /* Use theme-aware accent background so contrast is preserved across themes */
            background: rgb(var(--bg-accent));
            border: 2px solid rgba(var(--border-secondary), 0.6);
            border-radius: 50%;
            padding: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(var(--border-secondary), 0.4);
            /* Use the accent text color for the icon by default */
            color: rgb(var(--text-accent));
        }

        .photo-search-container:hover .photo-search-icon {
            transform: translateY(-50%) scale(1.1);
            /* Highlight using the text-accent color so the circle stands out on hover */
            background: rgb(var(--text-accent));
            box-shadow: 0 4px 12px rgba(var(--text-accent), 0.3);
            border-color: rgb(var(--text-accent));
            /* Make the icon stroke contrast with the new dark background by switching to the bg-accent color */
            color: rgb(var(--bg-accent));
        }

        .photo-search-icon svg {
            width: 14px;
            height: 14px;
            /* Use currentColor so the SVG automatically matches the container's color (and adapts on hover) */
            stroke: currentColor;
            stroke-width: 2;
            transition: all 0.3s ease;
            fill: none;
        }

        /* Dark theme: ensure icon color is always light */
        [data-theme="dark"] .photo-search-icon,
        [data-theme="midnight"] .photo-search-icon {
            color: rgb(var(--text-primary));
        }

        [data-theme="dark"] .photo-search-container:hover .photo-search-icon,
        [data-theme="midnight"] .photo-search-container:hover .photo-search-icon {
            color: rgb(var(--bg-primary));
        }

        .photo-search-overlay {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 12px;
            background: linear-gradient(45deg, transparent, rgba(var(--bg-accent), 0.1), transparent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .photo-search-container:hover .photo-search-overlay {
            opacity: 1;
        }

        /* Signup Success Animation Styles */
        .signup-success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9) 0%, rgba(59, 130, 246, 0.9) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .signup-success-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .signup-success-content {
            text-align: center;
            color: white;
            max-width: 500px;
            padding: 2rem;
            transform: translateY(20px);
            transition: transform 0.6s ease;
        }

        .signup-success-overlay.show .signup-success-content {
            transform: translateY(0);
        }

        .signup-success-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            animation: slideInDown 0.8s ease-out;
        }

        .signup-success-subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            animation: slideInUp 0.8s ease-out 0.3s both;
        }

        .signup-success-animation {
            margin: 2rem 0;
            animation: scaleIn 0.8s ease-out 0.6s both;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .loading-dots {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            animation: loadingDot 1.5s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: 0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.3s; }
        .loading-dot:nth-child(3) { animation-delay: 0.6s; }

        @keyframes loadingDot {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Medical mode specific styles */
        .medical-mode-indicator {
            width: 2rem;
            height: 2rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .medical-disclaimer {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .medical-feature-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }
        .medical-feature-card:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            border-color: rgba(16, 185, 129, 0.5);
            transform: translateY(-2px);
        }

        /* Theme selector styles */
        .theme-selector {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-dropdown {
            position: absolute;
            top: calc(100% + 0.75rem);
            right: 0;
            background: linear-gradient(135deg, rgba(var(--bg-secondary), 0.95), rgba(var(--bg-tertiary), 0.95));
            border: 1.5px solid rgba(var(--border-accent), 0.15);
            border-radius: 1rem;
            box-shadow: 
                0 4px 20px rgba(var(--bg-accent), 0.1),
                0 2px 8px rgba(0, 0, 0, 0.1);
            width: 180px;
            z-index: 100;
            display: none;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transform: translateY(-8px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .theme-dropdown.show { 
            display: block;
            transform: translateY(0);
            opacity: 1;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.25rem;
            font-size: 0.875rem;
            color: rgb(0, 0, 0);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        [data-theme="dark"] .theme-option,
        [data-theme="midnight"] .theme-option {
            color: rgb(var(--text-secondary));
        }

        .theme-option::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, 
                rgba(var(--bg-accent), 0) 0%,
                rgba(var(--bg-accent), 0.1) 50%,
                rgba(var(--bg-accent), 0) 100%);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .theme-option:hover {
            background: rgba(var(--bg-accent), 0.08);
            color: rgb(var(--text-accent));
        }

        .theme-option:hover::before {
            transform: translateX(100%);
        }

        .theme-option.active {
            background: rgba(var(--bg-accent), 0.15);
            color: rgb(var(--text-accent));
            font-weight: 500;
        }

        .theme-option svg {
            width: 18px;
            height: 18px;
            transition: transform 0.2s;
        }

        .theme-option:hover svg {
            transform: scale(1.1) rotate(5deg);
        }

        /* Custom scrollbar for themed appearance */
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: rgb(var(--bg-secondary)); }
        ::-webkit-scrollbar-thumb { background: rgb(var(--bg-quaternary)); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgb(var(--border-secondary)); }

        html, body { 
            font-family: 'Inter', sans-serif;
            font-feature-settings: "cv02", "cv03", "cv04", "cv11";
        }
        
        .main-content {
            min-width: 0;
        }
        
        .sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        .mic-active { color: rgb(var(--text-error)); }
        #chat-input {
            max-height: 200px;
            resize: none;
        }

        /* ENHANCED ChatGPT-STYLE Prose Styling - Professional & Beautiful */
        .prose { 
            color: rgb(var(--text-secondary));
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.8;
            font-size: 1rem;
            max-width: none;
        }

        /* ============= TYPOGRAPHY HIERARCHY - CHATGPT STYLE ============= */
        
        .prose h1 { 
            color: rgb(var(--text-primary)); 
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 1.15;
            margin-top: 2.5rem;
            margin-bottom: 1.25rem;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.025em;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(var(--bg-accent), 0.2);
        }
        
        .prose h2 { 
            color: rgb(var(--text-primary)); 
            font-size: 2rem;
            font-weight: 650;
            line-height: 1.25;
            margin-top: 2.25rem;
            margin-bottom: 1.15rem;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.015em;
            padding-bottom: 0.5rem;
            border-bottom: 1.5px solid rgba(var(--bg-accent), 0.15);
        }
        
        .prose h3 { 
            color: rgb(var(--text-primary)); 
            font-size: 1.75rem;
            font-weight: 620;
            line-height: 1.3;
            margin-top: 2rem;
            margin-bottom: 0.9rem;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.01em;
        }
        
        .prose h4 { 
            color: rgb(var(--text-primary)); 
            font-size: 1.4rem;
            font-weight: 610;
            line-height: 1.35;
            margin-top: 1.75rem;
            margin-bottom: 0.85rem;
            font-family: 'Inter', sans-serif;
        }
        
        .prose h5 { 
            color: rgb(var(--text-primary)); 
            font-size: 1.2rem;
            font-weight: 605;
            line-height: 1.4;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-family: 'Inter', sans-serif;
            text-transform: capitalize;
        }
        
        .prose h6 { 
            color: rgb(var(--text-primary)); 
            font-size: 1.05rem;
            font-weight: 600;
            line-height: 1.4;
            margin-top: 1.25rem;
            margin-bottom: 0.65rem;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ============= PARAGRAPH & TEXT STYLING ============= */
        
        .prose p { 
            margin-bottom: 1.35rem;
            line-height: 1.85;
            color: rgb(var(--text-secondary));
            font-weight: 400;
        }
        .prose p:last-child { margin-bottom: 0; }

        /* Improved Link Styling with effects */
        .prose a { 
            color: rgb(var(--text-accent));
            text-decoration: none;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(90deg, transparent 0%, rgba(var(--bg-accent), 0.1) 100%);
            padding: 2px 4px;
            border-radius: 3px;
        }
        .prose a:hover {
            border-bottom-color: rgb(var(--text-accent));
            background: linear-gradient(90deg, rgba(var(--bg-accent), 0.15) 0%, rgba(var(--bg-accent), 0.1) 100%);
            transform: translateX(2px);
        }

        /* Enhanced Strong/Bold Text with visual emphasis */
        .prose strong, .prose b { 
            color: rgb(var(--text-primary));
            font-weight: 700;
            background: linear-gradient(90deg, transparent, rgba(var(--bg-accent), 0.08), transparent);
            padding: 2px 4px;
            border-radius: 2px;
        }

        /* Enhanced Emphasis with proper styling */
        .prose em, .prose i {
            color: rgb(var(--text-primary));
            font-style: italic;
            font-weight: 500;
            opacity: 0.9;
        }

        /* ============= LIST STYLING - PROFESSIONAL ============= */
        
        .prose ul, .prose ol {
            margin-bottom: 1.35rem;
            padding-left: 2rem;
        }
        
        .prose ul li {
            margin-bottom: 0.65rem;
            position: relative;
            line-height: 1.8;
        }
        
        .prose ul li::marker { 
            color: rgb(var(--text-accent));
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .prose ol li {
            margin-bottom: 0.65rem;
            position: relative;
            line-height: 1.8;
        }
        
        .prose ol li::marker { 
            color: rgb(var(--text-accent));
            font-weight: 700;
            font-size: 1.05em;
        }
        
        .prose li > ul, .prose li > ol {
            margin-top: 0.65rem;
            margin-bottom: 0;
        }

        /* Nested list styling */
        .prose li ul li::marker { color: rgba(var(--text-accent), 0.8); }
        .prose li ol li::marker { color: rgba(var(--text-accent), 0.8); }

        /* ============= BLOCKQUOTE STYLING - ELEGANT ============= */
        
        .prose blockquote {
            border-left: 5px solid rgb(var(--text-accent));
            padding-left: 1.75rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-right: 1rem;
            margin: 2rem 0;
            background: linear-gradient(90deg, 
                rgba(var(--bg-accent), 0.08) 0%, 
                rgba(var(--bg-accent), 0.02) 50%,
                transparent 100%);
            border-radius: 0 0.5rem 0.5rem 0;
            font-style: italic;
            color: rgb(var(--text-tertiary));
            box-shadow: 0 2px 8px rgba(var(--bg-accent), 0.05);
        }
        
        .prose blockquote p {
            margin-bottom: 0.85rem;
        }
        
        .prose blockquote p:last-child {
            margin-bottom: 0;
        }

        /* ============= CODE & SYNTAX HIGHLIGHTING ============= */
        
        .prose code { 
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            background-color: rgba(var(--bg-tertiary), 0.9);
            color: rgb(var(--text-accent));
            padding: 0.35rem 0.6rem;
            border-radius: 0.4rem;
            border: 1px solid rgba(var(--border-primary), 0.6);
            font-weight: 500;
            word-break: break-word;
            transition: all 0.2s ease;
        }
        
        .prose code:hover {
            background-color: rgba(var(--bg-quaternary), 0.95);
            border-color: rgba(var(--bg-accent), 0.3);
        }

        /* Enhanced Pre/Code Block Styling - MASSIVE IMPROVEMENT */
        .prose pre {
            background: linear-gradient(135deg, 
                rgb(var(--bg-quaternary)) 0%, 
                rgba(var(--bg-quaternary), 0.95) 100%);
            border-radius: 1rem;
            padding: 1.75rem;
            position: relative;
            overflow-x: auto;
            overflow-y: auto;
            margin: 2rem 0;
            border: 1px solid rgba(var(--border-primary), 0.4);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12),
                       inset 0 1px 0 rgba(255, 255, 255, 0.1);
            line-height: 1.6;
            max-height: 500px;
        }
        
        .prose pre code { 
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            background: none;
            color: rgb(var(--text-primary));
            padding: 0;
            border: none;
            border-radius: 0;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        
        /* Line numbers for code blocks */
        .prose pre::before {
            content: attr(data-language);
            position: absolute;
            top: 0.75rem;
            right: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(var(--text-tertiary), 0.6);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            z-index: 1;
        }

        /* Code Action Buttons - ENHANCED */
        .code-btn-wrapper {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .prose pre:hover .code-btn-wrapper { 
            opacity: 1;
        }
        
        .code-action-btn {
            background: linear-gradient(135deg, 
                rgba(var(--bg-tertiary), 0.8) 0%, 
                rgba(var(--bg-quaternary), 0.9) 100%);
            color: rgb(var(--text-secondary));
            border: 1px solid rgba(var(--border-primary), 0.5);
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0.5rem;
            backdrop-filter: blur(8px);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .code-action-btn:hover {
            background: linear-gradient(135deg, 
                rgba(var(--bg-accent), 0.15) 0%, 
                rgba(var(--bg-tertiary), 0.95) 100%);
            color: rgb(var(--text-primary));
            border-color: rgba(var(--bg-accent), 0.4);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(var(--bg-accent), 0.15);
        }
        
        .code-action-btn:active {
            transform: translateY(0);
        }

        /* ============= TABLE STYLING - PROFESSIONAL & MODERN ============= */
        
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            font-size: 0.95rem;
            background-color: rgb(var(--bg-primary));
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(var(--border-primary), 0.3);
        }
        
        .prose th, .prose td {
            border: 1px solid rgba(var(--border-primary), 0.4);
            padding: 1rem;
            text-align: left;
            vertical-align: middle;
        }
        
        .prose th {
            background: linear-gradient(135deg, 
                rgba(var(--bg-tertiary), 0.8) 0%, 
                rgba(var(--bg-quaternary), 0.9) 100%);
            font-weight: 700;
            color: rgb(var(--text-primary));
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .prose tbody tr {
            transition: all 0.2s ease;
        }
        
        .prose tbody tr:nth-child(even) { 
            background-color: rgba(var(--bg-tertiary), 0.25); 
        }
        
        .prose tbody tr:hover {
            background-color: rgba(var(--bg-accent), 0.1);
        }
        
        .prose td {
            color: rgb(var(--text-secondary));
        }
        
        .table-responsive-wrapper {
            overflow-x: auto;
            border: 1px solid rgba(var(--border-primary), 0.3);
            border-radius: 1rem;
            margin: 2rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .table-responsive-wrapper table {
            margin: 0 !important;
            border-radius: 0;
            box-shadow: none;
            border: none;
        }

        /* ============= HORIZONTAL RULE - ELEGANT ============= */
        
        .prose hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(var(--bg-accent), 0.3) 50%, 
                transparent 100%);
            margin: 3rem 0;
            border-radius: 1px;
        }

        /* ============= IMAGE STYLING ============= */
        
        .prose img {
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            margin: 2rem 0;
            max-width: 100%;
            height: auto;
            border: 1px solid rgba(var(--border-primary), 0.2);
            transition: all 0.3s ease;
            cursor: zoom-in;
        }
        
        .prose img:hover {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.18);
            transform: translateY(-2px);
        }

        /* ============= RESPONSIVE PROSE ============= */
        
        @media (max-width: 768px) {
            .prose {
                font-size: 0.95rem;
                line-height: 1.75;
            }
            
            .prose h1 { 
                font-size: 1.85rem;
                margin-top: 1.75rem;
            }
            
            .prose h2 { 
                font-size: 1.55rem;
                margin-top: 1.5rem;
            }
            
            .prose h3 { 
                font-size: 1.35rem;
            }
            
            .prose pre {
                padding: 1.25rem;
                margin: 1.5rem 0;
            }
            
            .prose code {
                font-size: 0.85rem;
            }
            
            .code-btn-wrapper {
                top: 0.75rem;
                right: 0.75rem;
                gap: 0.5rem;
            }
            
            .prose table {
                font-size: 0.9rem;
            }
            
            .prose th, .prose td {
                padding: 0.75rem;
            }
        }

        /* ============= AI RESPONSE MESSAGE CONTAINER ============= */
        
        .ai-response-container {
            background: linear-gradient(135deg, 
                rgba(var(--bg-secondary), 0.5) 0%, 
                rgba(var(--bg-tertiary), 0.3) 100%);
            border: 1px solid rgba(var(--border-primary), 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }
        
        .ai-response-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                rgb(var(--bg-accent)), 
                transparent);
        }
        
        .ai-response-container.loading {
            animation: pulse-response 2s infinite;
        }
        
        @keyframes pulse-response {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* ============= RESPONSE METADATA ============= */
        
        .response-metadata {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: rgb(var(--text-quaternary));
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(var(--border-primary), 0.2);
        }
        
        .response-time {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .response-time svg {
            width: 14px;
            height: 14px;
        }

        /* ============= TYPING INDICATOR ENHANCED ============= */
        
        .typing-indicator {
            display: flex;
            gap: 0.4rem;
            align-items: flex-end;
            height: 1.5rem;
        }
        
        .typing-dot {
            width: 0.6rem;
            height: 0.6rem;
            border-radius: 50%;
            background-color: rgba(var(--text-quaternary), 0.6);
            animation: typing-animation 1.4s infinite;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing-animation {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.6;
            }
            30% {
                transform: translateY(-0.8rem);
                opacity: 1;
            }
        }

        /* ============= CODE HIGHLIGHT IMPROVEMENTS (GPT-STYLE) ============= */

        /* Wrapper around the code block to provide a GPT-like header + body */
        .code-wrapper {
            border-radius: 10px;
            overflow: hidden;
            margin: 0.9rem 0;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(100,100,110,0.06);
            background: linear-gradient(180deg, rgba(var(--bg-secondary),0.6), rgba(var(--bg-primary),1));
        }

        .code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            gap: 8px;
            background: linear-gradient(90deg, rgba(59,130,246,0.12), rgba(139,92,246,0.06));
            border-bottom: 1px solid rgba(0,0,0,0.04);
            font-size: 12px;
        }

        .code-lang {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: rgb(var(--text-secondary));
            font-weight: 600;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(4px);
        }

        .code-header .code-header-actions { display:flex; gap: 8px; align-items:center }

        .code-copy-btn, .code-mini-btn {
            display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:6px;
            border: 1px solid rgba(255,255,255,0.03); background: rgba(255,255,255,0.02); color: rgb(var(--text-secondary));
            font-weight: 600; font-size: 12px; cursor:pointer; transition: all .16s ease;
        }

        .code-copy-btn:hover, .code-mini-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,0.08); }

        /* Body grid with line-number column and code area */
        .code-grid { display: grid; grid-template-columns: min-content 1fr; align-items: start; }

        .line-numbers { padding: 12px 8px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color: rgba(148,163,184,0.9); text-align: right; user-select: none; border-right: 1px solid rgba(0,0,0,0.03); }
        .line-numbers span { display:block; font-size:12px; padding:0 8px; height: 20px; line-height:20px; }

        pre.hljs {
            margin: 0; padding: 14px 16px; overflow:auto; border-radius: 0 0 10px 0; background: rgba(0,0,0,0.02); color: rgb(var(--text-primary));
            font-family: Fira Code, ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-size: 13px; line-height:1.55; 
        }

        /* Keep our token color customizations to make them vibrant across themes */
        .hljs { background: transparent !important; }
        .hljs-string { color: #22c55e; }
        .hljs-number { color: #f59e0b; }
        .hljs-literal { color: #ef4444; }
        .hljs-attr { color: #3b82f6; }
        .hljs-built_in { color: #8b5cf6; }
        .hljs-variable { color: #06b6d4; }
        .hljs-comment { color: rgba(107, 114, 128, 0.8); font-style: italic; }

        .code-copy-btn .copy-feedback { display:none; font-size:11px; color: #0f172a; font-weight:700; margin-left:6px; }
        .code-copy-btn .copy-feedback.show { display:inline-block; animation: pop .45s ease-out; }
        @keyframes pop { 0% { transform: scale(.88); opacity:0; } 100% { transform: scale(1); opacity:1; } }

        .like-button, .dislike-button {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            overflow: hidden;
            transition: all 0.3s ease;
        }

            .like-button svg, .dislike-button svg {
                width: 24px;
                height: 24px;
                transition: all 0.3s ease;
                fill: rgb(var(--text-quaternary));
            }

            .like-button.active svg {
                animation: likeAnimation 0.5s ease-out;
                fill: rgb(34, 197, 94) !important;
            }

            .dislike-button.active svg {
                animation: dislikeAnimation 0.5s ease-out;
                fill: rgb(239, 68, 68) !important;
            }        .like-button.active::after, .dislike-button.active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            pointer-events: none;
            animation: rippleEffect 0.6s ease-out;
        }

        .like-button.active::after {
            background: rgba(var(--text-success), 0.2);
        }

        .dislike-button.active::after {
            background: rgba(var(--text-error), 0.2);
        }

        .like-button:hover svg {
            transform: scale(1.2) rotate(10deg);
            fill: rgb(34, 197, 94);
        }

        .dislike-button:hover svg {
            transform: scale(1.2) rotate(-10deg);
            fill: rgb(239, 68, 68);
        }

        /* Enhanced Table Styling */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.875rem;
            background-color: rgb(var(--bg-primary));
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .prose th, .prose td {
            border: 1px solid rgb(var(--border-primary));
            padding: 0.875rem 1rem;
            text-align: left;
            vertical-align: top;
        }
        .prose th {
            background-color: rgb(var(--bg-tertiary));
            font-weight: 600;
            color: rgb(var(--text-primary));
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .prose tbody tr:nth-child(even) { 
            background-color: rgba(var(--bg-tertiary), 0.3); 
        }
        .prose tbody tr:hover {
            background-color: rgba(var(--bg-tertiary), 0.5);
        }
        .table-responsive-wrapper {
            overflow-x: auto;
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.75rem;
            margin: 1.5rem 0;
            box-shadow: var(--shadow);
        }
        .table-responsive-wrapper table {
            margin: 0 !important;
            border-radius: 0;
            box-shadow: none;
        }

        /* Enhanced HR Styling */
        .prose hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgb(var(--border-primary)), transparent);
            margin: 2rem 0;
        }

        /* Enhanced Image Styling */
        .prose img {
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            margin: 1.5rem 0;
        }

        /* Responsive Design for Prose */
        @media (max-width: 768px) {
            .prose {
                font-size: 0.9rem;
            }
            .prose h1 { font-size: 1.75rem; }
            .prose h2 { font-size: 1.5rem; }
            .prose h3 { font-size: 1.25rem; }
            .prose h4 { font-size: 1.125rem; }
            .prose pre {
                padding: 1rem;
            }
        }

        /* Typing Animation */
        .typing-cursor {
            animation: blink 1s step-end infinite;
            display: inline-block;
            width: 3px;
            height: 1.2em;
            background-color: rgb(var(--text-tertiary));
            vertical-align: sub;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: rgb(var(--text-tertiary)); }
        }

        /* Additional UI Components */
.history-item-container:hover .history-item-actions { opacity: 1; }
.history-item-actions {
    opacity: 1;
    transition: opacity 0.2s ease-in-out;
}

/* --- 1. Advanced Glassmorphism Sidebar --- */
#sidebar {
    background-color: rgba(var(--bg-secondary), 0.85);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-right: 1px solid rgba(var(--border-primary), 0.3);
    transition: transform 0.3s ease-in-out;
    z-index: 50;
}

/* On large screens (lg:), remove the glass effect and return to a solid background */
@media (min-width: 1024px) {
    #sidebar {
        background-color: rgb(var(--bg-secondary));
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        border-right: 1px solid rgb(var(--border-primary));
    }
}

/* --- 2. Advanced History List Item Styling --- */
.history-item-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    border: 1.5px solid transparent;
}

.history-item-content {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
}

.history-item-icon {
    width: 16px;
    height: 16px;
    color: rgb(var(--text-tertiary));
    flex-shrink: 0;
    transition: color 0.2s;
}

/* Default state (non-medical chat, hide icon) */
.history-item-icon {
    display: none;
}

/* Show icon ONLY if it's a medical chat */
.history-item-wrapper[data-medical="true"] .history-item-icon {
    display: block;
    color: rgb(34, 197, 94);
}

.history-item-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: rgb(var(--text-secondary));
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.2s;
}

/* --- Hover & Active States --- */
.history-item-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, 
        transparent 0%,
        rgba(var(--bg-accent), 0.08) 50%,
        transparent 100%);
    transform: translateX(-100%);
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1;
}

.history-item-wrapper:hover::before {
    transform: translateX(100%);
}

.history-item-wrapper:hover {
    background-color: rgba(var(--bg-tertiary), 0.7);
}

.history-item-wrapper:hover .history-item-title {
    color: rgb(var(--text-primary));
}

.history-item-wrapper.active {
    background: rgba(var(--bg-accent), 0.15);
    border-color: rgba(var(--bg-accent), 0.3);
}

.history-item-wrapper.active .history-item-title {
    color: rgb(var(--text-accent));
    font-weight: 600;
}

.history-item-wrapper.active .history-item-icon {
    color: rgb(var(--text-accent));
}

.history-item-actions {
    opacity: 0;
    display: flex;
    gap: 4px;
    align-items: center;
    margin-right: 8px;
    transition: all 0.25s ease;
    z-index: 2;
}

.history-item-wrapper:hover .history-item-actions,
.history-item-wrapper.active .history-item-actions {
    opacity: 1;
}

/* --- 3. Collapsible History Sections Styling --- */
.history-group-summary {
    display: flex;
    align-items: center;
    padding: 8px 6px;
    margin-top: 8px;
    cursor: pointer;
    list-style: none;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgb(var(--text-tertiary));
    border-radius: 8px;
    transition: background-color 0.2s;
}

.history-group-summary:hover {
    background-color: rgba(var(--bg-tertiary), 0.5);
}

.history-group-summary::before {
    content: '';
    font-size: 0.6rem;
    margin-right: 8px;
    color: rgb(var(--text-quaternary));
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(1px);
}

.history-group[open] > .history-group-summary::before {
    transform: rotate(90deg) translateY(1px);
}

.history-group-summary::-webkit-details-marker {
    display: none;
}

.history-group[open] > ul {
    padding-left: 10px;
    border-left: 1.5px solid rgba(var(--border-primary), 0.5);
    margin-left: 10px;
}

.auth-container { background: rgb(var(--bg-primary)); }        .profile-dropdown, .export-dropdown {
            position: absolute;
            top: calc(100% + 0.75rem);
            right: 0;
            background: linear-gradient(135deg,
                rgba(var(--bg-primary), 0.98),
                rgba(var(--bg-secondary), 0.98));
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 
                      0 2px 8px rgba(0, 0, 0, 0.1), 
                      0 0 2px rgba(var(--bg-accent), 0.05);
            border: 1px solid rgba(var(--border-primary), 0.6);
            z-index: 100;
            display: none;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px) scale(0.98);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .profile-dropdown {
            width: 320px;
        }
        
        .export-dropdown {
            width: 200px;
        }

        .profile-dropdown.show, .export-dropdown.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }
        
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes likeAnimation {
            0% { transform: scale(1); }
            30% { transform: scale(1.3) rotate(10deg); }
            50% { transform: scale(0.9) rotate(-5deg); }
            70% { transform: scale(1.1) rotate(3deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        @keyframes dislikeAnimation {
            0% { transform: scale(1); }
            30% { transform: scale(1.3) rotate(-10deg); }
            50% { transform: scale(0.9) rotate(5deg); }
            70% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }

        @keyframes rippleEffect {
            0% { transform: scale(0.8); opacity: 0; }
            50% { opacity: 0.3; }
            100% { transform: scale(2); opacity: 0; }
        }

        @keyframes iconPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
        
        .profile-dropdown .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0.75rem 1rem;
            margin: 0.375rem;
            border-radius: 0.75rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-weight: 500;
        }
        
        .profile-dropdown .dropdown-item::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg,
                rgba(var(--bg-accent), 0) 0%,
                rgba(var(--bg-accent), 0.1) 50%,
                rgba(var(--bg-accent), 0) 100%);
            transform: translateX(-100%);
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        
        .profile-dropdown .dropdown-item:hover::before {
            transform: translateX(100%);
        }
        
        .profile-dropdown .dropdown-item:active {
            transform: scale(0.98);
        }
        
        #dropdown-avatar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }
        
        #dropdown-avatar:hover {
            transform: scale(1.05) rotate(3deg);
            box-shadow: 0 0 20px rgba(var(--bg-accent), 0.2);
            border-color: rgba(var(--bg-accent), 0.3);
        }
        .profile-dropdown.show, .export-dropdown.show { 
            display: block;
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            animation: dropdownEntrance 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes dropdownEntrance {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            margin: 0.25rem;
            font-size: 0.875rem;
            color: rgb(var(--text-secondary));
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .dropdown-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                transparent,
                rgba(var(--bg-accent), 0.1),
                transparent
            );
            transform: translateX(-100%);
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dropdown-item:hover {
            background-color: rgba(var(--bg-tertiary), 0.5);
            color: rgb(var(--text-primary));
            transform: translateX(4px);
        }
        .dropdown-item:hover::before {
            transform: translateX(100%);
        }
        .dropdown-item svg {
            width: 18px;
            height: 18px;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }
        .dropdown-item:hover svg {
            transform: scale(1.1) rotate(5deg);
            color: rgb(var(--text-accent));
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: rgb(var(--text-quaternary));
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid rgb(var(--border-primary));
        }
        .divider:not(:empty)::before { margin-right: .25em; }
        .divider:not(:empty)::after { margin-left: .25em; }

        #password-strength-bar {
            height: 5px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }

        .chat-message {
            position: relative;
            padding-bottom: 0.5rem;
            animation: message-slide-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes message-slide-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* AI Message Container - ENHANCED */
        .chat-message:not(.user) {
            margin-bottom: 1.5rem;
        }
        
        .chat-message:not(.user) .message-content {
            background: linear-gradient(135deg, 
                rgba(var(--bg-secondary), 0.6) 0%, 
                rgba(var(--bg-tertiary), 0.4) 100%);
            border: 1px solid rgba(var(--border-primary), 0.3);
            border-radius: 1.25rem;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            position: relative;
            overflow: hidden;
        }
        
        .chat-message:not(.user) .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                rgb(var(--bg-accent)), 
                transparent);
            opacity: 0.5;
        }
        
        /* User Message Container - DISTINCT */
        .chat-message.user .message-content {
            background: linear-gradient(135deg, 
                rgb(var(--text-accent)), 
                rgba(var(--text-accent), 0.9));
            border: none;
            border-radius: 1.25rem;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 6px 20px rgba(var(--text-accent), 0.25);
            color: rgb(var(--text-inverse));
            margin-left: auto;
            margin-right: 0;
        }
        
        /* Make message bubbles transparent across all themes EXCEPT user messages */
        .chat-message:not(.user) > .rounded-lg,
        .chat-message:not(.user) .rounded-lg,
        .chat-message:not(.user) > div[class*="bg-"],
        .chat-message:not(.user) [class*="bg-theme-"] {
            background: transparent !important;
            background-color: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* Ensure user message bubbles keep a visible background and subtle shadow */
        .chat-message.user > .rounded-lg,
        .chat-message.user .rounded-lg {
            background: var(--bg-accent, rgba(99,102,241,1)) !important;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18) !important;
            border: 1px solid rgba(0,0,0,0.06) !important;
        }
        
        /* Message content prose styling */
        .chat-message:not(.user) .prose {
            font-size: 1rem;
        }
        
        .chat-message.user .prose {
            color: rgb(var(--text-inverse));
        }
        
        .chat-message.user .prose strong {
            color: rgba(255, 255, 255, 0.95);
        }
        
        .chat-message.user .prose a {
            color: rgba(255, 255, 255, 0.9);
            border-bottom-color: rgba(255, 255, 255, 0.6);
        }
        
        /* User message code blocks */
        .chat-message.user .prose code {
            background-color: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.95);
            border-color: rgba(0, 0, 0, 0.3);
        }
        
        .chat-message.user .prose pre {
            background: rgba(0, 0, 0, 0.25);
            border-color: rgba(0, 0, 0, 0.3);
        }
        
        .chat-message.user .prose pre code {
            color: rgba(255, 255, 255, 0.95);
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            position: static;
            margin-top: 1.25rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(var(--border-primary), 0.2);
            opacity: 1;
            transition: opacity 0.25s ease-in-out;
            justify-content: flex-start;
            align-items: center;
        }
        
        .chat-message.user .action-buttons { 
            justify-content: flex-end;
        }
        
        .action-buttons button, .action-buttons a {
            background-color: transparent;
            color: rgb(var(--text-secondary));
            border: 1.5px solid rgba(var(--border-primary), 0.4);
            padding: 0.6rem 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            position: relative;
            border-radius: 0.75rem;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        
        .action-buttons button::before, .action-buttons a::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(var(--bg-accent), 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .action-buttons button:hover, .action-buttons a:hover {
            color: rgb(var(--text-primary));
            border-color: rgba(var(--bg-accent), 0.4);
            background-color: rgba(var(--bg-accent), 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(var(--bg-accent), 0.1);
        }
        
        .action-buttons button:hover::before, .action-buttons a:hover::before {
            transform: translateX(100%);
        }
        
        .action-buttons button:active, .action-buttons a:active {
            transform: translateY(0);
        }
        
        .action-buttons button svg, .action-buttons a svg {
            width: 18px;
            height: 18px;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }
        
        .action-buttons button:hover svg, .action-buttons a:hover svg {
            transform: scale(1.15) rotate(3deg);
        }

        /* Response Action Button Variants */
        .action-buttons .copy-btn {
            border-color: rgba(34, 197, 94, 0.3);
            color: rgb(34, 197, 94);
        }
        
        .action-buttons .copy-btn:hover {
            background-color: rgba(34, 197, 94, 0.08);
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
        }
        
        .action-buttons .regenerate-btn {
            border-color: rgba(59, 130, 246, 0.3);
            color: rgb(59, 130, 246);
        }
        
        .action-buttons .regenerate-btn:hover {
            background-color: rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .action-buttons .share-btn {
            border-color: rgba(139, 92, 246, 0.3);
            color: rgb(139, 92, 246);
        }
        
        .action-buttons .share-btn:hover {
            background-color: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }
        
        .action-buttons .pin-btn {
            border-color: rgba(245, 158, 11, 0.3);
            color: rgb(245, 158, 11);
        }
        
        .action-buttons .pin-btn:hover {
            background-color: rgba(245, 158, 11, 0.08);
            border-color: rgba(245, 158, 11, 0.5);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
        }
        
        /* Like and Dislike Buttons - Enhanced */
        .like-btn, .dislike-btn {
            position: relative;
            transition: transform 0.25s ease, color 0.25s ease;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            border: 1.5px solid rgba(var(--border-primary), 0.3);
            background-color: transparent;
            cursor: pointer;
            padding: 0;
        }

        .like-btn svg, .dislike-btn svg {
            width: 20px;
            height: 20px;
            transition: all 0.3s ease;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
        }

        .like-btn.active svg {
            animation: likeAnimation 0.5s ease-out;
            fill: rgb(34, 197, 94);
            stroke: rgb(34, 197, 94);
        }

        .dislike-btn.active svg {
            animation: dislikeAnimation 0.5s ease-out;
            fill: rgb(239, 68, 68);
            stroke: rgb(239, 68, 68);
        }
        
        .like-btn.active::after, .dislike-btn.active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            pointer-events: none;
            animation: rippleEffect 0.6s ease-out;
        }

        .like-btn.active::after {
            background: rgba(34, 197, 94, 0.2);
        }

        .dislike-btn.active::after {
            background: rgba(239, 68, 68, 0.2);
        }

        .like-btn:hover {
            color: rgb(34, 197, 94);
            border-color: rgba(34, 197, 94, 0.4);
            background-color: rgba(34, 197, 94, 0.05);
            transform: scale(1.05);
        }

        .dislike-btn:hover {
            color: rgb(239, 68, 68);
            border-color: rgba(239, 68, 68, 0.4);
            background-color: rgba(239, 68, 68, 0.05);
            transform: scale(1.05);
        }

        .like-btn.active svg {
            filter: drop-shadow(0 0 2px rgba(34, 197, 94, 0.3));
            animation: iconPop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dislike-btn.active svg {
            filter: drop-shadow(0 0 2px rgba(239, 68, 68, 0.3));
            animation: iconPop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-message:hover .action-buttons {
            opacity: 1;
        }
        
        /* Copy feedback animation - ENHANCED */
        .copy-feedback {
            position: absolute;
            background: linear-gradient(135deg, rgb(34, 197, 94), rgb(22, 163, 74));
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            white-space: nowrap;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.25);
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        
        .copy-feedback.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .action-buttons .active-like {
            background-color: rgba(34, 197, 94, 0.1);
            color: rgb(34, 197, 94);
            border-color: rgba(34, 197, 94, 0.4);
        }
        
        .action-buttons .active-dislike {
            background-color: rgba(239, 68, 68, 0.1);
            color: rgb(239, 68, 68);
            border-color: rgba(239, 68, 68, 0.4);
        }
        
        .action-buttons .interactive-btn {
            width: auto;
            padding: 0.6rem 1rem;
        }
         
        .action-buttons .interactive-btn span {
            font-size: 0.85rem;
            line-height: 1rem;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        /* TTS Button Styles */
        .action-buttons .tts-button {
            position: relative;
            border-color: rgba(6, 182, 212, 0.3);
            color: rgb(6, 182, 212);
        }
        
        .action-buttons .tts-button:hover {
            background-color: rgba(6, 182, 212, 0.08);
            border-color: rgba(6, 182, 212, 0.5);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.15);
        }
        
        .action-buttons .tts-button.speaking {
            background-color: rgba(6, 182, 212, 0.15);
            color: rgb(6, 182, 212);
            border-color: rgba(6, 182, 212, 0.5);
        }
        
        .action-buttons .tts-button.speaking::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid rgb(6, 182, 212);
            border-radius: 0.5rem;
            animation: pulse-ring 1.5s infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.1);
                opacity: 0;
            }
        }

        .sidebar-overlay {
            z-index: 40;
        }

        .welcome-card {
            background: linear-gradient(135deg, rgb(var(--bg-secondary)) 0%, rgb(var(--bg-tertiary)) 100%);
            border: 1px solid rgb(var(--border-secondary));
        }

        .feature-card {
            background: rgba(var(--bg-tertiary), 0.5);
            border: 1px solid rgb(var(--border-primary));
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            background: rgba(var(--bg-tertiary), 0.8);
            border-color: rgb(var(--border-secondary));
            transform: translateY(-2px);
        }
        
        .suggestion-card {
            background-color: rgba(var(--bg-tertiary), 0.5);
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            text-align: left;
            width: 100%;
        }
        .suggestion-card:hover {
            background-color: rgba(var(--bg-tertiary), 0.8);
            border-color: rgb(var(--border-secondary));
            transform: translateY(-2px);
        }

        .help-tooltip {
            position: relative;
        }
        .help-tooltip:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }
        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgb(var(--bg-secondary));
            color: rgb(var(--text-primary));
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            border: 1px solid rgb(var(--border-primary));
        }

        /* Scroll to Bottom Button */
        .scroll-to-bottom-btn {
            position: fixed;
            bottom: 150px;
            right: 2rem;
            width: 48px;
            height: 48px;
            background-color: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
            border: none;
            border-radius: 50%;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
        }

        .scroll-to-bottom-btn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .scroll-to-bottom-btn:hover {
            background-color: rgb(var(--bg-accent-hover));
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -3px rgba(0, 0, 0, 0.15), 0 6px 8px -2px rgba(0, 0, 0, 0.1);
        }

        .scroll-to-bottom-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .scroll-to-bottom-btn {
                right: 1rem;
                bottom: 120px;
                width: 44px;
                height: 44px;
            }
        }

        @media (max-width: 1023px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            padding: 1rem;
            color: rgb(var(--text-primary));
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            border-color: rgb(var(--text-success));
        }
        .notification.error {
            border-color: rgb(var(--text-error));
        }
        
        /* Multimedia upload */
        #file-preview-container {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: none;
            position: relative;
            background: rgb(var(--bg-tertiary));
            border-radius: 0.5rem;
            /* allow horizontal scrolling for many attachments */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Preview list layout: side-by-side, wrap when needed */
        #file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: flex-start;
        }
        #file-preview .relative {
            flex: 0 0 auto; /* prevent stretching */
            overflow: visible; /* allow the remove button to sit outside thumbnail bounds */
        }
        /* Per-file remove button styling to avoid clipping and improve hit target */
        #file-preview button[data-file-id] {
            position: absolute;
            top: 6px;
            right: 6px;
            z-index: 40;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            background: #ff5f5f; /* visible red fallback */
            color: #ffffff;
            border: 2px solid rgba(0,0,0,0.12);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        #file-preview button[data-file-id] svg { width: 12px; height: 12px; }
        #file-preview-container img, #file-preview-container video {
            max-height: 100px;
            border-radius: 0.25rem;
            display: block;
        }
        #file-preview-container audio {
            width: 100%;
        }
        #remove-file-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background: rgb(var(--bg-error));
            color: rgb(var(--text-inverse));
            border-radius: 9999px;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgb(var(--bg-secondary));
        }

        /* JSON Explorer Styles */
        .json-formatter { font-family: 'Fira Code', monospace; white-space: pre-wrap; font-size: 0.9rem; }
        .json-formatter .string { color: rgb(var(--text-accent)); }
        .json-formatter .number { color: rgb(var(--text-warning)); }
        .json-formatter .boolean { color: rgb(var(--text-error)); }
        .json-formatter .null { color: rgb(var(--text-quaternary)); }
        .json-formatter .key { color: rgb(var(--text-accent)); }
        .json-formatter details { padding-left: 1.5rem; border-left: 1px solid rgb(var(--border-secondary)); }
        .json-formatter summary { cursor: pointer; list-style: none; }
        .json-formatter summary::-webkit-details-marker { display: none; }
        .json-formatter summary::before {
            content: '';
            margin-right: 0.5rem;
            display: inline-block;
            transition: transform 0.1s;
        }
        .json-formatter details[open] > summary::before {
            transform: rotate(90deg);
        }

        /* Enhanced Code Visualizer Styles with Monaco Editor */
        #code-visualizer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 1rem;
            height: 100%;
            padding: 1rem;
            font-family: 'Fira Code', monospace;
        }
        
        #monaco-editor-container {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }
        
        #editor-toolbar {
            background: rgb(var(--bg-secondary));
            border-bottom: 1px solid rgb(var(--border-primary));
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 1rem;
        }
        
        #monaco-editor {
            height: calc(100% - 50px);
        }
        
        #visualizer-explanation-pane {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: rgb(var(--text-secondary));
        }
        #visualizer-state-pane {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-y: auto;
        }
        #visualizer-state-pane h4 {
            font-weight: bold;
            color: rgb(var(--text-tertiary));
            margin-bottom: 0.5rem;
        }
        #visualizer-state-pane .variable {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        #visualizer-state-pane .var-name {
            color: rgb(var(--text-accent));
        }
        #visualizer-state-pane .var-value {
            color: rgb(var(--text-accent));
        }

        /* Edit message styles */
        .edit-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            background-color: rgb(var(--bg-primary));
            color: rgb(var(--text-primary));
            font-family: inherit;
            font-size: 0.875rem;
            line-height: 1.25rem;
            resize: vertical;
            min-height: 80px;
        }
        .edit-textarea:focus {
            outline: none;
            border-color: rgb(var(--border-accent));
            box-shadow: 0 0 0 2px rgba(var(--bg-accent), 0.1);
        }
        .edit-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            justify-content: flex-end;
        }
        .edit-buttons button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .edit-save-btn {
            background-color: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
            border: none;
        }
        .edit-save-btn:hover {
            background-color: rgb(var(--bg-accent-hover));
        }
        .edit-cancel-btn {
            background-color: rgb(var(--bg-tertiary));
            color: rgb(var(--text-secondary));
            border: 1px solid rgb(var(--border-primary));
        }
        .edit-cancel-btn:hover {
            background-color: rgb(var(--bg-quaternary));
        }

        /* Monaco Editor Theme Styles */
        .monaco-editor-toolbar-btn {
            background: rgb(var(--bg-tertiary));
            color: rgb(var(--text-secondary));
            border: 1px solid rgb(var(--border-primary));
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .monaco-editor-toolbar-btn:hover {
            background: rgb(var(--bg-quaternary));
            color: rgb(var(--text-primary));
        }
        .monaco-editor-toolbar-btn.active {
            background: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
            border-color: rgb(var(--border-accent));
        }

        /* Output panel styles */
        #output-panel {
            background: rgb(var(--bg-primary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .output-line {
            margin-bottom: 0.25rem;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        
        .output-line.error {
            background: rgba(var(--bg-error), 0.1);
            color: rgb(var(--text-error));
        }
        
        .output-line.success {
            color: rgb(var(--text-success));
        }

        /* Prompt Library Styles */
        #prompt-tag-filter-bar {
            gap: 0.5rem;
        }
        .prompt-card {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgba(var(--border-primary), 0.6);
            border-radius: 1rem;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            box-shadow: 0 8px 20px -12px rgba(15, 23, 42, 0.5);
        }
        .prompt-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 30px -20px rgba(15, 23, 42, 0.8);
        }
        .prompt-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
        }
        .prompt-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: rgb(var(--text-primary));
            margin-bottom: 0.1rem;
        }
        .prom  pt-card-meta {
            font-size: 0.8rem;
            color: rgb(var(--text-quaternary));
        }
        .prompt-card-preview {
            font-size: 0.95rem;
            color: rgb(var(--text-secondary));
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .prompt-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.75rem;
        }
        .prompt-chip {
            padding: 0.15rem 0.6rem;
            border-radius: 999px;
            font-size: 0.7rem;
            background: rgba(var(--bg-accent), 0.1);
            border: 1px solid rgba(var(--border-primary), 0.6);
            color: rgb(var(--text-secondary));
        }
        .prompt-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .prompt-card-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: rgb(var(--text-quaternary));
        }
        .prompt-card-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .prompt-quick-btn {
            border-radius: 999px;
            padding: 0.35rem 0.9rem;
            font-size: 0.8rem;
            border: 1px solid transparent;
            transition: all 0.25s ease;
        }
        .prompt-quick-btn.use {
            background: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
        }
        .prompt-quick-btn.secondary {
            background: transparent;
            color: rgb(var(--text-secondary));
            border-color: rgba(var(--border-primary), 0.5);
        }
        .prompt-favorite-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(var(--bg-quaternary), 0.8);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }
        .prompt-favorite-btn.active {
            background: linear-gradient(135deg, #f97316, #facc15);
            color: rgb(var(--text-inverse));
        }

        /* History Filter & Quick Access */
        .history-filter-bar {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
        }
        .history-filter-btn {
            padding: 0.45rem 1rem;
            border-radius: 999px;
            border: 1.5px solid rgba(var(--border-secondary), 0.4);
            background: rgba(var(--bg-secondary), 0.6);
            color: rgb(var(--text-tertiary));
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .history-filter-btn:hover {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(0, 0, 0, 0.5);
            color: rgb(255, 255, 255);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transform: translateY(-1px);
        }
        .history-filter-btn.active {
            border-color: rgba(0, 0, 0, 0.3);
            background: rgba(0, 0, 0, 0.3);
            color: rgb(255, 255, 255);
            box-shadow: 0 4px 12px rgba(var(--bg-accent), 0.25);
            font-weight: 700;
        }
        .history-quick-access {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .history-quick-item {
            padding: 0.65rem 0.9rem;
            border-radius: 0.875rem;
            background: rgba(var(--bg-secondary), 0.5);
            border: 1.5px solid rgba(var(--border-secondary), 0.4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .history-quick-item:hover {
            background: rgba(var(--bg-accent), 0.12);
            border-color: rgba(var(--bg-accent), 0.5);
            box-shadow: 0 4px 12px rgba(var(--bg-accent), 0.2);
            transform: translateX(2px);
        }
        .history-quick-item-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgb(var(--text-secondary));
        }
        .history-quick-item-meta {
            font-size: 0.7rem;
            color: rgb(var(--text-tertiary));
        }
        .pin-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(var(--bg-secondary), 0.8);
            cursor: pointer;
            transition: background 0.2s ease, border 0.2s ease;
        }
        .pin-btn.active {
            border-color: rgba(var(--bg-accent), 0.6);
            background: rgba(var(--bg-accent), 0.4);
            color: rgb(var(--text-primary));
        }
        .pin-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Scheduler Styles */
        .schedule-bulk-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .schedule-bulk-controls button {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            border: 1px solid rgba(var(--border-primary), 0.5);
            background: rgba(var(--bg-secondary), 0.9);
            color: rgb(var(--text-secondary));
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .schedule-bulk-controls button.primary {
            background: linear-gradient(135deg, rgb(var(--bg-accent)), rgba(var(--bg-accent-hover), 0.9));
            color: rgb(var(--text-inverse));
            border-color: transparent;
        }
        .schedule-timeline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .timeline-card {
            padding: 0.9rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(var(--border-primary), 0.4);
            background: rgb(var(--bg-secondary));
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            font-size: 0.8rem;
        }
        .timeline-card.is-next {
            border-color: rgba(var(--bg-success), 0.8);
            box-shadow: 0 0 0 1px rgba(var(--bg-success), 0.4);
        }
        .timeline-card h4 {
            font-size: 0.9rem;
            margin: 0;
            color: rgb(var(--text-primary));
        }
        .timeline-card .timeline-meta {
            color: rgb(var(--text-tertiary));
        }

        /* Analytics Panel */
        .analytics-panel {
            width: 280px;
            border-left: 1px solid rgba(var(--border-primary), 0.4);
            background: rgba(var(--bg-secondary), 0.9);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 0.75rem;
        }
        .analytics-panel h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: rgb(var(--text-primary));
            margin: 0;
        }
        .analytics-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
        }
        .analytics-stat {
            padding: 0.75rem;
            border-radius: 0.75rem;
            background: rgba(var(--bg-primary), 0.6);
            border: 1px solid rgba(var(--border-primary), 0.4);
            font-size: 0.75rem;
        }
        .analytics-stat strong {
            display: block;
            margin-top: 0.35rem;
            font-size: 1.1rem;
            color: rgb(var(--text-accent));
        }
        .analytics-last-chart {
            border-radius: 1rem;
            border: 1px dashed rgba(var(--border-primary), 0.5);
            padding: 0.75rem;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 0.5rem;
        }
        .analytics-last-chart p {
            margin: 0;
            color: rgb(var(--text-secondary));
            font-size: 0.8rem;
        }
        .analytics-pin-btn {
            align-self: flex-start;
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            border: 1px solid rgba(var(--border-primary), 0.4);
            background: transparent;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .analytics-widget-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.75rem;
        }
        .analytics-widget {
            border-radius: 0.75rem;
            border: 1px solid rgba(var(--border-primary), 0.4);
            padding: 0.75rem;
            background: rgba(var(--bg-primary), 0.4);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 110px;
        }
        .analytics-widget h4 {
            margin: 0;
            font-size: 0.85rem;
            color: rgb(var(--text-tertiary));
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .analytics-progress-track {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: rgba(var(--border-primary), 0.2);
            overflow: hidden;
        }
        .analytics-progress-fill {
            height: 100%;
            background: linear-gradient(120deg, rgb(var(--bg-accent)), rgb(var(--bg-success)));
            transition: width 0.3s ease;
        }
        .analytics-widget-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: rgb(var(--text-primary));
        }
        .sources-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.75rem;
        }
        .sources-list a {
            color: rgb(var(--text-accent));
            text-decoration: underline;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .followup-suggestions {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .followup-suggestions button {
            width: 100%;
            border: 1px solid rgba(var(--border-primary), 0.5);
            background: rgba(var(--bg-secondary), 0.7);
            border-radius: 999px;
            padding: 0.3rem 0.65rem;
            font-size: 0.75rem;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .followup-suggestions button:hover {
            background: rgba(var(--bg-accent), 0.3);
        }

        /* TTS / Voice Queue */
        .tts-settings {
            border-top: 1px solid rgba(var(--border-primary), 0.3);
            padding-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .tts-settings label {
            font-size: 0.85rem;
            color: rgb(var(--text-tertiary));
            display: block;
            margin-bottom: 0.25rem;
        }
        .tts-preview-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .voice-queue {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            max-height: 160px;
            overflow-y: auto;
        }
        .voice-queue-item {
            padding: 0.45rem 0.65rem;
            border-radius: 0.5rem;
            background: rgba(var(--bg-tertiary), 0.6);
            border: 1px solid rgba(var(--border-primary), 0.4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }
        .voice-queue-item button {
            border: none;
            background: transparent;
            color: rgb(var(--text-secondary));
            cursor: pointer;
        }

        /* Profile Settings Styles */
        .settings-section {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgb(var(--border-primary));
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .toggle-switch {
            position: relative;
            width: 3rem;
            height: 1.5rem;
            background: rgb(var(--bg-quaternary));
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .toggle-switch.active {
            background: rgb(var(--bg-accent));
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 1.25rem;
            height: 1.25rem;
            background: rgb(var(--bg-primary));
            border-radius: 50%;
            top: 0.125rem;
            left: 0.125rem;
            transition: transform 0.2s;
        }
        
        .toggle-switch.active::after {
            transform: translateX(1.5rem);
        }
        
        .avatar-upload {
            position: relative;
            width: 5rem;
            height: 5rem;
            border-radius: 50%;
            background: rgb(var(--bg-tertiary));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px dashed rgb(var(--border-primary));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        .avatar-upload:hover {
            border-color: rgb(var(--border-accent));
            background: rgb(var(--bg-quaternary));
            box-shadow: 0 0 20px rgba(var(--bg-accent), 0.2);
        }
        
        .avatar-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .avatar-upload:hover img {
            transform: scale(1.1);
        }
        
        .avatar-upload .upload-overlay {
            position: absolute;
            inset: 0;
            background: rgba(var(--bg-primary), 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .avatar-upload:hover .upload-overlay {
            opacity: 1;
        }
        
        .avatar-upload .upload-icon {
            color: rgb(var(--text-inverse));
            transform: translateY(10px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .avatar-upload:hover .upload-icon {
            transform: translateY(0);
        }

        .avatar-upload[data-loading="true"] {
            pointer-events: none;
            opacity: 0.7;
        }

        #avatar-loading {
            backdrop-filter: blur(4px);
        }

        #upload-avatar-btn[data-loading="true"] {
            pointer-events: none;
            opacity: 0.7;
        }

        #upload-avatar-btn[data-loading="true"] svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .avatar-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .avatar-preview.loading {
            filter: blur(2px);
            opacity: 0.5;
        }

        #upload-error {
            animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-3px); }
            40%, 60% { transform: translateX(3px); }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal-content {
            background: rgb(var(--bg-primary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            max-width: 32rem;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgb(var(--border-primary));
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid rgb(var(--border-primary));
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            border: none;
        }
        
        .btn-primary {
            background: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
        }
        
        .btn-primary:hover {
            background: rgb(var(--bg-accent-hover));
        }
        
        .btn-secondary {
            background: rgb(var(--bg-tertiary));
            color: rgb(var(--text-secondary));
            border: 1px solid rgb(var(--border-primary));
        }
        
        .btn-secondary:hover {
            background: rgb(var(--bg-quaternary));
            color: rgb(var(--text-primary));
        }
        
        .btn-success {
            background: rgb(var(--bg-success));
            color: rgb(var(--text-inverse));
        }
        
        .btn-error {
            background: rgb(var(--bg-error));
            color: rgb(var(--text-inverse));
        }
        
        .btn-warning {
            background: rgb(var(--bg-warning));
            color: rgb(var(--text-inverse));
        }
        
        /* Input Styles */
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.375rem;
            background: rgb(var(--bg-tertiary));
            color: rgb(var(--text-primary));
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: rgb(var(--border-accent));
            box-shadow: 0 0 0 2px rgba(var(--bg-accent), 0.1);
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: rgb(var(--text-secondary));
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .inline-flex { display: inline-flex; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .rounded { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow { box-shadow: var(--shadow); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        
        /* Mobile responsiveness for code visualizer */
        @media (max-width: 768px) {
            #code-visualizer-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            
            #monaco-editor-container {
                grid-column: 1;
                grid-row: 1;
                min-height: 300px;
            }
            
            #visualizer-explanation-pane {
                grid-column: 1;
                grid-row: 2;
            }
            
            #visualizer-state-pane {
                grid-column: 1;
                grid-row: 3;
                max-height: 200px;
            }
            
            #editor-toolbar {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            #editor-toolbar > div {
                justify-content: center;
            }
            
            .modal-content {
                max-width: 95vw;
                margin: 0.5rem;
            }

            /* Mobile button adjustments */
            .edit-btn, .delete-btn, 
            button[title="Edit message"], button[onclick*="editPrompt"], button[onclick*="editScheduledTask"], 
            button[onclick*="deletePrompt"], button[onclick*="deleteScheduledTask"],
            .history-item-actions button {
                width: 32px;
                height: 32px;
                padding: 6px;
            }

            .edit-btn svg, .delete-btn svg,
            button[title="Edit message"] svg, button[onclick*="editPrompt"] svg, button[onclick*="editScheduledTask"] svg,
            button[onclick*="deletePrompt"] svg, button[onclick*="deleteScheduledTask"] svg,
            .history-item-actions button svg {
                width: 16px;
                height: 16px;
            }
        }

        /* Photo upload progress styles */
        .upload-progress {
            position: relative;
            background: rgb(var(--bg-tertiary));
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin: 1rem 0;
            border: 1px solid rgb(var(--border-primary));
        }

        .upload-progress-bar {
            height: 6px;
            background: rgba(var(--bg-quaternary), 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.75rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, 
                rgb(var(--bg-accent)) 0%, 
                rgba(var(--bg-accent), 0.8) 100%);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(var(--bg-accent), 0.3);
            position: relative;
        }
        
        .upload-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.2) 50%,
                transparent 100%
            );
            animation: progressShimmer 1.5s infinite;
        }
        
        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* --- Skeleton Loader Styles --- */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .animate-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        .skeleton-message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem; /* 12px */
            margin-bottom: 1.5rem; /* 24px */
        }

        .skeleton-avatar {
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border-radius: 9999px; /* full */
            background-color: rgb(var(--bg-tertiary));
            flex-shrink: 0;
        }

        .skeleton-bubble {
            flex: 1;
            padding: 1rem; /* 16px */
            border-radius: 0.5rem; /* 8px */
            background-color: rgb(var(--bg-tertiary));
        }

        .skeleton-line {
            height: 0.75rem; /* 12px */
            border-radius: 0.25rem; /* 4px */
            background-color: rgb(var(--bg-quaternary));
        }

        .skeleton-message.user { justify-content: flex-end; }

        /* --- Visual Empty State Styles --- */
        .empty-state-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem; /* 40px */
            text-align: center;
            border: 2px dashed rgb(var(--border-primary));
            border-radius: 0.75rem; /* 12px */
            background: rgba(var(--bg-tertiary), 0.3);
            margin: 1rem 0;
        }

        .empty-state-animation {
            width: 150px;
            height: 150px;
            opacity: 0.7;
        }

        .empty-state-title {
            font-size: 1.125rem; /* 18px */
            font-weight: 600;
            color: rgb(var(--text-primary));
            margin-top: 1rem; /* 16px */
        }

        .empty-state-text {
            font-size: 0.875rem; /* 14px */
            color: rgb(var(--text-secondary));
            margin-top: 0.5rem; /* 8px */
            margin-bottom: 1.5rem; /* 24px */
            max-width: 300px;
        }

        /* --- PROMPT LIBRARY & SCHEDULER ENHANCEMENTS STYLES --- */

        /* Tag Chip Styles */
        .tag-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 9999px; /* Full rounded */
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .tag-chip:hover { transform: translateY(-1px); opacity: 0.9; }
        .tag-code { background-color: rgba(34, 197, 94, 0.15); color: rgb(var(--text-success)); border-color: rgba(34, 197, 94, 0.3); }
        .tag-drafting { background-color: rgba(59, 130, 246, 0.15); color: rgb(59, 130, 246); border-color: rgba(59, 130, 246, 0.3); }
        .tag-medical { background-color: rgba(239, 68, 68, 0.15); color: rgb(var(--text-error)); border-color: rgba(239, 68, 68, 0.3); }
        .tag-marketing { background-color: rgba(245, 158, 11, 0.15); color: rgb(var(--text-warning)); border-color: rgba(245, 158, 11, 0.3); }
        .tag-data { background-color: rgba(139, 92, 246, 0.15); color: rgb(139, 92, 246); border-color: rgba(139, 92, 246, 0.3); }
        .tag-other { background-color: rgba(100, 116, 139, 0.15); color: rgb(var(--text-tertiary)); border-color: rgba(100, 116, 139, 0.3); }
        .tag-chip.active { font-weight: 600; opacity: 1; box-shadow: 0 0 0 2px rgba(var(--bg-accent), 0.5); transform: none; }

        /* Prompt Card Truncation with Fade */
        .prompt-content-fade { position: relative; max-height: 5rem; overflow: hidden; margin-top: 0.5rem; }
        .prompt-content-fade::after {
            content: '';
            position: absolute; bottom: 0; left: 0; right: 0; height: 1.5rem;
            background: linear-gradient(to top, rgb(var(--bg-secondary)) 20%, rgba(var(--bg-secondary), 0) 100%);
            pointer-events: none;
        }

        /* Scheduler Toggle Switch */
        .task-toggle { width: 44px; height: 24px; border-radius: 9999px; background-color: rgb(var(--bg-tertiary)); border: 2px solid rgb(var(--border-primary)); position: relative; cursor: pointer; transition: all 0.3s ease; }
        .task-toggle.active { background-color: rgb(34, 197, 94); border-color: rgb(34, 197, 94); }
        .task-toggle-circle { width: 16px; height: 16px; background-color: rgb(var(--bg-primary)); border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); }
        .task-toggle.active .task-toggle-circle { transform: translateX(20px); background-color: white; }

        /* Scheduler Frequency Tabs */
        .frequency-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid rgb(var(--border-primary)); }
        .frequency-tab { padding: 0.5rem 1rem; font-weight: 500; color: rgb(var(--text-tertiary)); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s; }
        .frequency-tab.active { color: rgb(var(--text-primary)); border-bottom-color: rgb(var(--bg-accent)); font-weight: 600; }

        /* --- Override History Group Icon (fix mojibake and add chevron) --- */
        .history-group-summary::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 8px;
            background-color: rgb(var(--text-quaternary));
            -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>') no-repeat center / contain;
                    mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>') no-repeat center / contain;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(1px);
        }
    </style>
</head>
<body class="bg-theme-primary text-theme-primary h-full overflow-hidden">
    <!-- Signup Success Animation Overlay -->
    <div id="signup-success-overlay" class="signup-success-overlay">
        <div class="signup-success-content">
            <h1 class="signup-success-title">Welcome to Chat@AI! </h1>
            <p class="signup-success-subtitle">Your account has been created successfully.</p>
            <div class="signup-success-animation">
                <dotlottie-wc 
                    src="https://lottie.host/e33c9b60-a8b0-4d61-9e90-6da8fdfde230/6JacbVbFJz.lottie" 
                    style="width: 300px; height: 300px;" 
                    speed="1" 
                    autoplay 
                    loop>
                </dotlottie-wc>
            </div>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification hidden">
        <div class="flex items-center gap-2">
            <div id="notification-icon"></div>
            <span id="notification-text"></span>
        </div>
    </div>
        <!-- Dropzone Overlay for Drag & Drop -->
        <div id="dropzone-overlay" class="fixed inset-0 z-50 bg-theme-primary-alpha-90 text-theme-inverse pointer-events-none flex flex-col items-center justify-center opacity-0 transition-opacity duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mb-4 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            <p class="text-3xl font-bold tracking-wider">Drop Your Files Here</p>
            <p class="text-lg">Images, audio, video, or documents accepted.</p>
        </div>
    <!-- Scroll to Bottom Button -->
    <button id="scroll-to-bottom-btn" class="scroll-to-bottom-btn" title="Scroll to bottom">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7 13l3 3 3-3"/>
            <path d="M7 6l3 3 3-3"/>
        </svg>
    </button>

    <!-- Auth Page -->
    <div id="auth-page" class="w-full h-full flex items-center justify-center auth-container p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-6 sm:mb-8">
                <div class="flex justify-center mb-4">
                    <div class="w-16 h-16 bg-theme-accent rounded-full flex items-center justify-center shadow-lg">
                        <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-16 h-16 rounded-full shadow-lg"/>
                    </div>
                </div>
                                <h1 class="text-4xl sm:text-5xl font-extrabold mb-2 toy-heading">
                                    <span style="font-family: 'Comic Sans MS', 'Baloo 2', 'Fredoka One', cursive; letter-spacing: 2px; background: linear-gradient(90deg, #FFB347 0%, #FF69B4 40%, #00CFFF 80%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 2px 2px 0 #fff, 4px 4px 0 #ffb347, 6px 6px 0 #00cfff;">
                                        Chat@AI
                                    </span>
                                </h1>
                <p class="text-theme-quaternary text-sm sm:text-base">Your intelligent AI-chat companion with advanced features.</p>
                <div class="mt-4 text-xs text-theme-quaternary">
                    <ul class="flex flex-wrap gap-3 justify-center">
                        <li> Advanced AI conversations</li>
                        <li> Secure authentication</li>
                        <li> Chat history</li>
                        <li> Medical AI assistant</li>
                    </ul>
                </div>
            </div>
            <div id="auth-error" class="bg-theme-error/20 border border-theme-error text-theme-error px-4 py-3 rounded-lg mb-6 hidden"></div>
            
            <!-- Login Form -->
            <form id="login-form" class="bg-theme-secondary p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6">
                <h2 class="text-2xl font-semibold text-center text-theme-primary">Log In</h2>
                <div class="relative">
                    <input type="email" id="login-email" required class="peer w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition" placeholder=" ">
                    <label for="login-email" class="absolute text-sm text-theme-secondary duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-4 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">Email</label>
                </div>
                <div class="relative">
                    <input type="password" id="login-password" required class="peer w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition pr-10" placeholder=" ">
                    <label for="login-password" class="absolute text-sm text-theme-secondary duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-4 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">Password</label>
                    <button type="button" id="login-password-toggle" class="absolute inset-y-0 right-0 flex items-center pr-3 text-theme-quaternary hover:text-theme-primary">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                <div class="flex items-center justify-between text-sm text-theme-quaternary">
                    <label class="inline-flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="login-remember" class="rounded">
                        <span>Remember me</span>
                    </label>
                    <a href="#" id="forgot-password-link" class="hover:text-theme-accent">Forgot password?</a>
                </div>
                <button type="submit" class="w-full bg-theme-accent hover:bg-green-500 text-theme-inverse hover:text-black font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Log In</span>
                    <svg class="animate-spin h-5 w-5 ml-3 hidden button-loader" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <div class="flex items-center gap-2 my-2">
                    <div class="flex-1 h-px bg-theme-tertiary"></div>
                    <span class="text-xs text-theme-quaternary">or</span>
                    <div class="flex-1 h-px bg-theme-tertiary"></div>
                </div>
                <button type="button" id="google-signin-btn" class="w-full bg-theme-tertiary border border-theme-primary text-theme-primary font-medium py-2.5 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2 hover:bg-theme-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="20" height="20"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12 s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C33.041,6.053,28.741,4,24,4C12.955,4,4,12.955,4,24 s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,16.108,18.961,13,24,13c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657 C33.041,6.053,28.741,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.197l-6.198-5.238C29.211,35.091,26.715,36,24,36 c-5.198,0-9.607-3.317-11.287-7.946l-6.49,5.002C9.533,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.794,2.241-2.231,4.164-4.108,5.571 c0.001-0.001,0.002-0.001,0.003-0.002l6.198,5.238C36.927,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                    Continue with Google
                </button>
                <p class="text-center text-theme-quaternary">
                    Don't have an account? <a href="#" id="show-signup" class="font-semibold text-theme-accent hover:text-theme-accent">Sign up</a>
                </p>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="bg-theme-secondary p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6 hidden">
                <h2 class="text-2xl font-semibold text-center text-theme-primary">Sign Up</h2>
                <div class="relative">
                    <input type="text" id="signup-name" required class="peer w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition" placeholder=" ">
                    <label for="signup-name" class="absolute text-sm text-theme-secondary duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-4 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">Full Name</label>
                </div>
                <div class="relative">
                    <input type="email" id="signup-email" required class="peer w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition" placeholder=" ">
                    <label for="signup-email" class="absolute text-sm text-theme-secondary duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-4 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">Email</label>
                    <p id="email-error" class="text-theme-error text-sm mt-1 hidden"></p>
                </div>
                <div class="relative">
                    <input type="password" id="signup-password" required class="peer w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition pr-10" placeholder=" ">
                    <label for="signup-password" class="absolute text-sm text-theme-secondary duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-4 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">Password</label>
                     <button type="button" id="signup-password-toggle" class="absolute inset-y-0 right-0 flex items-center pr-3 text-theme-quaternary hover:text-theme-primary">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                 <div class="w-full bg-theme-tertiary rounded-full h-[5px]">
                    <div id="password-strength-bar" class="rounded-full"></div>
                </div>
                <p id="password-error" class="text-theme-error text-sm -mt-3 hidden"></p>
                <div class="relative">
                    <input type="password" id="signup-password-confirm" required class="peer w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition" placeholder=" ">
                    <label for="signup-password-confirm" class="absolute text-sm text-theme-secondary duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-4 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">Confirm Password</label>
                    <p id="password-confirm-error" class="text-theme-error text-sm mt-1 hidden"></p>
                </div>
                <label class="flex items-start gap-2 text-sm text-theme-quaternary">
                    <input type="checkbox" id="signup-terms" class="mt-1" />
                    <span>I agree to the <a href="#" class="text-theme-accent hover:underline">Terms</a> and <a href="#" class="text-theme-accent hover:underline">Privacy Policy</a>.</span>
                </label>

                <button type="submit" class="w-full bg-theme-accent hover:bg-green-500 hover:text-black text-theme-inverse font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Sign Up</span>
                    <svg class="animate-spin h-5 w-5 ml-3 hidden button-loader" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <p class="text-center text-theme-quaternary">
                    Already have an account? <a href="#" id="show-login" class="font-semibold text-theme-accent hover:text-theme-accent">Log in</a>
                </p>
            </form>
            <!-- Verify Email Card -->
            <div id="verify-email-card" class="bg-theme-secondary p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6 hidden">
                <h2 class="text-2xl font-semibold text-center text-theme-primary">Verify your email</h2>
                <p class="text-sm text-theme-quaternary text-center">We sent a verification link to <span id="verify-email-address" class="text-theme-primary font-medium"></span>. Please verify your email to continue.</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="button" id="resend-verification-btn" class="flex-1 bg-theme-accent text-theme-inverse py-2.5 rounded-lg font-medium">Resend verification email</button>
                    <button type="button" id="refresh-verification-btn" class="flex-1 bg-theme-tertiary border border-theme-primary text-theme-primary py-2.5 rounded-lg font-medium">I've verified, refresh</button>
                </div>
                <button type="button" id="verify-signout-btn" class="w-full bg-theme-secondary border border-theme-primary text-theme-primary py-2.5 rounded-lg">Sign out</button>
            </div>
        </div>
    </div>

    <div id="chat-app" class="hidden w-full h-full flex relative">
        <!-- Sidebar for Chat History -->
        <aside id="sidebar" class="sidebar bg-theme-secondary w-72 flex-shrink-0 flex flex-col p-4 lg:relative lg:translate-x-0">
            <!-- Sidebar Buttons -->
<div class="flex flex-col space-y-3 mb-4">
  
  <!-- New Chat -->
  <button id="new-chat-btn"
    class="relative flex items-center justify-center gap-3 w-full
           bg-gradient-to-r from-emerald-500 via-teal-600 to-cyan-600
           text-white font-semibold rounded-xl px-5 py-3 text-sm
           shadow-lg transition-all duration-500 transform
           hover:scale-110 hover:shadow-2xl overflow-hidden">
    <span class="absolute inset-0 rounded-xl bg-gradient-to-r from-emerald-400 via-teal-500 to-cyan-500
                 opacity-70 blur-lg animate-pulse"></span>
    <span class="absolute inset-0 bg-white/20 opacity-0 hover:opacity-100
                 transition-opacity duration-700 rounded-xl"></span>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         width="18" height="18" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
         class="relative z-10 shrink-0" aria-hidden="true">
      <!-- message-square-plus icon -->
      <path d="M21 15a4 4 0 0 1-4 4H10l-4 4V7a4 4 0 0 1 4-4h7a4 4 0 0 1 4 4z"/>
      <path d="M15 6v4M13 8h4"/>
    </svg>
    <span class="relative z-10">New Chat</span>
  </button>

  <!-- AI Medical -->
  <button id="medical-ai-btn"
    class="relative flex items-center justify-center gap-3 w-full
           bg-gradient-to-r from-emerald-500 via-green-600 to-teal-600
           text-white font-semibold rounded-xl px-5 py-3 text-sm
           shadow-lg transition-all duration-500 transform
           hover:scale-110 hover:shadow-2xl overflow-hidden">
    <span class="absolute inset-0 rounded-xl bg-gradient-to-r from-emerald-400 via-green-500 to-teal-500
                 opacity-70 blur-lg animate-pulse"></span>
    <span class="absolute inset-0 bg-white/20 opacity-0 hover:opacity-100
                 transition-opacity duration-700 rounded-xl"></span>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         width="18" height="18" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
         class="relative z-10 shrink-0" aria-hidden="true">
      <!-- medical kit + cross icon -->
      <rect x="3" y="7" width="18" height="12" rx="2"/>
      <path d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
      <path d="M12 10v6M9 13h6"/>
    </svg>
    <span class="relative z-10">AI Medical</span>
  </button>

  <!-- Chat@AI -->
  <button id="chat-ai-btn"
    class="relative flex items-center justify-center gap-3 w-full
           bg-gradient-to-r from-blue-500 via-indigo-600 to-purple-600
           text-white font-semibold rounded-xl px-5 py-3 text-sm
           shadow-lg transition-all duration-500 transform
           hover:scale-110 hover:shadow-2xl overflow-hidden">
    <span class="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500
                 opacity-70 blur-lg animate-pulse"></span>
    <span class="absolute inset-0 bg-white/20 opacity-0 hover:opacity-100
                 transition-opacity duration-700 rounded-xl"></span>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         width="18" height="18" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
         class="relative z-10 shrink-0" aria-hidden="true">
      <!-- bot head icon -->
      <circle cx="12" cy="4" r="1"/>
      <path d="M12 5v3"/>
      <rect x="7" y="9" width="10" height="8" rx="2"/>
      <circle cx="10" cy="13" r="1"/>
      <circle cx="14" cy="13" r="1"/>
      <path d="M10 16c1 .8 3 .8 4 0"/>
    </svg>
    <span class="relative z-10">Chat@AI</span>
  </button>

</div>


            <!-- Enhanced Features Buttons -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                <!-- Fixed Prompt Button -->
                <button id="prompt-library-btn" 
                    class="relative flex items-center justify-center gap-2 w-full 
                        bg-gradient-to-r from-fuchsia-500 via-purple-600 to-indigo-600 
                        text-white font-semibold rounded-xl px-5 py-3 text-sm
                        shadow-lg transition-all duration-500 transform hover:scale-110 hover:shadow-2xl overflow-hidden">

                    <!-- Glow border animation -->
                    <span class="absolute inset-0 rounded-xl bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 
                                opacity-70 blur-lg animate-pulse"></span>

                    <!-- Shine effect -->
                    <span class="absolute inset-0 bg-white/20 opacity-0 hover:opacity-100 
                                transition-opacity duration-700 rounded-xl"></span>

                    <!-- Icon (slightly bigger & properly aligned) -->
                    <svg xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24" width="18" height="18"
                    fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"
                    class="relative z-10 shrink-0">
                <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
                </svg>

                    <!-- Text -->
                    <span class="relative z-10">Prompts</span>
                </button>

                <!-- image button removed -->


                <button id="scheduler-btn"
            class="relative flex items-center justify-center gap-3 w-full
                    bg-gradient-to-r from-cyan-500 via-sky-600 to-blue-600
                    text-white font-semibold rounded-xl px-5 py-3 text-sm
                    shadow-lg transition-all duration-500 transform
                    hover:scale-110 hover:shadow-2xl overflow-hidden
                    focus:outline-none focus-visible:ring-4 focus-visible:ring-white/30"
            aria-label="Open Scheduler">

            <!-- Glow aura -->
            <span class="absolute inset-0 rounded-xl bg-gradient-to-r from-cyan-400 via-sky-500 to-blue-500
                        opacity-70 blur-lg animate-pulse"></span>

            <!-- Shine sweep -->
            <span class="absolute inset-0 bg-white/20 opacity-0 hover:opacity-100
                        transition-opacity duration-700 rounded-xl"></span>

            <!-- Icon (calendar + clock) -->
            <svg xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24" width="18" height="18"
                fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"
                class="relative z-10 shrink-0">
                <!-- calendar -->
                <rect x="3" y="4" width="18" height="16" rx="2" ry="2"/>
                <path d="M16 2v4M8 2v4M3 10h18"/>
                <!-- clock (top-right) -->
                <circle cx="17" cy="15" r="3.25"/>
                <path d="M17 14v1.25l.9.55"/>
            </svg>

            <!-- Text -->
            <span class="relative z-10">Schedule</span>
            </button>
            </div>
            
            <!-- Photo Style Search Bar -->
            <div class="photo-search-container" id="photo-search-container">
                <div class="photo-search-overlay"></div>
                <div class="photo-search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>
                <input 
                    type="text" 
                    id="search-history-input" 
                    placeholder="Search Your History..." 
                    class="photo-search-input"
                >
            </div>

            <div class="flex flex-col gap-2 mb-2">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-theme-secondary">History</h2>
                    <div class="flex items-center gap-2">
                        <button id="clear-all-btn" class="delete-btn p-1 text-theme-quaternary hover:text-theme-error" title="Clear all chats">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="history-enhancements">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-theme-tertiary">Filters & quick access</p>
                        </div>
                        <button id="reset-history-filters" class="history-filter-btn text-xs">Reset Filters</button>
                    </div>
                    <div id="history-filter-bar" class="history-filter-bar"></div>
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-semibold text-theme-secondary">Quick Access</p>
                        <span class="text-xs text-theme-tertiary">Pinned chats stay here</span>
                    </div>
                    <div id="history-quick-access" class="history-quick-access">
                        <!-- Pinned chats rendered here -->
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto pr-2" id="history-container">
                <div class="history-sections">
                    <details class="history-group" open>
                        <summary class="history-group-summary">
                            <span>Today</span>
                        </summary>
                        <ul id="history-list-today" class="space-y-1 pt-2">
                            <!-- Today's chats will be injected here -->
                        </ul>
                    </details>

                    <details class="history-group" open>
                        <summary class="history-group-summary">
                            <span>Previous 7 Days</span>
                        </summary>
                        <ul id="history-list-week" class="space-y-1 pt-2">
                            <!-- Last week's chats will be injected here -->
                        </ul>
                    </details>

                    <details class="history-group">
                        <summary class="history-group-summary">
                            <span>Older</span>
                        </summary>
                        <ul id="history-list-older" class="space-y-1 pt-2">
                            <!-- Older chats will be injected here -->
                        </ul>
                    </details>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content flex-1 flex flex-col h-full relative z-10 bg-theme-primary">
            <!-- Header -->
            <header class="bg-theme-secondary/50 backdrop-blur-sm border-b border-theme-primary shadow-lg sticky top-0 z-30">
                 <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
                     <div class="flex items-center gap-4">
                        <button id="menu-btn" class="lg:hidden p-2 -ml-2 text-theme-secondary hover:bg-theme-tertiary rounded-md">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </button>
                        <div class="w-8 h-8 bg-theme-accent rounded-full flex items-center justify-center shadow">
                           <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 rounded-full shadow" />
                        </div>
                                                <h1 class="text-2xl sm:text-3xl font-extrabold toy-heading">
                                                    <span style="font-family: 'Comic Sans MS', 'Baloo 2', 'Fredoka One', cursive; letter-spacing: 2px; background: linear-gradient(90deg, #FFB347 0%, #FF69B4 40%, #00CFFF 80%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 2px 2px 0 #fff, 4px 4px 0 #ffb347, 6px 6px 0 #00cfff;">
                                                        Chat@AI
                                                    </span>
                                                </h1>
                        <!-- Medical Mode Indicator -->
                        <div id="medical-mode-indicator" class="medical-mode-indicator hidden" title="Medical AI Mode Active">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                                <path d="M12 5L8 21l4-7 4 7-4-16"/>
                            </svg>
                        </div>
                     </div>
                     <div class="flex items-center gap-2 sm:gap-4">
                        <!-- Theme Selector -->
                        <div class="theme-selector relative">
                            <button id="theme-btn" class="flex items-center gap-2 text-theme-secondary hover:bg-theme-tertiary rounded-md px-3 py-1.5 transition-colors">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
                               <span class="hidden sm:inline">Theme</span>
                            </button>
                            <div id="theme-dropdown" class="theme-dropdown">
                                <div class="theme-option" data-theme="light">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
                                     <span>Light</span>
                                </div>
                                <div class="theme-option" data-theme="dark">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                                    <span>Dark</span>
                                </div>
                                <div class="theme-option" data-theme="midnight">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6.364 6.364 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                                    <span>Midnight</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <button id="export-btn" class="flex items-center gap-2 text-theme-secondary hover:bg-theme-tertiary rounded-md px-3 py-1.5 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                               <span class="hidden sm:inline">Export</span>
                            </button>
                            <div id="export-dropdown" class="export-dropdown">
                                <button class="dropdown-item" data-format="txt">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                                     <span>As TXT</span>
                                </button>
                                <button class="dropdown-item" data-format="md">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M7 15v-4.5a1.5 1.5 0 0 1 3 0V15"></path><path d="M7 12h3"></path><path d="M12 15l2-2.5 2 2.5"></path><path d="M17 15v-5"></path></svg>
                                    <span>As Markdown</span>
                                </button>
                                <button class="dropdown-item" data-format="pdf">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><path d="M12.25 15.75a1 1 0 0 0 1.5 0v-2.5a1 1 0 0 0-1.5 0Z"/><path d="M10 12h1a2 2 0 1 1 0 4h-1v-4Z"/><path d="M15 12h1a2 2 0 0 1 0 4h-1"/></svg>
                                    <span>As PDF</span>
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            <button id="profile-btn" class="flex items-center gap-2 text-theme-secondary hover:bg-theme-tertiary rounded-full p-1 transition-colors">
                                <div id="profile-avatar" class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white overflow-hidden"></div>
                            </button>
                            <div id="profile-dropdown" class="profile-dropdown transform origin-top-right shadow-xl rounded-lg overflow-hidden">
                                <!-- User Profile Section -->
                                <div class="p-6 bg-theme-accent/5 border-b border-theme-primary/10">
                                    <div class="flex items-center gap-4 mb-3">
                                        <div id="dropdown-avatar" class="w-12 h-12 rounded-full bg-theme-accent flex items-center justify-center text-theme-inverse font-bold text-xl overflow-hidden">
                                            <!-- Avatar will be injected here -->
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="font-bold text-theme-primary truncate text-lg" id="profile-name"></p>
                                            <p class="text-sm text-theme-quaternary truncate" id="profile-email"></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-theme-quaternary">
                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-theme-accent/10">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20 6L9 17l-5-5"/>
                                            </svg>
                                            Verified Account
                                        </span>
                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-500/10 text-green-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M12 16v-4"/>
                                                <path d="M12 8h.01"/>
                                            </svg>
                                            Online
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Navigation Links -->
                                <div class="p-2 bg-theme-secondary">
                                    <button id="home-btn" class="dropdown-item w-full text-theme-secondary group hover:bg-theme-accent hover:text-theme-inverse">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-current">
                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                            <polyline points="9 22 9 12 15 12 15 22"/>
                                         </svg>
                                        <span>Home</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-auto opacity-0 group-hover:opacity-100 transition-opacity">
                                            <path d="M5 12h14"/>
                                            <path d="m12 5 7 7-7 7"/>
                                        </svg>
                                    </button>
                                    <button id="profile-settings-btn" class="dropdown-item w-full text-theme-secondary group hover:bg-theme-accent hover:text-theme-inverse">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-current">
                                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                         </svg>
                                        <span>Profile Settings</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-auto opacity-0 group-hover:opacity-100 transition-opacity">
                                            <path d="M5 12h14"/>
                                            <path d="m12 5 7 7-7 7"/>
                                        </svg>
                                    </button>
                                    
                                    <div class="my-2 border-t border-theme-primary/10"></div>
                                    
                                    <button id="logout-btn" class="dropdown-item w-full text-theme-error font-medium group hover:bg-theme-error hover:text-theme-inverse">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-current"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                        <span>Logout</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-auto opacity-0 group-hover:opacity-100 transition-opacity">
                                            <path d="M5 12h14"/>
                                            <path d="m12 5 7 7-7 7"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Main Chat Area -->
                <main id="chat-main-area" class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                    <div id="chat-container" class="max-w-4xl mx-auto space-y-6">
                        <!-- Welcome content will be shown here initially -->
                    </div>
                </main>

                <!-- Message Input Form & Controls -->
                <footer class="bg-theme-primary/50 backdrop-blur-sm sticky bottom-0">
                     <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
                        <div id="chat-input-area" class="flex-shrink-0 p-4 bg-theme-surface shadow-lg rounded-t-xl transition-shadow duration-300">
                            <div id="generation-controls" class="text-center pb-2 hidden">
                                <button id="stop-generating-btn" class="bg-theme-tertiary hover:bg-theme-quaternary text-theme-primary font-semibold rounded-lg px-4 py-2 transition duration-300 flex items-center mx-auto">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="mr-2">
                                     <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                                   </svg>
                                    Stop Generating
                                </button>
                            </div>
                            <form id="chat-form">
                                <div id="file-preview-container">
                                    <div id="file-preview"></div>
                                    <button type="button" id="remove-file-btn" title="Remove file">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                                <div class="flex items-end bg-theme-secondary border border-theme-primary rounded-2xl p-2 transition-all duration-300 focus-within:ring-2 focus-within:ring-theme-accent">
                                    <div class="help-tooltip">
                                        <button id="attach-file-btn" type="button" class="text-theme-quaternary hover:text-theme-primary p-2 rounded-full hover:bg-theme-tertiary transition-colors duration-200">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                        </button>
                                        <div class="tooltip-content">Attach File</div>
                                    </div>
                                     <input type="file" id="file-input" class="hidden" multiple accept="image/*,audio/*,video/*,.csv,.txt,.py,.js,.java,.c,.cpp">
                                     
                                    <textarea id="chat-input" placeholder="Enter Your Prompt..." autocomplete="off" rows="1" class="flex-1 bg-transparent px-4 py-2 text-theme-primary placeholder-theme-quaternary focus:outline-none disabled:bg-transparent disabled:cursor-not-allowed"></textarea>

                                    <div class="help-tooltip">
                                        <button id="mic-btn" type="button" class="text-theme-quaternary hover:text-theme-primary p-2 rounded-full hover:bg-theme-tertiary transition-colors duration-200 disabled:opacity-50">
                                        <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
                                    </button>
                                    <div class="tooltip-content">
                                        Voice input (click to start)
                                    </div>
                                </div>

                                <button type="submit" class="bg-theme-quaternary text-theme-primary rounded-full p-2 ml-1 transition-colors duration-300 flex items-center justify-center disabled:bg-theme-tertiary disabled:cursor-not-allowed w-10 h-10 flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                                </button>
                            </div>
                        </form>
                        
                    </div>
                </footer>
            </div>
            <aside id="analytics-panel" class="analytics-panel hidden lg:flex">
                <div class="flex items-center justify-between">
                    <h3>Insights</h3>
                    <button id="pin-last-chart-btn" class="analytics-pin-btn">Pin Chart</button>
                </div>
            <div class="analytics-stats">
                <div class="analytics-stat">
                    Chats
                    <strong id="analytics-total-chats">0</strong>
                </div>
                <div class="analytics-stat">
                    Messages
                    <strong id="analytics-total-messages">0</strong>
                </div>
                <div class="analytics-stat">
                    Avg response
                    <strong id="analytics-avg-response">0</strong>
                </div>
                <div class="analytics-stat">
                    Attachments
                    <strong id="analytics-attachment-count">0</strong>
                </div>
            </div>
            <div class="analytics-widget-grid">
                <div class="analytics-widget">
                    <h4>Confidence</h4>
                    <div class="analytics-widget-value" id="widget-confidence-value">--</div>
                    <div class="analytics-progress-track">
                        <div id="widget-confidence-bar" class="analytics-progress-fill"></div>
                    </div>
                    <p class="text-xs text-theme-tertiary" id="widget-confidence-note">Confidence is computed from the assistants tone and certainty.</p>
                </div>
                <div class="analytics-widget">
                    <h4>Sentiment</h4>
                    <div class="analytics-widget-value" id="widget-sentiment-label">Neutral</div>
                    <p class="text-xs text-theme-tertiary" id="widget-sentiment-note">Analyzed from cues in the latest response.</p>
                </div>
                <div class="analytics-widget" style="grid-column: span 2;">
                    <h4>Sources</h4>
                    <div class="sources-list" id="widget-sources-list">
                        <span class="text-xs text-theme-tertiary">No sources detected.</span>
                    </div>
                </div>
                <div class="analytics-widget" style="grid-column: span 2;">
                    <h4>Follow-up Suggestions</h4>
                    <div class="followup-suggestions" id="widget-followups">
                        <span class="text-xs text-theme-tertiary">Awaiting the next assistant response.</span>
                    </div>
                </div>
            </div>
            <div class="analytics-last-chart" id="analytics-last-chart">
                <p id="analytics-chart-caption">Pin a response containing a table or chart to keep it here.</p>
                <div id="analytics-chart-preview" class="text-xs text-theme-tertiary">No chart pinned yet.</div>
            </div>
        </aside>
        </div>
        <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black/50 backdrop-blur-sm hidden lg:hidden"></div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-theme-secondary rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="delete-modal-title" class="text-xl font-bold text-theme-primary mb-4">Delete Chat?</h3>
            <p id="delete-modal-text" class="text-theme-quaternary mb-6">Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 rounded-md bg-theme-tertiary hover:bg-theme-quaternary transition-colors">Cancel</button>
                <button id="confirm-delete-btn" class="modal-delete-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Code Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
         <div class="bg-theme-secondary rounded-lg shadow-xl w-full h-full max-w-4xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-theme-primary flex-shrink-0">
                <h3 class="text-xl font-bold text-theme-primary">Live Preview</h3>
                <button id="close-preview-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div class="flex-1 p-1 bg-white">
                <iframe id="preview-iframe" class="w-full h-full border-0 rounded-md"></iframe>
            </div>
        </div>
    </div>

    <!-- Interactive Feature Modal -->
    <div id="interactive-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] hidden items-center justify-center p-4">
        <div class="bg-theme-secondary border border-theme-primary rounded-lg shadow-xl w-full h-full max-w-6xl max-h-[90vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-theme-primary flex-shrink-0">
                <h3 id="interactive-modal-title" class="text-xl font-bold text-theme-primary"></h3>
                <button id="close-interactive-modal-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div id="interactive-modal-body" class="flex-1 p-0 overflow-auto bg-theme-primary">
                <!-- Content will be injected here -->
            </div>
            <footer id="interactive-modal-footer" class="p-2 border-t border-theme-primary flex-shrink-0 hidden justify-center items-center gap-2">
                <!-- Footer content like buttons will be injected here -->
            </footer>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-theme-primary">Profile Settings</h2>
                <button id="close-profile-settings-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Avatar Section -->
                <div class="settings-section">
                    <h3 class="text-lg font-semibold text-theme-primary mb-4">Avatar</h3>
                    <div class="flex items-center gap-6">
                        <div class="avatar-upload" role="button" tabindex="0" aria-label="Upload new avatar">
                            <div id="current-avatar" class="w-20 h-20 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white text-2xl overflow-hidden">
                                <!-- Avatar image or initial will be injected here -->
                                <div id="avatar-loading" class="absolute inset-0 bg-theme-primary/80 hidden flex-col items-center justify-center">
                                    <svg class="animate-spin text-theme-accent w-8 h-8 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="text-xs text-theme-inverse">Processing...</span>
                                </div>
                            </div>
                            <div class="upload-overlay">
                                <div class="upload-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                </div>
                            </div>
                            <input type="file" id="avatar-upload" class="hidden" accept="image/*" aria-label="Upload new avatar" data-max-size="5242880">
                        </div>
                        <div class="flex-1">
                            <button id="upload-avatar-btn" class="btn btn-primary mb-3 w-full sm:w-auto" data-loading="false">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                <span id="upload-btn-text">Choose Image</span>
                            </button>
                            <div class="flex items-center gap-2 mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-theme-quaternary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                <p class="text-sm text-theme-quaternary">Upload a new profile picture (JPG, PNG, GIF - Max 5MB)</p>
                            </div>
                            <div id="upload-error" class="hidden mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="12" y1="8" x2="12" y2="12"/>
                                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                    <span class="text-sm text-red-600" id="upload-error-message">Error message will appear here</span>
                                </div>
                            </div>
                            <div id="upload-progress-container" class="hidden upload-progress">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin text-theme-accent">
                                            <line x1="12" y1="2" x2="12" y2="6"/>
                                            <line x1="12" y1="18" x2="12" y2="22"/>
                                            <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/>
                                            <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/>
                                            <line x1="2" y1="12" x2="6" y2="12"/>
                                            <line x1="18" y1="12" x2="22" y2="12"/>
                                            <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/>
                                            <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/>
                                        </svg>
                                        <span class="text-sm text-theme-secondary font-medium">Uploading...</span>
                                    </div>
                                    <span id="upload-progress-percent" class="text-sm font-semibold text-theme-accent">0%</span>
                                </div>
                                <div class="upload-progress-bar">
                                    <div id="upload-progress-fill" class="upload-progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Settings -->
                <div class="settings-section">
                    <h3 class="text-lg font-semibold text-theme-primary mb-4">Account</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="form-label">Full Name</label>
                            <input type="text" id="profile-name-input" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Email</label>
                            <input type="email" id="profile-email-input" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">New Password</label>
                            <input type="password" id="profile-password-input" class="form-input" placeholder="Leave blank to keep current password">
                        </div>
                    </div>
                </div>

                <!-- Preferences -->
                <div class="settings-section">
                    <h3 class="text-lg font-semibold text-theme-primary mb-4">Preferences</h3>
                    <div class="space-y-4">
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">Language</label>
                                <p class="text-sm text-theme-quaternary">Choose your preferred language</p>
                            </div>
                            <select id="language-select" class="form-input w-32">
                                <option value="en">English</option>
                                <option value="es">Espaol</option>
                                <option value="fr">Franais</option>
                                <option value="de">Deutsch</option>
                                <option value="it">Italiano</option>
                                <option value="pt">Portugus</option>
                                <option value="ru"></option>
                                <option value="ja"></option>
                                <option value="ko"></option>
                                <option value="zh"></option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">Font Size</label>
                                <p class="text-sm text-theme-quaternary">Adjust text size for better readability</p>
                            </div>
                            <select id="font-size-select" class="form-input w-32">
                                <option value="small">Small</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Large</option>
                                <option value="extra-large">Extra Large</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">Auto-save Conversations</label>
                                <p class="text-sm text-theme-quaternary">Automatically save chats to cloud</p>
                            </div>
                            <div class="toggle-switch active" id="auto-save-toggle"></div>
                        </div>
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">Sound Effects</label>
                                <p class="text-sm text-theme-quaternary">Play sounds for notifications</p>
                            </div>
                            <div class="toggle-switch" id="sound-effects-toggle"></div>
                        </div>
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">TTS Auto-play</label>
                                <p class="text-sm text-theme-quaternary">Automatically read AI responses</p>
                            </div>
                            <div class="toggle-switch" id="tts-autoplay-toggle"></div>
                        </div>
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">Enable Deep Thinking</label>
                                <p class="text-sm text-theme-quaternary">Use the model's increased thinking_budget for complex reasoning (slower, more thorough)</p>
                            </div>
                            <div class="toggle-switch" id="deep-thinking-toggle"></div>
                        </div>
                        <div class="tts-settings">
                            <div>
                                <label for="tts-voice-dropdown">Voice Language / Accent</label>
                                <select id="tts-voice-dropdown" class="form-input">
                                    <option value="">Auto select voice</option>
                                </select>
                            </div>
                            <div>
                                <label for="tts-voice-style" class="font-medium text-theme-primary">TTS Voice Style</label>
                                <p class="text-sm text-theme-quaternary">Describe how you want the voice to sound (e.g., warm, formal, playful).</p>
                                <input type="text" id="tts-voice-style" class="form-input w-full" placeholder="e.g., warm and friendly">
                            </div>
                            <div class="tts-preview-controls">
                                <button type="button" id="tts-preview-btn" class="btn btn-secondary">Preview Voice</button>
                                <button type="button" id="tts-queue-add-btn" class="btn btn-primary">Add to Playback Queue</button>
                                <button type="button" id="tts-clear-queue-btn" class="btn btn-secondary">Clear Queue</button>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-theme-primary mb-1">Playback Queue</p>
                                <div id="voice-queue-list" class="voice-queue">
                                    <p class="text-xs text-theme-quaternary">No queued snippets yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-profile-settings-btn" class="btn btn-secondary">Cancel</button>
                <button id="save-profile-settings-btn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Prompt Library Modal -->
    <div id="prompt-library-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 48rem;">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-theme-primary">Prompt Library</h2>
                <button id="close-prompt-library-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-theme-primary">Quick Filters</h3>
                        <button id="add-prompt-btn" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span>New Prompt</span>
                        </button>
                    </div>
                    
                    <div id="prompt-tag-filter-bar" class="flex flex-wrap gap-2 mb-4 p-2 bg-theme-tertiary rounded-lg border border-theme-primary/50"></div>

                    <input type="text" id="search-prompts" placeholder="Search prompts by title or content..." class="form-input w-full">
                </div>

                <div id="prompts-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Prompt Modal -->
    <div id="add-prompt-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="add-prompt-title" class="text-xl font-bold text-theme-primary">Add New Prompt</h2>
                <button id="close-add-prompt-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="prompt-form" class="space-y-4">
                    <div>
                        <label class="form-label">Title</label>
                        <input type="text" id="prompt-title" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Category</label>
                        <select id="prompt-category" class="form-input" required>
                            <option value="">Select Category</option>
                            <option value="coding">Coding</option>
                            <option value="writing">Writing</option>
                            <option value="business">Business</option>
                            <option value="creative">Creative</option>
                            <option value="education">Education</option>
                            <option value="medical">Medical</option>
                        </select>
                    </div>
                    <div>
                        <label for="prompt-tags" class="form-label">Tags (e.g., code, drafting, medical)</label>
                        <input type="text" id="prompt-tags" class="form-input" placeholder="Separate tags with commas (e.g., code, backend, utility)">
                    </div>
                    <div>
                        <label class="form-label">Prompt Text</label>
                        <textarea id="prompt-text" class="form-input h-32" required></textarea>
                    </div>
                    <div>
                        <label class="form-label">Description (Optional)</label>
                        <textarea id="prompt-description" class="form-input h-20"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancel-add-prompt-btn" class="btn btn-secondary">Cancel</button>
                <button id="save-prompt-btn" class="btn btn-primary">Save Prompt</button>
            </div>
        </div>
    </div>

    <!-- Scheduler Modal -->
    <div id="scheduler-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 48rem;">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-theme-primary">Schedule Prompts</h2>
                <button id="close-scheduler-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="schedule-bulk-controls">
                    <button id="pause-all-schedules-btn" class="secondary">Pause All</button>
                    <button id="resume-all-schedules-btn" class="secondary">Resume All</button>
                    <button id="duplicate-all-schedules-btn" class="secondary">Duplicate Next Run</button>
                    <button id="view-today-schedules-btn" class="primary">Focus Timeline</button>
                </div>
                <div id="schedule-timeline" class="schedule-timeline"></div>
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-theme-primary">Scheduled Tasks</h3>
                    <button id="add-schedule-btn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Schedule New
                    </button>
                </div>
                <div id="scheduled-tasks" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Scheduled tasks will be inserted here -->
                </div>
            </div>

                <!-- Image Generation removed -->
        </div>
    </div>

    <!-- Add Schedule Modal -->
    <div id="add-schedule-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-theme-primary">Schedule New Task</h2>
                <button id="close-add-schedule-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="schedule-form" class="space-y-4">
                    <div>
                        <label class="form-label">Task Name</label>
                        <input type="text" id="schedule-name" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Prompt</label>
                        <textarea id="schedule-prompt" class="form-input h-32" required></textarea>
                    </div>
                    <div>
                        <label class="form-label">Run Frequency</label>
                        
                        <div class="frequency-tabs" id="schedule-frequency-tabs">
                            <div class="frequency-tab active" data-frequency="once">One-Time</div>
                            <div class="frequency-tab" data-frequency="daily">Daily</div>
                            <div class="frequency-tab" data-frequency="weekly">Weekly</div>
                            <div class="frequency-tab" data-frequency="monthly">Monthly</div>
                        </div>

                        <input type="hidden" id="schedule-repeat" value="once">
                        <div id="frequency-details-container">
                            <div id="frequency-once-daily" class="frequency-pane">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="schedule-date" class="form-label">Start Date</label>
                                        <input type="date" id="schedule-date" class="form-input">
                                    </div>
                                    <div>
                                        <label for="schedule-time" class="form-label">Time of Day</label>
                                        <input type="time" id="schedule-time" class="form-input" value="09:00">
                                    </div>
                                </div>
                            </div>

                            <div id="frequency-weekly" class="frequency-pane hidden">
                                <label class="form-label">Days of the Week</label>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" data-day="Mon" class="btn btn-secondary day-selector-btn">Mon</button>
                                    <button type="button" data-day="Tue" class="btn btn-secondary day-selector-btn">Tue</button>
                                    <button type="button" data-day="Wed" class="btn btn-secondary day-selector-btn">Wed</button>
                                    <button type="button" data-day="Thu" class="btn btn-secondary day-selector-btn">Thu</button>
                                    <button type="button" data-day="Fri" class="btn btn-secondary day-selector-btn">Fri</button>
                                    <button type="button" data-day="Sat" class="btn btn-secondary day-selector-btn">Sat</button>
                                    <button type="button" data-day="Sun" class="btn btn-secondary day-selector-btn">Sun</button>
                                </div>
                            </div>

                            <div id="frequency-monthly" class="frequency-pane hidden">
                                <label for="schedule-day-of-month" class="form-label">Day of the Month</label>
                                <input type="number" id="schedule-day-of-month" class="form-input w-24" min="1" max="31" value="1">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancel-add-schedule-btn" class="btn btn-secondary">Cancel</button>
                <button id="save-schedule-btn" class="btn btn-primary">Schedule Task</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updateProfile,
            updatePassword,
            updateEmail,
            sendPasswordResetEmail,
            sendEmailVerification,
            setPersistence,
            browserLocalPersistence,
            browserSessionPersistence,
            GoogleAuthProvider,
            signInWithPopup,
            reload,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            collection,
            addDoc,
            query,
            getDocs,
            deleteDoc,
            updateDoc,
            where,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL,
            uploadBytesResumable
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- DOM Element References ---
        const authPage = document.getElementById('auth-page');
        const chatApp = document.getElementById('chat-app');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const signupNameInput = document.getElementById('signup-name');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupPasswordConfirmInput = document.getElementById('signup-password-confirm');
        const signupTermsCheckbox = document.getElementById('signup-terms');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const emailError = document.getElementById('email-error');
        const passwordError = document.getElementById('password-error');
        const passwordConfirmError = document.getElementById('password-confirm-error');
        const loginRemember = document.getElementById('login-remember');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const verifyEmailCard = document.getElementById('verify-email-card');
        const verifyEmailAddress = document.getElementById('verify-email-address');
        const resendVerificationBtn = document.getElementById('resend-verification-btn');
        const refreshVerificationBtn = document.getElementById('refresh-verification-btn');
        const verifySignoutBtn = document.getElementById('verify-signout-btn');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const profileAvatarContainer = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const logoutBtn = document.getElementById('logout-btn');
        const homeBtn = document.getElementById('home-btn');
        const exportBtn = document.getElementById('export-btn');
        const exportDropdown = document.getElementById('export-dropdown');
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notification-icon');
        const notificationText = document.getElementById('notification-text');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        const chatMainArea = document.getElementById('chat-main-area');
        const submitButton = chatForm.querySelector('button[type="submit"]');
        const micBtn = document.getElementById('mic-btn');
        const micIcon = document.getElementById('mic-icon');
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const medicalAiBtn = document.getElementById('medical-ai-btn');
        const chatAiBtn = document.getElementById('chat-ai-btn');
        const medicalModeIndicator = document.getElementById('medical-mode-indicator');
        const historyList = document.getElementById('history-list');
        const searchHistoryInput = document.getElementById('search-history-input');
        const photoSearchContainer = document.getElementById('photo-search-container');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalText = document.getElementById('delete-modal-text');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const previewModal = document.getElementById('preview-modal');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        const previewIframe = document.getElementById('preview-iframe');
        const generationControls = document.getElementById('generation-controls');
        const stopGeneratingBtn = document.getElementById('stop-generating-btn');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const filePreview = document.getElementById('file-preview');
        const removeFileBtn = document.getElementById('remove-file-btn');
        const interactiveModal = document.getElementById('interactive-modal');
        const interactiveModalTitle = document.getElementById('interactive-modal-title');
        const interactiveModalBody = document.getElementById('interactive-modal-body');
        const interactiveModalFooter = document.getElementById('interactive-modal-footer');
        const closeInteractiveModalBtn = document.getElementById('close-interactive-modal-btn');
        const themeBtn = document.getElementById('theme-btn');
        const themeDropdown = document.getElementById('theme-dropdown');
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');

        // Signup Success Animation Elements
        const signupSuccessOverlay = document.getElementById('signup-success-overlay');

        // Enhanced Feature Elements
        const promptLibraryBtn = document.getElementById('prompt-library-btn');
        const schedulerBtn = document.getElementById('scheduler-btn');
        const profileSettingsBtn = document.getElementById('profile-settings-btn');

        // History Enhancements
        const historyFilterBar = document.getElementById('history-filter-bar');
        const historyQuickAccess = document.getElementById('history-quick-access');
        const resetHistoryFiltersBtn = document.getElementById('reset-history-filters');

        // Modal Elements
        const profileSettingsModal = document.getElementById('profile-settings-modal');
        const promptLibraryModal = document.getElementById('prompt-library-modal');
        const addPromptModal = document.getElementById('add-prompt-modal');
        const schedulerModal = document.getElementById('scheduler-modal');
        const addScheduleModal = document.getElementById('add-schedule-modal');

        // Analytics Panel
        const analyticsTotalChats = document.getElementById('analytics-total-chats');
        const analyticsTotalMessages = document.getElementById('analytics-total-messages');
        const analyticsAvgResponse = document.getElementById('analytics-avg-response');
        const analyticsAttachmentCount = document.getElementById('analytics-attachment-count');
        const analyticsChartPreview = document.getElementById('analytics-chart-preview');
        const analyticsChartCaption = document.getElementById('analytics-chart-caption');
        const pinLastChartBtn = document.getElementById('pin-last-chart-btn');
        const widgetConfidenceValue = document.getElementById('widget-confidence-value');
        const widgetConfidenceBar = document.getElementById('widget-confidence-bar');
        const widgetConfidenceNote = document.getElementById('widget-confidence-note');
        const widgetSentimentLabel = document.getElementById('widget-sentiment-label');
        const widgetSentimentNote = document.getElementById('widget-sentiment-note');
        const widgetSourcesList = document.getElementById('widget-sources-list');
        const widgetFollowups = document.getElementById('widget-followups');

        // Scheduler helpers
        const pauseAllSchedulesBtn = document.getElementById('pause-all-schedules-btn');
        const resumeAllSchedulesBtn = document.getElementById('resume-all-schedules-btn');
        const duplicateAllSchedulesBtn = document.getElementById('duplicate-all-schedules-btn');
        const viewTodaySchedulesBtn = document.getElementById('view-today-schedules-btn');
        const scheduleTimeline = document.getElementById('schedule-timeline');

        // TTS / Voice Queue Controls
        const ttsVoiceDropdown = document.getElementById('tts-voice-dropdown');
        const ttsPreviewBtn = document.getElementById('tts-preview-btn');
        const ttsQueueAddBtn = document.getElementById('tts-queue-add-btn');
        const ttsClearQueueBtn = document.getElementById('tts-clear-queue-btn');
        const voiceQueueList = document.getElementById('voice-queue-list');
        
        // --- API & Firebase Configuration ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';
        const API_KEY = 'AIzaSyAJQq4TdfK2Z_MwcwP2xex8Q7cnkFZsB3k'; // IMPORTANT: Replace with your actual Gemini API key
    // Additional endpoints for multimodal, TTS, and code execution (placeholders)
    const IMAGE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent';
    const TTS_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateAudio';
    const CODE_EXEC_API_URL = 'https://your-code-exec.example.com/execute'; // replace with real code execution endpoint

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyAMqtiL99s78TnDyHEi8VlBbzMzZh8Jqh8",
            authDomain: "login-90932.firebaseapp.com",
            projectId: "login-90932",
            storageBucket: "login-90932.firebasestorage.app",
            messagingSenderId: "574568827002",
            appId: "1:574568827002:web:7ed038c10c3fe0bc3953c3"
        };
        
        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- State Management ---
        let currentChatId = null;
        let allChats = {};
        let chatIdToDelete = null;
        let stopGenerationFlag = false;
        let currentUser = null;
        let notificationQueue = [];
        let isNotificationVisible = false;
    let attachedFiles = []; // array of { id, base64, mimeType, name }
        let chartInstance = null;
        let isMedicalMode = false;
        
        // Code visualizer state
        let visualizerSteps = [];
        let currentVisStep = 0;
        let monacoEditor = null;
        let currentLanguage = 'javascript';
        let isAutoRunEnabled = false;
        const vizLanguages = ['python', 'javascript', 'java', 'c', 'c++'];
        const fileExtensionMap = {
            '.py': 'python',
            '.js': 'javascript',
            '.java': 'java',
            '.c': 'c',
            '.cpp': 'c++'
        };

        // Smart scrolling state
        let isUserScrolledUp = false;
        let isGenerating = false;
        let lastScrollPosition = 0;
        let autoScrollThreshold = 100;

        // Theme Management
        let currentTheme = 'light';

        // TTS State Management
        let currentTTSUtterance = null;
        let isTTSActive = false;
        let currentTTSButton = null;

        // Enhanced Features State
        let userPrompts = [];
        let scheduledTasks = [];
        let userSettings = {
            language: 'en',
            fontSize: 'medium',
            autoSave: true,
            soundEffects: false,
            ttsAutoplay: false,
            deepThinking: false
        };

        let currentEditingPrompt = null;
        let currentEditingSchedule = null;
        const historyFiltersConfig = [
            { id: 'all', label: 'All' },
            { id: 'pinned', label: 'Pinned' },
            { id: 'medical', label: 'Medical' },
            { id: 'multimedia', label: 'Media' }
        ];
        let currentHistoryFilter = 'all';
        let pinnedChatIds = new Set(getStoredPinnedChats());
        let timelineFilterMode = 'all';
        let lastChartPreviewHtml = '';
        let analyticsPinnedChartHtml = '';
        let voiceQueue = [];

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }

        // --- PHOTO SEARCH FUNCTIONALITY ---
        
        function initializePhotoSearch() {
            searchHistoryInput.addEventListener('focus', () => {
                photoSearchContainer.classList.add('focused');
            });
            
            searchHistoryInput.addEventListener('blur', () => {
                photoSearchContainer.classList.remove('focused');
            });
            
            // Update placeholder text based on search activity
            searchHistoryInput.addEventListener('input', () => {
                const hasText = searchHistoryInput.value.trim().length > 0;
                if (hasText) {
                    searchHistoryInput.placeholder = 'Searching your History...';
                } else {
                    searchHistoryInput.placeholder = 'Search Your History...';
                }
                renderHistorySidebar();
            });
        }

        // --- SIGNUP SUCCESS ANIMATION FUNCTIONS ---
        
        function showSignupSuccessAnimation() {
            signupSuccessOverlay.classList.add('show');
            
            // Hide the animation after 3 seconds
            setTimeout(() => {
                hideSignupSuccessAnimation();
            }, 3000);
        }

        function hideSignupSuccessAnimation() {
            signupSuccessOverlay.classList.remove('show');
        }

        // --- TEXT-TO-SPEECH FUNCTIONS ---
        
        function initializeTTS() {
            if (!window.speechSynthesis) {
                console.warn('Speech synthesis not supported in this browser');
                return false;
            }
            populateVoiceDropdown();
            window.speechSynthesis.onvoiceschanged = () => {
                populateVoiceDropdown();
            };
            
            renderVoiceQueue();
            
            return true;
        }

        function populateVoiceDropdown() {
            if (!window.speechSynthesis || !ttsVoiceDropdown) return;
            const voices = window.speechSynthesis.getVoices();
            if (!voices || voices.length === 0) return;
            const options = voices.map(voice => `<option value="${voice.name}">${voice.name} (${voice.lang})</option>`).join('');
            ttsVoiceDropdown.innerHTML = `<option value="">Auto select voice</option>${options}`;
        }

        function getSelectedVoice() {
            if (!window.speechSynthesis) return getPreferredVoice();
            const voices = window.speechSynthesis.getVoices();
            const preferredName = ttsVoiceDropdown?.value;
            if (preferredName) {
                const matched = voices.find(voice => voice.name === preferredName);
                if (matched) return matched;
            }
            return getPreferredVoice();
        }

        function previewTTSVoice() {
            const sampleText = chatInput.value.trim() || 'This is a quick preview of your selected voice.';
            if (!sampleText) {
                showNotification('Enter prompt text for voice preview', 'info');
                return;
            }
            speakText(sampleText, null);
        }

        function queueLatestAssistantResponse() {
            const assistantResponses = chatContainer.querySelectorAll('.chat-message:not(.user) .prose');
            const latestElement = assistantResponses[assistantResponses.length - 1];
            const queueText = latestElement?.textContent?.trim() || chatInput.value.trim();
            if (!queueText) {
                showNotification('No text available to queue', 'info');
                return;
            }
            voiceQueue.push({
                id: `voice-${Date.now()}-${Math.random().toString(36).slice(2, 5)}`,
                text: queueText
            });
            renderVoiceQueue();
            showNotification('Added to voice queue', 'success');
        }

        function renderVoiceQueue() {
            if (!voiceQueueList) return;
            if (voiceQueue.length === 0) {
                voiceQueueList.innerHTML = '<p class="text-xs text-theme-quaternary">No queued snippets yet.</p>';
                return;
            }
            voiceQueueList.innerHTML = voiceQueue.map(item => `
                <div class="voice-queue-item">
                    <span class="text-xs">${escapeHtml(item.text).slice(0, 80)}${item.text.length > 80 ? '' : ''}</span>
                    <div class="flex gap-1">
                        <button type="button" data-play-id="${item.id}" class="text-theme-primary text-xs">Play</button>
                        <button type="button" data-remove-id="${item.id}" class="text-theme-error text-xs">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function playVoiceQueueItem(id) {
            const item = voiceQueue.find(entry => entry.id === id);
            if (!item) return;
            speakText(item.text, null);
        }

        function removeVoiceQueueItem(id) {
            voiceQueue = voiceQueue.filter(entry => entry.id !== id);
            renderVoiceQueue();
        }

        function getPreferredVoice() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return null;
            
            const englishVoices = voices.filter(voice => 
                voice.lang.startsWith('en') && 
                !voice.name.includes('Google')
            );
            
            const femaleVoice = englishVoices.find(voice => 
                voice.name.toLowerCase().includes('female') || 
                voice.name.toLowerCase().includes('samantha') ||
                voice.name.toLowerCase().includes('karen') ||
                voice.name.toLowerCase().includes('victoria')
            );
            
            if (femaleVoice) return femaleVoice;
            return englishVoices[0] || voices[0];
        }

        function cleanTextForTTS(text) {
            let cleanText = text
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\*(.*?)\*/g, '$1')
                .replace(/`(.*?)`/g, '$1')
                .replace(/^\s*#{1,6}\s+/gm, '')
                .replace(/^\s*[-*+]\s+/gm, '')
                .replace(/^\s*\d+\.\s+/gm, '')
                .replace(/!\[.*?\]\(.*?\)/g, '')
                .replace(/\[.*?\]\(.*?\)/g, '$1')
                .replace(/```[\s\S]*?```/g, '[Code block]')
                .replace(/\n{3,}/g, '\n\n')
                .trim();
            
            if (cleanText.length > 2000) {
                cleanText = cleanText.substring(0, 2000) + '... [Text truncated for speech]';
            }
            
            return cleanText;
        }

        function speakText(text, button) {
            if (!window.speechSynthesis) {
                showNotification('Text-to-speech not supported in this browser', 'error');
                return;
            }
            
            if (isTTSActive) {
                stopTTS();
            }
            
            const cleanText = cleanTextForTTS(text);
            if (!cleanText.trim()) {
                showNotification('No text to speak', 'error');
                return;
            }
            
            currentTTSUtterance = new SpeechSynthesisUtterance(cleanText);
            currentTTSButton = button;
            
            const preferredVoice = getSelectedVoice();
            if (preferredVoice) {
                currentTTSUtterance.voice = preferredVoice;
            }
            
            currentTTSUtterance.rate = 0.9;
            currentTTSUtterance.pitch = 1.0;
            currentTTSUtterance.volume = 1.0;
            
            currentTTSUtterance.onstart = () => {
                isTTSActive = true;
                updateTTSButton(button, 'speaking');
                showNotification('Started speaking', 'info');
            };
            
            currentTTSUtterance.onend = () => {
                isTTSActive = false;
                updateTTSButton(button, 'idle');
                currentTTSUtterance = null;
                currentTTSButton = null;
            };
            
            currentTTSUtterance.onerror = (event) => {
                console.error('TTS error:', event.error);
                isTTSActive = false;
                updateTTSButton(button, 'idle');
                currentTTSUtterance = null;
                currentTTSButton = null;
                showNotification('Speech synthesis error', 'error');
            };
            
            currentTTSUtterance.onpause = () => {
                updateTTSButton(button, 'paused');
            };
            
            currentTTSUtterance.onresume = () => {
                updateTTSButton(button, 'speaking');
            };
            
            window.speechSynthesis.speak(currentTTSUtterance);
        }

        function stopTTS() {
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            if (currentTTSButton) {
                updateTTSButton(currentTTSButton, 'idle');
            }
            
            isTTSActive = false;
            currentTTSUtterance = null;
            currentTTSButton = null;
            showNotification('Speech stopped', 'info');
        }

        function pauseTTS() {
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.pause();
            }
        }

        function resumeTTS() {
            if (window.speechSynthesis && window.speechSynthesis.paused) {
                window.speechSynthesis.resume();
            }
        }

        function updateTTSButton(button, state) {
            if (!button) return;
            
            button.classList.remove('speaking', 'paused');
            
            switch (state) {
                case 'speaking':
                    button.classList.add('speaking');
                    button.title = 'Stop speaking';
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>`;
                    break;
                case 'paused':
                    button.classList.add('paused');
                    button.title = 'Resume speaking';
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M23 9l-7 4 7 4V9z"></path></svg>`;
                    break;
                default:
                    button.title = 'Listen to response';
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
                    break;
            }
        }

        function handleTTSButtonClick(button, text) {
            if (isTTSActive && currentTTSButton === button) {
                stopTTS();
            } else {
                speakText(text, button);
            }
        }

        function addTTSButton(container, text) {
            const ttsBtn = document.createElement('button');
            ttsBtn.className = 'tts-button';
            ttsBtn.title = 'Listen to response';
            ttsBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
            
            ttsBtn.onclick = () => handleTTSButtonClick(ttsBtn, text);
            container.insertBefore(ttsBtn, container.firstChild);
        }

        // --- MEDICAL MODE FUNCTIONS ---
        
        function toggleMedicalMode() {
            isMedicalMode = !isMedicalMode;
            medicalModeIndicator.classList.toggle('hidden', !isMedicalMode);
            
            if (isMedicalMode) {
                medicalAiBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                medicalAiBtn.classList.add('bg-green-800', 'hover:bg-green-900');
                chatAiBtn.classList.remove('hidden');
                showMedicalWelcomeContent();
                showNotification('Medical AI Mode activated', 'success');
                updateInputPlaceholder('Ask about symptoms, medications, health advice...');
            } else {
                medicalAiBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                medicalAiBtn.classList.remove('bg-green-800', 'hover:bg-green-900');
                chatAiBtn.classList.add('hidden');
                showWelcomeContent();
                showNotification('Medical AI Mode deactivated', 'info');
                updateInputPlaceholder('Enter Your Prompt...');
            }
        }

        function switchToChatAI() {
            isMedicalMode = false;
            medicalModeIndicator.classList.add('hidden');
            medicalAiBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            medicalAiBtn.classList.remove('bg-green-800', 'hover:bg-green-900');
            chatAiBtn.classList.add('hidden');
            showWelcomeContent();
            showNotification('Switched to Chat@AI mode', 'success');
            updateInputPlaceholder('Enter Your Prompt...');
        }

        function updateInputPlaceholder(placeholder) {
            chatInput.placeholder = placeholder;
        }

        function showMedicalWelcomeContent() {
            const medicalWelcomeHtml = `
                <div class="welcome-card rounded-2xl p-8 mb-6 text-center">
                    <div class="w-20 h-20 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                            <path d="M12 5L8 21l4-7 4 7-4-16"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-theme-primary mb-4">AI Medical Assistant</h2>
                    <p class="text-theme-secondary text-lg mb-6">Your intelligent medical companion for health information, symptom analysis, and wellness guidance.</p>
                    
                    <div class="medical-disclaimer mb-6">
                        <div class="flex items-start gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 flex-shrink-0 mt-0.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4"/>
                                <path d="M12 16h.01"/>
                            </svg>
                            <div class="text-sm">
                                <p class="font-semibold text-red-600 mb-2">Important Medical Disclaimer</p>
                                <p class="text-theme-secondary text-left">This AI assistant provides general health information only and is not a substitute for professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare providers for medical concerns. In emergencies, contact emergency services immediately.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-theme-primary mb-4">Medical AI Features:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                           <button class="medical-feature-card suggestion-card" data-suggestion="I have a headache, fatigue, and sore throat. What could be causing these symptoms?">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                                </div>
                                <span class="text-theme-secondary">Symptom Checker</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="What is Lisinopril used for and what are its common side effects?">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                                </div>
                                <span class="text-theme-secondary">Medication Information</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="Check for interactions between Warfarin and Aspirin.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-red-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><path d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Drug Interactions</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="Explain diabetes in simple terms that a 10-year-old could understand.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M9 12l2 2 4-4"/><path d="M21 12c-1.5 0-3-1-3-3s1.5-3 3-3 3 1 3 3-1.5 3-3 3"/><path d="M3 12c1.5 0 3-1 3-3S4.5 6 3 6s-3 1-3 3 1.5 3 3 3"/></svg>
                                </div>
                                <span class="text-theme-secondary">Simple Explanations</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="Create a personalized diet plan for a 30-year-old vegetarian looking to lose weight.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-orange-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-400"><path d="M2 21a8 8 0 0 1 13.292-6"/><circle cx="10" cy="8" r="5"/><path d="M19 16v6"/><path d="M22 19h-6"/></svg>
                                </div>
                                <span class="text-theme-secondary">Diet & Fitness Plans</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="Guide me through a 5-minute breathing exercise for stress relief.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-cyan-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Mental Wellness</span>
                             </div>
                           </button>
                        </div>
                    </div>
                </div>`;
            chatContainer.innerHTML = medicalWelcomeHtml;
            exportBtn.disabled = true;
        }

        function createMedicalPrompt(userInput) {
            const medicalSystemPrompt = `You are an AI Medical Assistant designed to provide helpful, accurate health information while maintaining appropriate medical disclaimers. Follow these guidelines:

1. **Safety First**: Always include medical disclaimers where appropriate. Remind users that this is not a substitute for professional medical advice.

2. **Emergency Situations**: If symptoms suggest a medical emergency, immediately advise seeking emergency medical care.

3. **Scope of Practice**: Provide general health information, not specific medical diagnoses or treatment recommendations.

4. **Evidence-Based**: Base responses on established medical knowledge and current best practices.

5. **Accessible Language**: Use clear, understandable language while maintaining medical accuracy.

6. **Comprehensive**: When discussing conditions, include symptoms, potential causes, general treatment approaches, and when to see a healthcare provider.

For the following categories, provide specialized responses:

**Symptom Checker**: List possible conditions, ask clarifying questions, emphasize the need for professional evaluation.

**Medication Information**: Provide uses, common side effects, general precautions, but emphasize consulting healthcare providers for personalized advice.

**Drug Interactions**: Explain potential interactions and their significance, recommend checking with pharmacists or doctors.

**Simple Explanations**: Use analogies and simple language appropriate for the requested comprehension level.

**Diet & Fitness**: Provide general guidelines based on current nutritional science, but recommend consulting nutritionists for personalized plans.

**Mental Wellness**: Offer evidence-based techniques while emphasizing professional mental health resources for serious concerns.

User Query: ${userInput}

Respond with helpful, accurate medical information while maintaining appropriate disclaimers and safety considerations.`;

            return medicalSystemPrompt;
        }

        // --- MONACO EDITOR INITIALIZATION ---
        
        function initializeMonaco() {
            require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.44.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                console.log('Monaco Editor loaded successfully');
            });
        }

        function createMonacoEditor(container, code, language) {
            return new Promise((resolve) => {
                require(['vs/editor/editor.main'], function () {
                    const editor = monaco.editor.create(container, {
                        value: code,
                        language: language,
                        theme: getMonacoTheme(),
                        fontSize: 14,
                        fontFamily: 'Fira Code, monospace',
                        minimap: { enabled: false },
                        scrollBeyondLastLine: false,
                        automaticLayout: true,
                        lineNumbers: 'on',
                        roundedSelection: false,
                        scrollbar: {
                            vertical: 'visible',
                            horizontal: 'visible'
                        },
                        wordWrap: 'on'
                    });
                    
                    const observer = new MutationObserver(() => {
                        editor.updateOptions({ theme: getMonacoTheme() });
                    });
                    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
                    
                    resolve(editor);
                });
            });
        }

        function getMonacoTheme() {
            switch (currentTheme) {
                case 'dark':
                case 'midnight':
                    return 'vs-dark';
                default:
                    return 'vs';
            }
        }

        // --- SMART SCROLLING FUNCTIONS ---
        
        function isAtBottom() {
            const scrollTop = chatMainArea.scrollTop;
            const scrollHeight = chatMainArea.scrollHeight;
            const clientHeight = chatMainArea.clientHeight;
            return scrollHeight - scrollTop - clientHeight < autoScrollThreshold;
        }

        function updateScrollState() {
            isUserScrolledUp = !isAtBottom();
            updateScrollButton();
        }

        function updateScrollButton() {
            if (isUserScrolledUp && isGenerating) {
                scrollToBottomBtn.classList.add('show');
            } else {
                scrollToBottomBtn.classList.remove('show');
            }
        }

        function scrollToBottomSmooth() {
            chatMainArea.scrollTo({
                top: chatMainArea.scrollHeight,
                behavior: 'smooth'
            });
            setTimeout(() => {
                isUserScrolledUp = false;
                updateScrollButton();
            }, 300);
        }

        function scrollToBottomInstant() {
            chatMainArea.scrollTop = chatMainArea.scrollHeight;
            isUserScrolledUp = false;
            updateScrollButton();
        }

        // Smoothly scrolls to the latest message when new content is appended
        function scrollToLatestMessage() {
            const lastMessage = chatContainer?.lastElementChild;
            if (!lastMessage || isUserScrolledUp) return;
            lastMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function initializeScrollHandling() {
            chatMainArea.addEventListener('scroll', () => {
                updateScrollState();
            });
            scrollToBottomBtn.addEventListener('click', scrollToBottomSmooth);
        }

        // --- THEME FUNCTIONS ---
        
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeDropdown();
            
            if (monacoEditor) {
                monacoEditor.updateOptions({ theme: getMonacoTheme() });
            }
        }

        function updateThemeDropdown() {
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                option.classList.toggle('active', option.dataset.theme === currentTheme);
            });
        }

        function handleThemeChange(newTheme) {
            setTheme(newTheme);
            themeDropdown.classList.remove('show');
            showNotification(`Theme changed to ${newTheme}`, 'success');
        }

        // --- ENHANCED FEATURES FUNCTIONS ---

        // === PROFILE SETTINGS ===
        function showProfileSettings() {
            // Load current user data
            document.getElementById('profile-name-input').value = currentUser.displayName || '';
            document.getElementById('profile-email-input').value = currentUser.email || '';
            document.getElementById('profile-password-input').value = '';
            
            // Load current avatar
            const currentAvatar = document.getElementById('current-avatar');
            if (currentUser.photoURL) {
                currentAvatar.innerHTML = `<img src="${currentUser.photoURL}" class="w-20 h-20 rounded-full">`;
            } else {
                const initial = (currentUser.displayName || 'A').charAt(0).toUpperCase();
                currentAvatar.innerHTML = initial;
            }
            
            // Load settings
            document.getElementById('language-select').value = userSettings.language;
            document.getElementById('font-size-select').value = userSettings.fontSize;
            document.getElementById('auto-save-toggle').classList.toggle('active', userSettings.autoSave);
            document.getElementById('sound-effects-toggle').classList.toggle('active', userSettings.soundEffects);
            document.getElementById('tts-autoplay-toggle').classList.toggle('active', userSettings.ttsAutoplay);
            // Deep Thinking toggle
            const deepToggle = document.getElementById('deep-thinking-toggle');
            if (deepToggle) deepToggle.classList.toggle('active', !!userSettings.deepThinking);
            
            profileSettingsModal.classList.remove('hidden');
        }

        function hideProfileSettings() {
            profileSettingsModal.classList.add('hidden');
        }

        async function saveProfileSettings() {
            const newName = document.getElementById('profile-name-input').value.trim();
            const newEmail = document.getElementById('profile-email-input').value.trim();
            const newPassword = document.getElementById('profile-password-input').value;
            
            try {
                // Update profile
                if (newName !== currentUser.displayName) {
                    await updateProfile(auth.currentUser, { displayName: newName });
                }
                
                // Update email (requires re-authentication in production)
                if (newEmail !== currentUser.email) {
                    await updateEmail(auth.currentUser, newEmail);
                }
                
                // Update password
                if (newPassword) {
                    await updatePassword(auth.currentUser, newPassword);
                }
                
                // Update user settings
                userSettings.language = document.getElementById('language-select').value;
                userSettings.fontSize = document.getElementById('font-size-select').value;
                userSettings.autoSave = document.getElementById('auto-save-toggle').classList.contains('active');
                userSettings.soundEffects = document.getElementById('sound-effects-toggle').classList.contains('active');
                userSettings.ttsAutoplay = document.getElementById('tts-autoplay-toggle').classList.contains('active');
                userSettings.deepThinking = document.getElementById('deep-thinking-toggle').classList.contains('active');
                
                // Apply font size setting
                applyFontSizeSetting(userSettings.fontSize);
                
                // Save to Firestore
                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                    ...currentUser,
                    displayName: newName,
                    email: newEmail,
                    settings: userSettings
                }, { merge: true });
                
                // Update current user
                currentUser = { ...currentUser, displayName: newName, email: newEmail };
                setupUserProfile(currentUser);
                
                hideProfileSettings();
                showNotification('Profile updated successfully', 'success');
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error updating profile: ' + error.message, 'error');
            }
        }

        function applyFontSizeSetting(fontSize) {
            const root = document.documentElement;
            switch (fontSize) {
                case 'small':
                    root.style.fontSize = '14px';
                    break;
                case 'large':
                    root.style.fontSize = '18px';
                    break;
                case 'extra-large':
                    root.style.fontSize = '20px';
                    break;
                default:
                    root.style.fontSize = '16px';
            }
        }

            // Global assistant instruction to keep responses general-purpose and use tools only when asked
            const SYSTEM_INSTRUCTION = `You are Chat@AI, a helpful general-purpose assistant. Always answer the user's request directly and completely (e.g., write code when asked, explain, reason, or summarize). Tools may be available for optional actions like scheduling; only call such tools when the user explicitly asks to schedule, set a reminder, or create an event. Do not claim your capabilities are limited to any single feature.`;

            // Build request payload for Gemini API. If deepThinking is enabled, include a thinking_budget
            function buildModelRequestPayload(contents) {
                const payload = { contents, systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] } };
                // If deep thinking is enabled, include a thinking_budget (in microseconds).
                // Increase this value for more complex reasoning (tradeoff: latency/cost).
                if (userSettings && userSettings.deepThinking) {
                    // 3 seconds budget as a reasonable default for deeper reasoning
                    payload.thinking_budget = { microseconds: 3000000 };
                }
                return payload;
            }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showNotification('Image must be smaller than 5MB', 'error');
                return;
            }
            
            try {
                // Show progress
                const progressContainer = document.getElementById('upload-progress-container');
                const progressFill = document.getElementById('upload-progress-fill');
                const progressPercent = document.getElementById('upload-progress-percent');
                progressContainer.classList.remove('hidden');
                
                const storageRef = ref(storage, `avatars/${currentUser.uid}_${Date.now()}`);
                const uploadTask = uploadBytesResumable(storageRef, file);
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Progress function
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressFill.style.width = progress + '%';
                        progressPercent.textContent = Math.round(progress) + '%';
                    }, 
                    (error) => {
                        // Error function
                        console.error('Upload error:', error);
                        showNotification('Error uploading avatar: ' + error.message, 'error');
                        progressContainer.classList.add('hidden');
                    }, 
                    async () => {
                        // Complete function
                        try {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            
                            await updateProfile(auth.currentUser, { photoURL: downloadURL });
                            
                            const currentAvatar = document.getElementById('current-avatar');
                            currentAvatar.innerHTML = `<img src="${downloadURL}" class="w-20 h-20 rounded-full">`;
                            
                            // Update profile avatar in header
                            profileAvatarContainer.innerHTML = `<img src="${downloadURL}" class="w-8 h-8 rounded-full">`;
                            
                            // Save to user data
                            currentUser.photoURL = downloadURL;
                            await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                                photoURL: downloadURL
                            }, { merge: true });
                            
                            progressContainer.classList.add('hidden');
                            showNotification('Avatar updated successfully', 'success');
                        } catch (error) {
                            console.error('Error updating profile with new photo:', error);
                            showNotification('Error updating avatar: ' + error.message, 'error');
                            progressContainer.classList.add('hidden');
                        }
                    }
                );
            } catch (error) {
                console.error('Error starting upload:', error);
                showNotification('Error uploading avatar: ' + error.message, 'error');
            }
        }

        // === PROMPT LIBRARY ===
        function showPromptLibrary() {
            promptLibraryModal.classList.remove('hidden');
            renderPromptLibrary();
        }

        function hidePromptLibrary() {
            promptLibraryModal.classList.add('hidden');
        }

        let currentTagFilter = 'all';
        function setupTagFilterBar() {
            const filterBar = document.getElementById('prompt-tag-filter-bar');
            if (!filterBar) return;
            const tags = getAllTags();
            filterBar.innerHTML = tags.map(tag => {
                const tagClass = tagColors[tag] || 'tag-other';
                const activeClass = tag === currentTagFilter ? 'active' : '';
                const tagValue = tag.charAt(0).toUpperCase() + tag.slice(1);
                return `<span class="tag-chip ${tagClass} ${activeClass}" data-tag-filter="${tag}">${tagValue}</span>`;
            }).join('');
            filterBar.onclick = (e) => {
                const chip = e.target.closest('.tag-chip');
                if (chip) { currentTagFilter = chip.dataset.tagFilter; renderPromptLibrary(); }
            };
        }

        function renderPromptLibrary() {
            const searchTerm = (document.getElementById('search-prompts')?.value || '').toLowerCase();
            const grid = document.getElementById('prompts-grid');
            setupTagFilterBar();

            let filteredPrompts = userPrompts.filter(prompt => {
                const promptText = (prompt.text || '').toLowerCase();
                const promptTitle = (prompt.title || '').toLowerCase();
                const promptTags = getPromptTags(prompt).map(t => t.toLowerCase());
                const matchesSearch = promptTitle.includes(searchTerm) || promptText.includes(searchTerm) || promptTags.join(' ').includes(searchTerm);
                const matchesTag = currentTagFilter === 'all' || promptTags.includes(currentTagFilter);
                return matchesSearch && matchesTag;
            });

            if (filteredPrompts.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full">
                        <div class="empty-state-container">
                            <div class="empty-state-animation">
                                <dotlottie-player src="https://lottie.host/a3b1f143-691a-4633-821f-818e3100c14b/6jK3jEIN2K.lottie" background="transparent" speed="1" autoplay loop></dotlottie-player>
                            </div>
                            <h3 class="empty-state-title">Your Prompt Library is Empty</h3>
                            <p class="empty-state-text">Create your first reusable prompt to get started.</p>
                            <button class="btn btn-primary" onclick="showAddPrompt()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>Add New Prompt</span>
                            </button>
                        </div>
                    </div>`;
                return;
            }

            grid.innerHTML = filteredPrompts.map(prompt => {
                const safeTitle = escapeHtml(prompt.title || 'Untitled Prompt');
                const safeText = escapeHtml(prompt.text || '');
                const safeDescription = escapeHtml(prompt.description || '');
                const tagsHtml = renderTagChips(getPromptTags(prompt));
                const lastUsedDate = prompt.lastUsed ? new Date((prompt.lastUsed.seconds ? prompt.lastUsed.seconds * 1000 : Date.parse(prompt.lastUsed))) : null;
                const lastUsed = lastUsedDate && !isNaN(lastUsedDate.getTime()) ? lastUsedDate.toLocaleDateString() : 'Never';
                const usageCount = prompt.usageCount || 0;
                const category = prompt.category ? prompt.category.charAt(0).toUpperCase() + prompt.category.slice(1) : 'General';
                const favoriteActive = prompt.isFavorite ? 'active' : '';
                const safeId = (prompt.id || '').replace(/'/g, "\\'");
                return `
                    <div class="prompt-card">
                        <div class="prompt-card-header">
                            <div>
                                <p class="prompt-card-title">${safeTitle}</p>
                                <p class="prompt-card-meta">${category}  Last Used: ${lastUsed}</p>
                            </div>
                            <button type="button" title="${prompt.isFavorite ? 'Unfavorite prompt' : 'Favorite prompt'}" class="prompt-favorite-btn ${favoriteActive}" onclick="togglePromptFavorite('${safeId}')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            </button>
                        </div>
                        <div class="prompt-card-preview">${safeText}</div>
                        <div class="prompt-card-tags">${tagsHtml}</div>
                        <div class="prompt-card-footer">
                            <div class="prompt-card-stats">
                                <span>Used ${usageCount}x</span>
                                ${safeDescription ? `<span>${safeDescription}</span>` : ''}
                            </div>
                            <div class="prompt-card-actions">
                                <button type="button" class="prompt-quick-btn use" onclick="usePrompt('${safeId}')">Use</button>
                                <button type="button" class="prompt-quick-btn secondary" onclick="editPrompt('${safeId}')">Edit</button>
                                <button type="button" class="prompt-quick-btn secondary" onclick="deletePrompt('${safeId}')">Delete</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        function showAddPrompt(editingId = null) {
            currentEditingPrompt = editingId;
            const title = document.getElementById('add-prompt-title');
            const form = document.getElementById('prompt-form');
            
            // Initialize tags field
            const tagsField = document.getElementById('prompt-tags');
            if (tagsField) tagsField.value = '';

            if (editingId) {
                title.textContent = 'Edit Prompt';
                const prompt = userPrompts.find(p => p.id === editingId);
                if (prompt) {
                    document.getElementById('prompt-title').value = prompt.title;
                    document.getElementById('prompt-category').value = prompt.category;
                    document.getElementById('prompt-text').value = prompt.text;
                    document.getElementById('prompt-description').value = prompt.description || '';
                    if (tagsField) tagsField.value = (prompt.tags || []).join(', ');
                }
            } else {
                title.textContent = 'Add New Prompt';
                form.reset();
            }
            
            addPromptModal.classList.remove('hidden');
        }

        function hideAddPrompt() {
            addPromptModal.classList.add('hidden');
            currentEditingPrompt = null;
        }

        // --- TTS and Code Execution Helpers ---
        // TTS generation: prefer API, fallback to Web Speech
        async function generateAndPlayTTS(text) {
            const voiceStyle = document.getElementById('tts-voice-style')?.value || '';
            if (API_KEY && TTS_API_URL && !API_KEY.includes('YOUR_API_KEY')) {
                try {
                    const payload = { input: text, voice_style: voiceStyle };
                    const resp = await fetch(`${TTS_API_URL}?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!resp.ok) throw new Error('TTS API error');
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const audio = new Audio(url);
                    await audio.play();
                    return true;
                } catch (err) {
                    console.warn('TTS API failed, falling back to Web Speech API', err);
                }
            }
            if ('speechSynthesis' in window) {
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = userSettings.language || 'en-US';
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utter);
                return true;
            }
            return false;
        }

        // Code execution stub
        async function executeUserCode(language, code) {
            try {
                const resp = await fetch(CODE_EXEC_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ language, code }) });
                if (!resp.ok) throw new Error('Code execution service error');
                const result = await resp.json();
                return result;
            } catch (err) {
                console.error('Code execution failed:', err);
                return { error: err.message };
            }
        }

        // URL Context helper
        async function fetchUrlContext(url) {
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Failed to fetch URL');
                const text = await resp.text();
                return text.slice(0, 20000);
            } catch (err) {
                console.error('URL fetch error:', err);
                return null;
            }
        }

        // Utility for escaping text in generated SVG
        function escapeHtml(str) {
            return (str + '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        async function savePrompt() {
            const title = document.getElementById('prompt-title').value.trim();
            const category = document.getElementById('prompt-category').value;
            const text = document.getElementById('prompt-text').value.trim();
            const description = document.getElementById('prompt-description').value.trim();
            const tagsInput = (document.getElementById('prompt-tags')?.value || '').trim();
            const tags = tagsInput.split(/[\s,]+/).filter(tag => tag.length > 0).map(tag => tag.toLowerCase());

            if (!title || !text) {
                showNotification('Title and Prompt Content are required', 'error');
                return;
            }

            try {
                const prompt = {
                    id: currentEditingPrompt || Date.now().toString(),
                    title,
                    category,
                    text,
                    description,
                    tags,
                    lastUsed: new Date(),
                    createdAt: userPrompts.find(p => p.id === currentEditingPrompt)?.createdAt || new Date()
                };

                if (currentEditingPrompt) {
                    const index = userPrompts.findIndex(p => p.id === currentEditingPrompt);
                    userPrompts[index] = prompt;
                } else {
                    userPrompts.push(prompt);
                }

                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), { prompts: userPrompts }, { merge: true });

                hideAddPrompt();
                renderPromptLibrary();
                showNotification(currentEditingPrompt ? 'Prompt updated' : 'Prompt saved', 'success');
            } catch (error) {
                console.error('Error saving prompt:', error);
                showNotification('Error saving prompt', 'error');
            }
        }

        async function deletePrompt(id) {
            if (!confirm('Are you sure you want to delete this prompt?')) return;
            
            try {
                userPrompts = userPrompts.filter(p => p.id !== id);
                
                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                    prompts: userPrompts
                }, { merge: true });
                
                renderPromptLibrary();
                showNotification('Prompt deleted', 'success');
            } catch (error) {
                console.error('Error deleting prompt:', error);
                showNotification('Error deleting prompt', 'error');
            }
        }

        function usePrompt(id) {
            const prompt = userPrompts.find(p => p.id === id);
            if (prompt) {
                chatInput.value = prompt.text;
                autoResizeTextarea(chatInput);
                updateSendButtonState();
                hidePromptLibrary();
                showNotification('Prompt loaded', 'success');
                chatInput.focus();
                trackPromptUsage(prompt);
            }
        }

        async function persistPrompts() {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                    prompts: userPrompts
                }, { merge: true });
            } catch (error) {
                console.error('Error persisting prompts:', error);
            }
        }

        async function trackPromptUsage(prompt) {
            if (!prompt) return;
            prompt.usageCount = (prompt.usageCount || 0) + 1;
            prompt.lastUsed = new Date();
            await persistPrompts();
            renderPromptLibrary();
        }

        async function togglePromptFavorite(id) {
            const prompt = userPrompts.find(p => p.id === id);
            if (!prompt) return;
            prompt.isFavorite = !prompt.isFavorite;
            await persistPrompts();
            renderPromptLibrary();
        }

        // Make functions globally available
        window.editPrompt = (id) => showAddPrompt(id);
        window.deletePrompt = deletePrompt;
        window.usePrompt = usePrompt;
        window.showAddPrompt = () => showAddPrompt();

        // === SCHEDULER ===
        function showScheduler() {
            schedulerModal.classList.remove('hidden');
            renderScheduledTasks();
        }

        function hideScheduler() {
            schedulerModal.classList.add('hidden');
        }

        function renderScheduledTasks() {
            const container = document.getElementById('scheduled-tasks');
            
            if (scheduledTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state-container">
                        <div class="empty-state-animation">
                            <dotlottie-player 
                                src="https://lottie.host/a3b1f143-691a-4633-821f-818e3100c14b/6jK3jEIN2K.lottie" 
                                background="transparent" 
                                speed="1" 
                                autoplay 
                                loop>
                            </dotlottie-player>
                        </div>
                        <h3 class="empty-state-title">No Scheduled Tasks</h3>
                        <p class="empty-state-text">
                            Schedule a prompt to run at a specific time.
                        </p>
                        <button class="btn btn-primary" onclick="showAddSchedule()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span>Schedule New Task</span>
                        </button>
                    </div>
                `;
                renderScheduleTimeline();
                return;
            }
            
            container.innerHTML = scheduledTasks.sort((a,b)=> (a.date||'').localeCompare(b.date||'')).map(task => {
                const nextRun = calculateNextRunTime(task);
                const statusColor = task.isActive ? 'text-theme-success' : 'text-theme-tertiary';
                const statusText = task.isActive ? 'Active' : 'Paused';
                const repeatDetails = task.repeat === 'weekly' ? (task.dayOfWeek || []).join(', ') : (task.repeat === 'monthly' ? `Day ${task.dayOfMonth}` : '');
                const toggleActiveClass = task.isActive ? 'active' : '';
                return `
                <div class="bg-theme-secondary p-4 rounded-xl shadow-lg border border-theme-primary/50 flex flex-col transition-all duration-300 hover:shadow-xl">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-lg font-semibold text-theme-primary">${task.name}</h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="w-2 h-2 rounded-full ${task.isActive ? 'bg-theme-success' : 'bg-theme-tertiary'}"></span>
                                <span class="text-sm ${statusColor}">${statusText} | ${(task.repeat || 'once').charAt(0).toUpperCase() + (task.repeat || 'once').slice(1)}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="task-toggle ${toggleActiveClass}" onclick="toggleTaskActive('${task.id}')">
                                <div class="task-toggle-circle"></div>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-theme-secondary mt-3 line-clamp-2">${task.prompt}</p>
                    <div class="flex justify-between items-center mt-4 border-t border-theme-primary/10 pt-3">
                        <div>
                            <span class="text-xs text-theme-tertiary">Next Run:</span>
                            <p class="font-bold text-theme-primary">${nextRun}</p>
                            <p class="text-xs text-theme-secondary">${repeatDetails}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button title="Duplicate Schedule" onclick="duplicateScheduledTask('${task.id}')" class="edit-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h12"/><path d="M4 11h12"/><path d="M4 15h9"/><path d="M16 9l5-5m0 0L16-1m5 5h-5v5"/></svg>
                            </button>
                            <button title="Edit Schedule" onclick="editScheduledTask('${task.id}')" class="edit-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                            </button>
                            <button title="Delete Schedule" onclick="deleteScheduledTask('${task.id}')" class="delete-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            renderScheduleTimeline();
        }

        function renderScheduleTimeline() {
            if (!scheduleTimeline) return;
            if (scheduledTasks.length === 0) {
                scheduleTimeline.innerHTML = '<p class="text-xs text-theme-quaternary">Add scheduled prompts to build a timeline.</p>';
                return;
            }
            const now = new Date();
            const todayKey = now.toISOString().split('T')[0];
            const timelineItems = scheduledTasks
                .map(task => {
                    const nextRun = task.date && task.time ? new Date(`${task.date} ${task.time}`) : null;
                    return { task, nextRun };
                })
                .filter(item => !item.nextRun || !isNaN(item.nextRun.getTime()))
                .sort((a, b) => ((a.nextRun?.getTime() || 0) - (b.nextRun?.getTime() || 0)));

            const filteredItems = timelineFilterMode === 'today'
                ? timelineItems.filter(item => item.nextRun && item.nextRun.toISOString().split('T')[0] === todayKey)
                : timelineItems;

            if (filteredItems.length === 0) {
                scheduleTimeline.innerHTML = '<p class="text-xs text-theme-quaternary">No events match the selected timeline filter.</p>';
                return;
            }

            scheduleTimeline.innerHTML = filteredItems.slice(0, 6).map(({ task, nextRun }) => {
                const nextLabel = nextRun ? nextRun.toLocaleString() : 'Scheduled';
                return `
                    <div class="timeline-card ${nextRun && nextRun >= now && nextRun <= new Date(now.getTime() + 86400000) ? 'is-next' : ''}">
                        <h4>${task.name}</h4>
                        <p class="timeline-meta">${nextLabel}</p>
                        <p class="timeline-meta text-xs">${escapeHtml((task.prompt || '').slice(0, 80))}${(task.prompt || '').length > 80 ? '' : ''}</p>
                    </div>`;
            }).join('');

            updateTimelineFilterLabel();
        }

        function pauseAllSchedules() {
            scheduledTasks.forEach(task => task.isActive = false);
            persistScheduledState('All schedules paused', 'info');
        }

        function resumeAllSchedules() {
            scheduledTasks.forEach(task => task.isActive = true);
            persistScheduledState('Schedules resumed', 'success');
        }

        function duplicateAllSchedules() {
            const clones = scheduledTasks.map(task => ({
                ...task,
                id: `task-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                name: `${task.name} Copy`,
                date: getNextScheduledDate(task),
                createdAt: new Date(),
                isActive: task.isActive
            }));
            scheduledTasks.push(...clones);
            persistScheduledState('Scheduled tasks duplicated', 'success');
        }

        function toggleTimelineFilterMode() {
            timelineFilterMode = timelineFilterMode === 'today' ? 'all' : 'today';
            renderScheduleTimeline();
        }

        function updateTimelineFilterLabel() {
            if (!viewTodaySchedulesBtn) return;
            viewTodaySchedulesBtn.textContent = timelineFilterMode === 'today' ? 'Show Full Timeline' : 'Focus Today';
        }

        function getNextScheduledDate(task) {
            const baseDate = task.date ? new Date(task.date) : new Date();
            baseDate.setDate(baseDate.getDate() + 1);
            return baseDate.toISOString().split('T')[0];
        }

        async function persistScheduledState(notificationMessage = 'Scheduled list updated', notificationType = 'success') {
            if (currentUser) {
                try {
                    await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                        scheduledTasks: scheduledTasks
                    }, { merge: true });
                } catch (error) {
                    console.error('Error updating scheduled tasks:', error);
                    showNotification('Error saving scheduled tasks', 'error');
                    return;
                }
            }
            renderScheduledTasks();
            showNotification(notificationMessage, notificationType);
        }

        function showAddSchedule(editingId = null) {
            currentEditingSchedule = editingId;
            const title = document.getElementById('add-schedule-modal').querySelector('.modal-header h2');
            const form = document.getElementById('schedule-form');
            const today = new Date().toISOString().split('T')[0];

            function activateTab(frequency) {
                document.querySelectorAll('.frequency-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.frequency === frequency);
                });
                document.querySelectorAll('.frequency-pane').forEach(pane => pane.classList.add('hidden'));
                if (frequency === 'once' || frequency === 'daily') {
                    document.getElementById('frequency-once-daily').classList.remove('hidden');
                    document.getElementById('schedule-repeat').value = frequency;
                } else if (frequency === 'weekly') {
                    document.getElementById('frequency-once-daily').classList.remove('hidden');
                    document.getElementById('frequency-weekly').classList.remove('hidden');
                    document.getElementById('schedule-repeat').value = frequency;
                } else if (frequency === 'monthly') {
                    document.getElementById('frequency-once-daily').classList.remove('hidden');
                    document.getElementById('frequency-monthly').classList.remove('hidden');
                    document.getElementById('schedule-repeat').value = frequency;
                }
            }

            const tabsContainer = document.getElementById('schedule-frequency-tabs');
            if (tabsContainer) {
                tabsContainer.onclick = (e) => {
                    const tab = e.target.closest('.frequency-tab');
                    if (tab) activateTab(tab.dataset.frequency);
                };
            }

            form.reset();
            document.querySelectorAll('.day-selector-btn').forEach(btn => btn.classList.remove('btn-primary', 'active'));
            document.getElementById('schedule-date').value = today;
            document.getElementById('schedule-time').value = '09:00';
            const dom = document.getElementById('schedule-day-of-month'); if (dom) dom.value = '1';
            activateTab('once');

            if (editingId) {
                title.textContent = 'Edit Scheduled Task';
                const task = scheduledTasks.find(t => t.id === editingId);
                if (task) {
                    document.getElementById('schedule-name').value = task.name;
                    document.getElementById('schedule-prompt').value = task.prompt;
                    if (task.date) document.getElementById('schedule-date').value = task.date;
                    if (task.time) document.getElementById('schedule-time').value = task.time;
                    activateTab(task.repeat || 'once');
                    document.getElementById('schedule-repeat').value = task.repeat || 'once';
                    if (task.dayOfMonth) {
                        const dom = document.getElementById('schedule-day-of-month'); if (dom) dom.value = task.dayOfMonth;
                    }
                    if (task.dayOfWeek && Array.isArray(task.dayOfWeek)) {
                        task.dayOfWeek.forEach(day => {
                            const btn = document.querySelector(`.day-selector-btn[data-day="${day}"]`);
                            if (btn) btn.classList.add('btn-primary', 'active');
                        });
                    }
                }
            } else {
                title.textContent = 'Schedule New Task';
            }

            addScheduleModal.classList.remove('hidden');
        }

        function hideAddSchedule() {
            addScheduleModal.classList.add('hidden');
            currentEditingSchedule = null;
        }

        async function saveScheduledTask() {
            const name = document.getElementById('schedule-name').value.trim();
            const prompt = document.getElementById('schedule-prompt').value.trim();
            const repeat = document.getElementById('schedule-repeat').value;

            let date, time, dayOfWeek = [], dayOfMonth;
            if (repeat === 'once' || repeat === 'daily' || repeat === 'weekly' || repeat === 'monthly' || repeat === 'none') {
                date = document.getElementById('schedule-date').value;
                time = document.getElementById('schedule-time').value;
            }
            if (repeat === 'weekly') {
                document.querySelectorAll('.day-selector-btn.active').forEach(btn => dayOfWeek.push(btn.dataset.day));
                if (dayOfWeek.length === 0) { showNotification('Please select at least one day for weekly tasks', 'error'); return; }
            } else if (repeat === 'monthly') {
                dayOfMonth = document.getElementById('schedule-day-of-month').value;
            }

            if (!name || !prompt || !date || !time) {
                showNotification('Please fill in all required fields (Name, Prompt, Date, Time)', 'error');
                return;
            }

            try {
                const task = {
                    id: currentEditingSchedule || Date.now().toString(),
                    name,
                    prompt,
                    date,
                    time,
                    repeat,
                    dayOfWeek: repeat === 'weekly' ? dayOfWeek : undefined,
                    dayOfMonth: repeat === 'monthly' ? dayOfMonth : undefined,
                    isActive: currentEditingSchedule ? scheduledTasks.find(t => t.id === currentEditingSchedule).isActive : true,
                    createdAt: scheduledTasks.find(t => t.id === currentEditingSchedule)?.createdAt || new Date()
                };

                if (currentEditingSchedule) {
                    const index = scheduledTasks.findIndex(t => t.id === currentEditingSchedule);
                    scheduledTasks[index] = task;
                } else {
                    scheduledTasks.push(task);
                }

                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), { scheduledTasks: scheduledTasks }, { merge: true });

                hideAddSchedule();
                renderScheduledTasks();
                showNotification(currentEditingSchedule ? 'Scheduled task updated' : 'Task scheduled', 'success');
            } catch (error) {
                console.error('Error saving scheduled task:', error);
                showNotification('Error saving scheduled task', 'error');
            }
        }

        async function deleteScheduledTask(id) {
            if (!confirm('Are you sure you want to delete this scheduled task?')) return;
            
            try {
                scheduledTasks = scheduledTasks.filter(t => t.id !== id);
                
                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                    scheduledTasks: scheduledTasks
                }, { merge: true });
                
                renderScheduledTasks();
                showNotification('Scheduled task deleted', 'success');
            } catch (error) {
                console.error('Error deleting scheduled task:', error);
                showNotification('Error deleting scheduled task', 'error');
            }
        }

        function scheduleTask(task) {
            const executionTime = new Date(`${task.date}T${task.time}`);
            const now = new Date();
            const delay = executionTime.getTime() - now.getTime();
            
            if (delay > 0) {
                setTimeout(() => {
                    executeScheduledTask(task);
                }, delay);
            }
        }

        async function executeScheduledTask(task) {
            try {
                // Auto-execute the scheduled prompt
                chatInput.value = task.prompt;
                await handleSendMessage();
                
                showNotification(`Scheduled task "${task.name}" executed`, 'success');
                
                // Handle repeat
                if (task.repeat === 'daily' || task.repeat === 'weekly' || task.repeat === 'monthly') {
                    const nextDate = getNextRepeatDate(task.date, task.repeat);
                    const updatedTask = { ...task, date: nextDate };
                    
                    const index = scheduledTasks.findIndex(t => t.id === task.id);
                    scheduledTasks[index] = updatedTask;
                    
                    await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                        scheduledTasks: scheduledTasks
                    }, { merge: true });
                    
                    scheduleTask(updatedTask);
                }
            } catch (error) {
                console.error('Error executing scheduled task:', error);
                showNotification('Error executing scheduled task', 'error');
            }
        }

        function getNextRepeatDate(currentDate, repeatType) {
            const date = new Date(currentDate);
            switch (repeatType) {
                case 'daily':
                    date.setDate(date.getDate() + 1);
                    break;
                case 'weekly':
                    date.setDate(date.getDate() + 7);
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + 1);
                    break;
            }
            return date.toISOString().split('T')[0];
        }

        // Make functions globally available
        window.editScheduledTask = (id) => showAddSchedule(id);
        window.deleteScheduledTask = deleteScheduledTask;
        window.showAddSchedule = () => showAddSchedule();

        // --- CORE FUNCTIONS ---
        
        function checkAPIStatus() {
            if (!API_KEY || API_KEY.includes('YOUR_API_KEY')) {
                 console.warn("API Key is missing. Please add your Google AI Gemini API key.");
                 showNotification("API Key is not configured.", "error");
            }
        }

        function showNotification(message, type = 'info') {
            // Only allow 'Welcome back' notification
            if (typeof message === 'string' && message.toLowerCase().includes('welcome back')) {
                notificationQueue.push({ message, type });
                processNotificationQueue();
            }
            // All other notifications are suppressed
        }
        
        function processNotificationQueue() {
            if (isNotificationVisible || notificationQueue.length === 0) return;
            isNotificationVisible = true;
            const { message, type } = notificationQueue.shift();
            notificationText.textContent = message;
            notification.className = `notification ${type}`;
            if (type === 'success') {
                notificationIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-success"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            } else if (type === 'error') {
                notificationIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-error"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            } else {
                notificationIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-accent"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>';
            }
            notification.classList.remove('hidden');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                    isNotificationVisible = false;
                    processNotificationQueue();
                }, 300);
            }, 3000);
        }

        function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const isPasswordProvider = user.providerData.some(p => p.providerId === 'password');
                    const isVerified = user.emailVerified || !isPasswordProvider; // Social providers are treated as verified

                    if (!isVerified) {
                        showVerifyEmailCard(user);
                        return;
                    }

                    // Verified users proceed to app
                    const userDocRef = doc(db, "artifacts", appId, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        currentUser = { 
                            ...user, 
                            ...userData,
                            displayName: user.displayName || userData.displayName || 'Anonymous User'
                        };

                        // Load user settings and data
                        userSettings = userData.settings || userSettings;
                        userPrompts = userData.prompts || [];
                        scheduledTasks = userData.scheduledTasks || [];

                        // Apply font size setting
                        applyFontSizeSetting(userSettings.fontSize);

                        // Schedule existing tasks
                        scheduledTasks.forEach(task => {
                            const taskDate = new Date(`${task.date}T${task.time}`);
                            if (taskDate > new Date()) {
                                scheduleTask(task);
                            }
                        });
                    } else {
                        const displayName = user.displayName || signupNameInput.value || "Anonymous";
                        const photoURL = user.photoURL || null;
                        await setDoc(userDocRef, {
                            displayName: displayName,
                            email: user.email,
                            photoURL: photoURL,
                            createdAt: new Date(),
                            settings: userSettings,
                            prompts: [],
                            scheduledTasks: []
                        });
                        currentUser = { ...user, displayName, photoURL };
                    }

                    hideVerifyEmailCard();
                    showChatApp();
                    setupUserProfile(currentUser);
                    await loadChatsFromFirestore();
                    showNotification(`Welcome back, ${currentUser.displayName || 'User'}!`, 'success');
                } else {
                    currentUser = null;
                    showAuthPage();
                    hideVerifyEmailCard();
                }
            });
        }
        
        function showAuthPage() {
            authPage.classList.remove('hidden');
            authPage.classList.add('flex');
            chatApp.classList.add('hidden');
            chatApp.classList.remove('flex');
        }

        function showVerifyEmailCard(user) {
            showAuthPage();
            if (loginForm) loginForm.classList.add('hidden');
            if (signupForm) signupForm.classList.add('hidden');
            if (verifyEmailCard) verifyEmailCard.classList.remove('hidden');
            if (verifyEmailAddress) verifyEmailAddress.textContent = user?.email || '';
        }

        function hideVerifyEmailCard() {
            if (verifyEmailCard) verifyEmailCard.classList.add('hidden');
            if (loginForm) loginForm.classList.remove('hidden');
        }

        function showChatApp() {
            authPage.classList.add('hidden');
            authPage.classList.remove('flex');
            chatApp.classList.remove('hidden');
            chatApp.classList.add('flex');
        }

        function setupUserProfile(user) {
            if (!user) return;
            profileEmail.textContent = user.email || 'No email provided';
            profileName.textContent = user.displayName || 'Anonymous User';

            // Profile button avatar
            if (user.photoURL) {
                profileAvatarContainer.innerHTML = `<img src="${user.photoURL}" class="w-8 h-8 rounded-full object-cover">`;
            } else {
                const initial = (user.displayName || 'A').charAt(0).toUpperCase();
                profileAvatarContainer.innerHTML = `<div class="w-8 h-8 rounded-full bg-theme-accent flex items-center justify-center font-bold text-theme-inverse">${initial}</div>`;
            }
            
            // Dropdown avatar 
            const dropdownAvatar = document.getElementById('dropdown-avatar');
            if (dropdownAvatar) {
                if (user.photoURL) {
                    dropdownAvatar.innerHTML = `<img src="${user.photoURL}" class="w-12 h-12 rounded-full object-cover">`;
                } else {
                    const initial = (user.displayName || 'A').charAt(0).toUpperCase();
                    dropdownAvatar.innerHTML = initial;
                }
            }
        }

        function showWelcomeContent() {
            const welcomeHtml = `
                <div class="welcome-card rounded-2xl p-8 mb-6 text-center">
                    <div class="w-20 h-20 bg-theme-accent rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                       <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-20 h-20 rounded-full shadow-lg" />
                    </div>
                    <h2 class="text-3xl font-bold text-theme-primary mb-4">Welcome to Chat@AI</h2>
                    <p class="text-theme-secondary text-lg mb-6">Your intelligent AI assistant with enhanced features. Organize chats, save prompts, schedule tasks!</p>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-theme-primary mb-4">Try these examples:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                           <button class="suggestion-card" data-suggestion="Visualize this python code:\n\nx = 5\nitems = [1, 2, 3]\nfor i in range(x):\n  items.append(i * 2)\nprint(items)">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><circle cx="12" cy="12" r="10"/><path d="m10 8 6 4-6 4z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Visualize Python code</span>
                             </div>
                           </button>
                           <button class="suggestion-card" data-suggestion="Create a study schedule for learning JavaScript in 30 days">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                                </div>
                                <span class="text-theme-secondary">Create study schedule</span>
                             </div>
                           </button>
                           <button class="suggestion-card" data-suggestion="Help me organize my project tasks and create a productivity system">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2Z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Organize projects</span>
                             </div>
                           </button>
                           <button class="suggestion-card" data-suggestion="Generate a JavaScript bar chart showing the population of the 5 largest cities in India.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-rose-500/20 rounded-lg flex items-center justify-center">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-rose-400"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                                </div>
                                <span class="text-theme-secondary">Visualize data</span>
                             </div>
                           </button>
                        </div>
                    </div>
                </div>`;
            chatContainer.innerHTML = welcomeHtml;
            exportBtn.disabled = true;
        }

        function fillSuggestion(text) {
            chatInput.value = text;
            autoResizeTextarea(chatInput);
            updateSendButtonState();
            chatInput.focus();
        };

        async function handleLogin(e) {
            e.preventDefault();
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            toggleButtonLoading(submitBtn, true);

            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                if (loginRemember) {
                    await setPersistence(auth, loginRemember.checked ? browserLocalPersistence : browserSessionPersistence);
                }
                await signInWithEmailAndPassword(auth, email, password);
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Login error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            } finally {
                toggleButtonLoading(submitBtn, false);
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            if(!validateForm()) return;

            const submitBtn = signupForm.querySelector('button[type="submit"]');
            toggleButtonLoading(submitBtn, true);

            const fullName = signupNameInput.value.trim();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: fullName });
                await sendEmailVerification(userCredential.user);
                authError.classList.add('hidden');
                
                // Show signup success animation
                showSignupSuccessAnimation();
                showVerifyEmailCard(userCredential.user);
                
            } catch (error) {
                console.error("Signup error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            } finally {
                toggleButtonLoading(submitBtn, false);
            }
        }

        async function handleForgotPassword(e) {
            e?.preventDefault?.();
            try {
                const prefilled = document.getElementById('login-email')?.value || '';
                const email = prefilled || window.prompt('Enter your account email to reset password:');
                if (!email) return;
                await sendPasswordResetEmail(auth, email);
                showNotification('Password reset email sent', 'success');
            } catch (error) {
                console.error('Password reset error', error);
                showNotification(getFriendlyAuthError(error), 'error');
            }
        }

        async function handleGoogleSignin() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Google sign-in error', error);
                showNotification(getFriendlyAuthError(error), 'error');
            }
        }

        async function handleResendVerification() {
            try {
                if (auth.currentUser) {
                    await sendEmailVerification(auth.currentUser);
                    showNotification('Verification email resent', 'success');
                }
            } catch (error) {
                console.error('Resend verification error', error);
                showNotification(getFriendlyAuthError(error), 'error');
            }
        }

        async function handleRefreshVerification() {
            try {
                if (auth.currentUser) {
                    await reload(auth.currentUser);
                    if (auth.currentUser.emailVerified) {
                        hideVerifyEmailCard();
                        checkAuthState();
                        return;
                    }
                }
                showNotification('Email not verified yet. Please check your inbox.', 'warning');
            } catch (error) {
                console.error('Refresh verification error', error);
                showNotification(getFriendlyAuthError(error), 'error');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                allChats = {};
                currentChatId = null;
                chatContainer.innerHTML = '';
                historyList.innerHTML = '';
                isMedicalMode = false;
                medicalModeIndicator.classList.add('hidden');
                medicalAiBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                medicalAiBtn.classList.remove('bg-green-800', 'hover:bg-green-900');
                chatAiBtn.classList.add('hidden');
                if (isTTSActive) {
                    stopTTS();
                }
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                console.error("Logout error", error);
                showNotification('Error logging out', 'error');
            }
        }

        function handleHome() {
            // Navigate to index.html or reload the current page
            window.location.href = 'index.html';
        }

        function getFriendlyAuthError(error) {
            switch(error.code) {
                case 'auth/invalid-email': return 'Please enter a valid email address.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Invalid email or password. Please try again.';
                case 'auth/email-already-in-use': return 'This email is already registered. Please log in.';
                case 'auth/weak-password': return 'Password is too weak. Please use at least 6 characters.';
                case 'auth/too-many-requests': return 'Too many attempts. Please try again later.';
                case 'auth/network-request-failed': return 'Network error. Check your internet connection and try again.';
                case 'auth/popup-closed-by-user': return 'Sign-in popup closed before completing. Please try again.';
                case 'auth/popup-blocked': return 'Popup blocked by the browser. Allow popups and retry.';
                case 'auth/operation-not-allowed': return 'This authentication method is disabled for this project.';
                default: return 'An unexpected error occurred. Please try again.';
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(`${inputId}-toggle`);
            const icon = button.querySelector('svg');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 013.542-5.45m5.545-2.271A10.02 10.02 0 0112 5c4.478 0 8.268 2.943 9.542 7a10.02 10.02 0 01-1.343 2.596m-3.41-3.41a3 3 0 11-4.243-4.243" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />`;
            } else {
                input.type = 'password';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`;
            }
        }

        function updatePasswordStrength() {
            const password = signupPasswordInput.value;
            let strength = 0;
            if (password.length > 5) strength++;
            if (password.length > 7) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;

            let color = 'bg-theme-quaternary';
            if (strength <= 2) color = 'bg-theme-error';
            else if (strength <= 4) color = 'bg-theme-warning';
            else color = 'bg-theme-success';

            passwordStrengthBar.className = `rounded-full ${color}`;
            passwordStrengthBar.style.width = `${(strength / 5) * 100}%`;
            validatePassword();
        }

        function validateEmail() {
            const email = signupEmailInput.value;
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if (!re.test(String(email).toLowerCase())) {
                emailError.textContent = 'Please enter a valid email address.';
                emailError.classList.remove('hidden');
                return false;
            }
            emailError.classList.add('hidden');
            return true;
        }

        function validatePassword() {
            const password = signupPasswordInput.value;
            if (password.length < 6) {
                passwordError.textContent = 'Password must be at least 6 characters long.';
                passwordError.classList.remove('hidden');
                return false;
            }
            passwordError.classList.add('hidden');
            return true;
        }

        function validatePasswordConfirm() {
            const password = signupPasswordInput.value;
            const confirm = signupPasswordConfirmInput?.value || '';
            if (!confirm) {
                passwordConfirmError?.classList.add('hidden');
                return false;
            }
            if (password !== confirm) {
                if (passwordConfirmError) {
                    passwordConfirmError.textContent = 'Passwords do not match.';
                    passwordConfirmError.classList.remove('hidden');
                }
                return false;
            }
            passwordConfirmError?.classList.add('hidden');
            return true;
        }

        function validateForm() {
            const isEmailValid = validateEmail();
            const isPasswordValid = validatePassword();
            const isNameValid = signupNameInput.value.trim() !== '';
            const isConfirmValid = validatePasswordConfirm();
            const acceptedTerms = signupTermsCheckbox?.checked === true;
            if (!acceptedTerms) {
                authError.textContent = 'Please agree to the Terms and Privacy Policy to continue.';
                authError.classList.remove('hidden');
                return false;
            } else {
                authError.classList.add('hidden');
            }
            return isEmailValid && isPasswordValid && isNameValid && isConfirmValid && acceptedTerms;
        }

        function toggleButtonLoading(button, isLoading) {
            const buttonText = button.querySelector('.button-text');
            const loader = button.querySelector('.button-loader');
            button.disabled = isLoading;
            if (isLoading) {
                buttonText.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                const extension = '.' + file.name.split('.').pop();
                const language = fileExtensionMap[extension];

                if (language) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const codeContent = event.target.result;
                        showCodeVisualizationModal(codeContent, language);
                    };
                    reader.readAsText(file);
                    continue; // skip adding to attachments
                }

                // handle text files specially to preserve text content
                if (file.type === "text/plain" || file.type === "text/csv") {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const textContent = event.target.result;
                        const fileId = `file-${Date.now()}-${Math.random().toString(36).slice(2,9)}`;
                        attachedFiles.push({ id: fileId, base64: btoa(textContent), mimeType: "text/plain", name: file.name });
                        displayFilePreview();
                        updateSendButtonState();
                    };
                    reader.readAsText(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64Data = event.target.result.split(',')[1];
                        const fileId = `file-${Date.now()}-${Math.random().toString(36).slice(2,9)}`;
                        attachedFiles.push({ id: fileId, base64: base64Data, mimeType: file.type, name: file.name });
                        displayFilePreview();
                        updateSendButtonState();
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Clear input so same files can be selected again if needed
            fileInput.value = '';
        }

        function displayFilePreview() {
            if (!attachedFiles || attachedFiles.length === 0) {
                filePreviewContainer.style.display = 'none';
                filePreview.innerHTML = '';
                return;
            }

            filePreview.innerHTML = '';
            for (const file of attachedFiles) {
                let previewHtml = '';
                if (file.mimeType.startsWith('image/')) {
                    previewHtml = `<img src="data:${file.mimeType};base64,${file.base64}" alt="${file.name}" class="max-h-20 rounded object-cover">`;
                } else if (file.mimeType.startsWith('audio/')) {
                    previewHtml = `<div class="p-2 text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-theme-tertiary" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" /></svg><p class="text-xs truncate w-20">${file.name}</p></div>`;
                } else if (file.mimeType.startsWith('video/')) {
                    previewHtml = `<video class="max-h-20 rounded" src="data:${file.mimeType};base64,${file.base64}"></video>`;
                } else {
                    previewHtml = `<div class="p-2 text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-theme-tertiary" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><p class="text-xs truncate w-20">${file.name}</p></div>`;
                }

                const previewWrapper = document.createElement('div');
                previewWrapper.className = 'relative flex items-center justify-center bg-theme-tertiary rounded-lg h-24 w-24 overflow-hidden';
                previewWrapper.innerHTML = `
                    ${previewHtml}
                    <button type="button" class="absolute top-0 right-0 m-1 bg-theme-error text-theme-inverse rounded-full w-5 h-5 flex items-center justify-center border-2 border-theme-secondary opacity-80 hover:opacity-100" title="Remove file" data-file-id="${file.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                `;

                filePreview.appendChild(previewWrapper);
            }

            filePreviewContainer.style.display = 'block';
        }

        function removeAttachedFile(fileId) {
            if (fileId) {
                attachedFiles = attachedFiles.filter(f => f.id !== fileId);
            } else {
                attachedFiles = [];
                fileInput.value = '';
            }
            displayFilePreview();
            updateSendButtonState();
        }

        // --- Tool Definitions for Gemini API (in-file) ---
        const toolConfig = {
            functionDeclarations: [
                {
                    name: "createScheduledTask",
                    description: "Schedules a new task, reminder, or event for the user. Only call this tool if the user explicitly asks to schedule something, set a reminder, add to calendar, or create an event. For all other requests (e.g., coding help, Q&A, drafting), do not call this tool.",
                    parameters: {
                        type: "OBJECT",
                        properties: {
                            name: { type: "STRING", description: "A short, descriptive name for the task or reminder." },
                            prompt: { type: "STRING", description: "The full prompt or content of the task the user wants to be reminded of." },
                            date: { type: "STRING", description: "The date for the task in 'YYYY-MM-DD' format." },
                            time: { type: "STRING", description: "The time for the task in 24-hour 'HH:MM' format." }
                        },
                        required: ["name", "prompt", "date", "time"]
                    }
                }
            ]
        };

        // Heuristic to decide whether to expose the scheduler tool to the model
        function shouldOfferSchedulerTool(text = '') {
            try {
                const t = String(text).toLowerCase();
                const keywords = ['remind', 'reminder', 'schedule', 'scheduling', 'calendar', 'event', 'appointment', 'meeting', 'alert'];
                if (keywords.some(k => t.includes(k))) return true;
                // Phrases indicating explicit scheduling intent
                const intentRegex = /(set (an )?alarm|add to (my )?calendar|create (an )?event|schedule (it|this))/i;
                if (intentRegex.test(text)) return true;
            } catch {}
            return false;
        }

        /**
         * Creates a scheduled task directly from AI-provided arguments.
         * Uses the existing `scheduledTasks`, `scheduleTask`, `renderScheduledTasks`, and Firestore `setDoc` logic in this file.
         */
        async function handleAiScheduleTask(args) {
            const { name, prompt, date, time } = args || {};

            if (!name || !prompt || !date || !time) {
                return { error: 'Missing required fields. All fields are required: name, prompt, date, time.' };
            }

            const task = {
                id: Date.now().toString(),
                name,
                prompt,
                date,
                time,
                repeat: 'none',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                // Add to local state
                scheduledTasks.push(task);
                // Schedule execution
                scheduleTask(task);

                // Persist to Firestore (uses the same pattern elsewhere in this file)
                if (currentUser) {
                    await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                        scheduledTasks: scheduledTasks
                    }, { merge: true });
                } else {
                    // Fallback: localStorage
                    localStorage.setItem('scheduledTasks', JSON.stringify(scheduledTasks));
                }

                // Re-render if the scheduled tasks UI is open
                if (typeof renderScheduledTasks === 'function') renderScheduledTasks();

                return { success: true, taskId: task.id, message: `Task '${name}' scheduled for ${date} at ${time}.` };
            } catch (error) {
                console.error('Error saving AI scheduled task:', error);
                return { error: `Failed to save task: ${error?.message || String(error)}` };
            }
        }

        async function handleSendMessage(e) {
            if(e) e.preventDefault();
            const userInput = chatInput.value.trim();

            const vizRegex = /^visualize this (\w+\+*\w*) code:/i;
            const match = userInput.match(vizRegex);
            if (match) {
                const language = match[1].toLowerCase();
                const code = userInput.substring(match[0].length).trim();
                if (vizLanguages.includes(language)){
                    showCodeVisualizationModal(code, language);
                    chatInput.value = '';
                    autoResizeTextarea(chatInput);
                    updateSendButtonState();
                    return;
                }
            }

            if ((!userInput && (!attachedFiles || attachedFiles.length === 0)) || !currentUser) return;

            if (!API_KEY || API_KEY.includes('YOUR_API_KEY')) {
                appendMessage("`Error`: API Key is missing.\n\nPlease add your Google AI Gemini API key in the script section to enable chat functionality.", 'model-error');
                return;
            }

            if (chatContainer.querySelector('.welcome-card')) {
                chatContainer.innerHTML = '';
            }

            toggleForm(false);
            generationControls.classList.remove('hidden');
            stopGenerationFlag = false;
            isGenerating = true;
            updateScrollButton();

            if (!currentChatId) {
                try {
                     const title = userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '');
                     const timestamp = new Date();
                     const newChatRef = await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"), {
                        title: title || 'Multimedia Chat',
                        createdAt: timestamp,
                        isMedical: isMedicalMode
                    });
                    currentChatId = newChatRef.id;
                    allChats[currentChatId] = { 
                        id: currentChatId, 
                        createdAt: { toDate: () => timestamp },  // Make it compatible with Firestore timestamp
                        title: title || 'Multimedia Chat', 
                        messages: [],
                        isMedical: isMedicalMode
                    };
                    renderHistorySidebar();
                } catch (error) {
                    console.error("Error creating new chat:", error);
                    appendMessage("Error: Could not start a new chat session.", "model-error");
                    toggleForm(true);
                    generationControls.classList.add('hidden');
                    isGenerating = false;
                    updateScrollButton();
                    return;
                }
            }

            const messageParts = [];
            const filesForMessage = [...attachedFiles]; // copy

            for (const file of filesForMessage) {
                messageParts.push({
                    inlineData: {
                        mimeType: file.mimeType,
                        data: file.base64
                    }
                });
            }

            let finalUserInput = userInput;
            if (isMedicalMode && userInput) {
                finalUserInput = createMedicalPrompt(userInput);
            }

            if (finalUserInput) {
                messageParts.push({ text: finalUserInput });
            }

            // Display the user message with the files attached
            appendMessage({ text: userInput, files: filesForMessage }, 'user');

            const timestamp = new Date();
            const userMessage = { role: 'user', parts: messageParts, timestamp: { toDate: () => timestamp } };
            allChats[currentChatId].messages.push(userMessage);
            const firestoreMessage = { role: 'user', parts: [{text: userInput || `[Sent ${filesForMessage.length} file(s)]`}], timestamp: timestamp };
            await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), firestoreMessage);

            if(allChats[currentChatId].messages.length === 1) {
                const newTitle = userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '');
                await updateDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId), { title: newTitle || `Chat about ${filesForMessage[0]?.name}` });
                allChats[currentChatId].title = newTitle || `Chat about ${filesForMessage[0]?.name}`;
                renderHistorySidebar();
            }

            chatInput.value = '';
            // clear attachments
            attachedFiles = [];
            displayFilePreview();
            autoResizeTextarea(chatInput);
            updateSendButtonState();
            appendLoadingIndicator();

            if (!isUserScrolledUp) {
                scrollToBottomInstant();
            }

            // --- NEW: Tool Use Logic ---
            try {
                let apiMessages = allChats[currentChatId].messages.map(({ role, parts }) => ({ role, parts }));

                // First call: include tools to let the model decide whether to call a function
                const firstPayload = buildModelRequestPayload(apiMessages);
                // Only expose the scheduler tool if the user's latest input suggests scheduling intent
                if (shouldOfferSchedulerTool(userInput)) {
                    firstPayload.tools = [toolConfig];
                }

                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(firstPayload),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error?.message || 'An unknown API error occurred.');
                }

                const data = await response.json();
                const modelResponsePart = data.candidates?.[0]?.content?.parts?.[0];

                if (modelResponsePart && modelResponsePart.functionCall) {
                    // --- PATH A: AI wants to use a tool ---
                    const functionCall = modelResponsePart.functionCall;
                    const functionName = functionCall.name;
                    let functionArgs = functionCall.args;
                    if (typeof functionArgs === 'string') {
                        try { functionArgs = JSON.parse(functionArgs); } catch (e) { /* leave as-is */ }
                    }

                    let functionResult;

                    // Add AI "thought" to history
                    allChats[currentChatId].messages.push({ role: 'model', parts: [modelResponsePart], timestamp: new Date() });

                    if (functionName === 'createScheduledTask') {
                        functionResult = await handleAiScheduleTask(functionArgs);
                    } else {
                        functionResult = { error: `Unknown tool requested: ${functionName}` };
                    }

                    // 2. Second API Call (Sending Function Response)
                    const functionResponsePart = { functionResponse: { name: functionName, response: functionResult } };
                    allChats[currentChatId].messages.push({ role: 'user', parts: [functionResponsePart], timestamp: new Date() });

                    // Get updated messages and ask model for final natural language reply
                    apiMessages = allChats[currentChatId].messages.map(({ role, parts }) => ({ role, parts }));

                    const finalResponse = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(buildModelRequestPayload(apiMessages)),
                    });

                    if (!finalResponse.ok) {
                        const errorData = await finalResponse.json().catch(() => null);
                        throw new Error(errorData?.error?.message || 'Error getting final AI response.');
                    }

                    const finalData = await finalResponse.json();
                    const aiResponseText = finalData.candidates?.[0]?.content?.parts?.[0]?.text;

                    removeLoadingIndicator();
                    if (aiResponseText) {
                        const messageId = appendMessage({text: ''}, 'model');
                        const messageElement = document.getElementById(messageId);
                        const contentContainer = messageElement.querySelector('.prose');
                        const finalText = await streamResponseSafe(contentContainer, aiResponseText, messageId);

                        enhanceResponseMessage(messageElement, finalText);

                        // Save final text response to history
                        const aiMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                        allChats[currentChatId].messages.push(aiMessage);
                        await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);
                    } else {
                        appendMessage({text: "I've processed your request but have nothing more to say."}, 'model-error');
                    }

                } else if (modelResponsePart && modelResponsePart.text) {
                    // --- PATH B: AI just sends text (Normal) ---
                    removeLoadingIndicator();
                    const aiResponseText = modelResponsePart.text;

                    const messageId = appendMessage({text: ''}, 'model');
                    const messageElement = document.getElementById(messageId);
                    const contentContainer = messageElement.querySelector('.prose');

                        const finalText = await streamResponseSafe(contentContainer, aiResponseText, messageId);
                    enhanceResponseMessage(messageElement, finalText);

                    const aiMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                    allChats[currentChatId].messages.push(aiMessage);
                    await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);

                    if (userSettings.ttsAutoplay) {
                        const ttsButton = messageElement.querySelector('.tts-button');
                        if (ttsButton) setTimeout(() => handleTTSButtonClick(ttsButton, finalText), 500);
                    }

                } else {
                    // Handle empty or unexpected response
                    removeLoadingIndicator();
                    appendMessage({text: "I couldn't generate a response. The response was empty."}, 'model-error');
                }
            } catch (error) {
                console.error("Error fetching AI response:", error);
                removeLoadingIndicator();
                appendMessage({text: `Error: ${error.message}`}, 'model-error');
                showNotification('Error generating response', 'error');
            } finally {
                generationControls.classList.add('hidden');
                toggleForm(true);
                isGenerating = false;
                updateScrollButton();
            }
        }

        // Markdown helpers to avoid truncated or invisible output
        function fixUnclosedCodeFences(md) {
            try {
                const count = (md.match(/```/g) || []).length;
                if (count % 2 !== 0) return md + "\n```\n";
            } catch {}
            return md;
        }
        function escapeHtmlOutsideCode(md) {
            try {
                const parts = md.split(/(```[\s\S]*?```)/g);
                return parts.map(p => p.startsWith('```') ? p : p.replace(/</g,'&lt;').replace(/>/g,'&gt;')).join('');
            } catch { return md; }
        }
        function prepMarkdown(md) { return escapeHtmlOutsideCode(fixUnclosedCodeFences(md)); }

        function appendMessage(content, sender) {
            const messageId = `msg-${sender}-${Date.now()}`;
            const { text, files } = typeof content === 'object' ? content : { text: content, files: [] };

            let fileHtml = '';
            if (files && files.length > 0) {
                fileHtml = '<div class="flex flex-wrap gap-2 mb-2">';
                for (const file of files) {
                    if (file.mimeType.startsWith('image/')) {
                        fileHtml += `<img src="data:${file.mimeType};base64,${file.base64}" alt="${file.name}" class="max-h-32 md:max-h-48 rounded-lg object-contain">`;
                    } else if (file.mimeType.startsWith('audio/')) {
                        fileHtml += `<div class="w-full"><p class="text-xs mb-1">${file.name}</p><audio controls src="data:${file.mimeType};base64,${file.base64}" class="w-full"></audio></div>`;
                    } else if (file.mimeType.startsWith('video/')) {
                        fileHtml += `<video controls class="max-h-32 md:max-h-48 rounded-lg" src="data:${file.mimeType};base64,${file.base64}"></video>`;
                    } else {
                        fileHtml += `<div class="text-sm p-2 bg-black/10 rounded">${file.name}</div>`;
                    }
                }
                fileHtml += '</div>';
            }

            const isModel = sender === 'model' || sender === 'model-error';
            const isUser = sender === 'user';
            
            let userAvatarHtml = '';
            if (isUser && currentUser) {
                if(currentUser.photoURL) {
                    userAvatarHtml = `<img src="${currentUser.photoURL}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full">`;
                } else {
                    const initial = (currentUser.displayName || 'A').charAt(0).toUpperCase();
                    userAvatarHtml = `<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-theme-tertiary flex items-center justify-center font-bold text-theme-primary flex-shrink-0">${initial}</div>`;
                }
            }
            
            const isError = sender === 'model-error';
            let modelIconHtml = `<div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full ${isError ? 'bg-theme-error' : 'bg-theme-accent'} flex items-center justify-center shadow-md"><img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full shadow-md" /></div>`;
            
            if (isMedicalMode && !isError) {
                modelIconHtml = `<div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-green-600 flex items-center justify-center shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                        <path d="M12 5L8 21l4-7 4 7-4-16"/>
                    </svg>
                </div>`;
            }

            // --- Advanced contextual spacing logic ---
            let className = `chat-message flex items-start gap-2 sm:gap-3 ${isUser ? 'justify-end user' : 'model'}`;
            const lastMessage = chatContainer.lastElementChild;
            if (lastMessage && !lastMessage.classList.contains('loading-indicator')) {
                const lastMessageRole = lastMessage.classList.contains('user') ? 'user' : 'model';
                if (isModel && lastMessageRole === 'model') {
                    className += ' continuation';
                }
            }
            const messageBubbleClasses = isUser ? 'bg-theme-accent text-theme-inverse' : (isError ? 'bg-theme-error/10' : 'bg-theme-secondary');
            const messageHtml = `
            <div id="${messageId}" class="${className}">
                ${!isUser ? `<div class="flex-shrink-0">${modelIconHtml}</div>` : ''}
                <div class="rounded-lg p-3 sm:p-4 max-w-3xl shadow-lg min-w-0 ${messageBubbleClasses}">
                    ${fileHtml}
                    <div class="prose max-w-none ${isUser ? 'text-theme-inverse' : 'text-theme-primary'}">
                        ${marked.parse(text ? prepMarkdown(text) : '')}
                    </div>
                    <div class="action-buttons"></div>
                </div>
                ${isUser ? `<div class="flex-shrink-0">${userAvatarHtml}</div>` : ''}
            </div>`;

            chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            const messageElement = document.getElementById(messageId);

            if (isModel && text) {
                const contentContainer = messageElement.querySelector('.prose');
                makeTablesResponsive(contentContainer);
                enhanceCodeBlocks(messageId);
            }

            if (isUser) {
                addUserActionButtons(messageElement, text);
            }

            scrollToLatestMessage();
            
            return messageId;
        }

        function addUserActionButtons(messageElement, text) {
            const actionContainer = messageElement.querySelector('.action-buttons');
            if (!actionContainer) return;

            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn';
            editBtn.title = "Edit message";
            editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
            editBtn.onclick = () => handleEditMessage(messageElement, text);
            actionContainer.appendChild(editBtn);

            const copyBtn = document.createElement('button');
            copyBtn.title = "Copy";
            copyBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>
                <span class="copy-feedback">Copied!</span>
            `;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(text);
                const feedback = copyBtn.querySelector('.copy-feedback');
                feedback.classList.add('show');
                setTimeout(() => feedback.classList.remove('show'), 2000);
            };
            actionContainer.appendChild(copyBtn);
        }

        async function handleEditMessage(messageElement, originalText) {
            const messageId = messageElement.id;
            const contentContainer = messageElement.querySelector('.prose');
            const actionContainer = messageElement.querySelector('.action-buttons');
            
            actionContainer.style.display = 'none';
            
            const editContainer = document.createElement('div');
            editContainer.innerHTML = `
                <textarea class="edit-textarea">${originalText}</textarea>
                <div class="edit-buttons">
                    <button class="edit-cancel-btn">Cancel</button>
                    <button class="edit-save-btn">Save & Regenerate</button>
                </div>
            `;
            
            contentContainer.replaceWith(editContainer);
            const textarea = editContainer.querySelector('.edit-textarea');
            const cancelBtn = editContainer.querySelector('.edit-cancel-btn');
            const saveBtn = editContainer.querySelector('.edit-save-btn');
            
            textarea.focus();
            textarea.select();
            
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            });
            
            cancelBtn.onclick = () => {
                const newContentContainer = document.createElement('div');
                newContentContainer.className = 'prose max-w-none text-theme-inverse';
                newContentContainer.innerHTML = marked.parse(originalText);
                editContainer.replaceWith(newContentContainer);
                actionContainer.style.display = 'flex';
            };
            
            saveBtn.onclick = async () => {
                const newText = textarea.value.trim();
                if (!newText) {
                    showNotification('Message cannot be empty', 'error');
                    return;
                }
                
                if (newText === originalText) {
                    cancelBtn.click();
                    return;
                }
                
                try {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                    
                    await regenerateFromMessage(messageId, newText);
                    showNotification('Message updated and regenerated', 'success');
                } catch (error) {
                    console.error('Error regenerating:', error);
                    showNotification('Error regenerating response', 'error');
                    cancelBtn.click();
                }
            };
        }

        async function regenerateFromMessage(messageId, newText) {
            if (!currentChatId || !currentUser) return;
            
            const currentMessages = allChats[currentChatId].messages || [];
            let messageIndex = -1;
            
            for (let i = 0; i < currentMessages.length; i++) {
                const message = currentMessages[i];
                if (message.role === 'user') {
                    const textPart = message.parts.find(p => p.text);
                    if (textPart && messageId.includes('user')) {
                        messageIndex = i;
                        break;
                    }
                }
            }
            
            if (messageIndex === -1) return;
            
            const messagesToRemove = currentMessages.splice(messageIndex);
            
            const allMessageElements = chatContainer.querySelectorAll('.chat-message');
            let userMessageCount = 0;
            for (let i = 0; i < allMessageElements.length; i++) {
                const element = allMessageElements[i];
                if (element.classList.contains('user')) {
                    userMessageCount++;
                    if (userMessageCount > messageIndex) {
                        for (let j = i; j < allMessageElements.length; j++) {
                            allMessageElements[j].remove();
                        }
                        break;
                    }
                }
            }
            
            let finalUserInput = newText;
            if (isMedicalMode) {
                finalUserInput = createMedicalPrompt(newText);
            }
            
            const messageParts = [{ text: finalUserInput }];
            const userMessage = { role: 'user', parts: messageParts, timestamp: new Date() };
            allChats[currentChatId].messages.push(userMessage);
            
            const messageId_new = appendMessage({ text: newText }, 'user');
            
            toggleForm(false);
            generationControls.classList.remove('hidden');
            stopGenerationFlag = false;
            isGenerating = true;
            updateScrollButton();
            
            appendLoadingIndicator();
            
            if (!isUserScrolledUp) {
                scrollToBottomInstant();
            }
            
            try {
                const apiMessages = allChats[currentChatId].messages.map(({ role, parts }) => ({ role, parts }));
                
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(buildModelRequestPayload(apiMessages)),
                });
                
                removeLoadingIndicator();
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'An unknown API error occurred.');
                }
                
                const data = await response.json();
                const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (aiResponseText) {
                    const aiMessageId = appendMessage({text: ''}, 'model');
                    const aiMessageElement = document.getElementById(aiMessageId);
                    const contentContainer = aiMessageElement.querySelector('.prose');
                    
                    const finalText = await streamResponseSafe(contentContainer, aiResponseText, aiMessageId);
                    
                    enhanceResponseMessage(aiMessageElement, finalText);
                    
                    const aiMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                    allChats[currentChatId].messages.push(aiMessage);
                    
                    await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), userMessage);
                    await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);
                } else {
                    appendMessage({text: "I couldn't generate a response. The response was empty."}, 'model-error');
                }
            } catch (error) {
                console.error("Error fetching AI response:", error);
                removeLoadingIndicator();
                appendMessage({text: `Error: ${error.message}`}, 'model-error');
                showNotification('Error generating response', 'error');
            } finally {
                generationControls.classList.add('hidden');
                toggleForm(true);
                isGenerating = false;
                updateScrollButton();
            }
        }

        // Keep original function for reference but not used; see streamResponseSafe.
        async function streamResponse(contentContainer, fullText, messageId) {
            return new Promise((resolve) => {
                let currentText = '';
                let index = 0;
                const typingSpeed = 1;

                function type() {
                    if (stopGenerationFlag || index >= fullText.length) {
                        const finalHtml = marked.parse(currentText);
                        contentContainer.innerHTML = finalHtml;
                        makeTablesResponsive(contentContainer);
                        enhanceCodeBlocks(messageId);
                        // Smoothly bring the latest message into view at the end
                        scrollToLatestMessage();
                        resolve(currentText);
                        return;
                    }

                    currentText += fullText[index];
                    index++;
                    const tempHtml = marked.parse(currentText + '');
                    contentContainer.innerHTML = tempHtml;
                    
                    if (!isUserScrolledUp) {
                        scrollToBottomInstant();
                    }
                    
                    setTimeout(type, typingSpeed);
                }
                type();
            });
        }

        // Safer streaming that avoids mid-stream Markdown parsing
        async function streamResponseSafe(contentContainer, fullText, messageId) {
            return new Promise((resolve) => {
                let currentText = '';
                let index = 0;
                const typingSpeed = 1;

                function type() {
                    if (stopGenerationFlag || index >= fullText.length) {
                        try {
                            const finalHtml = marked.parse(prepMarkdown(currentText));
                            contentContainer.innerHTML = finalHtml;
                        } catch {
                            const safe = currentText.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            contentContainer.innerHTML = `<pre class="whitespace-pre-wrap break-words">${safe}</pre>`;
                        }
                        makeTablesResponsive(contentContainer);
                        enhanceCodeBlocks(messageId);
                        scrollToLatestMessage();
                        resolve(currentText);
                        return;
                    }

                    currentText += fullText[index++];
                    try {
                        const previewHtml = marked.parse(prepMarkdown(currentText));
                        // Append a subtle typing cursor at the end to mimic ChatGPT
                        contentContainer.innerHTML = previewHtml + '<span class="typing-cursor"></span>';
                    } catch {
                        const safePreview = currentText.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                        contentContainer.innerHTML = `<pre class="whitespace-pre-wrap break-words">${safePreview}</pre>`;
                    }
                    if (!isUserScrolledUp) scrollToBottomInstant();
                    setTimeout(type, typingSpeed);
                }
                type();
            });
        }
        
        function enhanceResponseMessage(messageElement, textContent) {
            const actionContainer = messageElement.querySelector('.action-buttons');
            if (!actionContainer) return;

            if (window.speechSynthesis) {
                addTTSButton(actionContainer, textContent);
            }

            addStandardActionButtons(actionContainer, textContent);

            // Add emoji reaction panel that toggles from Dislike
            try {
                actionContainer.classList.add('relative');
                const panel = document.createElement('div');
                panel.className = 'emoji-reaction-panel hidden absolute bottom-8 left-0 flex gap-2 bg-theme-secondary p-2 rounded-lg border border-theme-primary shadow-md';
                panel.innerHTML = `
                  <button class="emoji-btn text-lg"></button>
                  <button class="emoji-btn text-lg"></button>
                  <button class="emoji-btn text-lg"></button>
                `;
                actionContainer.appendChild(panel);
                const dislikeBtn = actionContainer.querySelector('.dislike-btn');
                if (dislikeBtn) {
                    dislikeBtn.addEventListener('click', () => {
                        panel.classList.toggle('hidden');
                    });
                }
                panel.querySelectorAll('.emoji-btn').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const emoji = btn.textContent.trim();
                        localStorage.setItem('feedback-' + Date.now(), emoji);
                        panel.innerHTML = `<span class="text-theme-success text-sm">Thanks for your feedback!</span>`;
                        setTimeout(() => panel.classList.add('hidden'), 1500);
                    });
                });
            } catch {}

            const table = messageElement.querySelector('table');
            if (table) {
                
                addChartButton(actionContainer, table);
            }

            const jsonCodeBlock = messageElement.querySelector('code.language-json');
            if (jsonCodeBlock) {
                addJsonExplorerButton(actionContainer, jsonCodeBlock.innerText);
            }

            const locationKeywords = ['city', 'country', 'location', 'place', 'travel', 'visit', 'destination', 'geography', 'map', 'directions', 'address'];
            const hasLocationContext = locationKeywords.some(keyword => 
                textContent.toLowerCase().includes(keyword)
            );
            
            if (hasLocationContext) {
                const locationMatches = textContent.match(/([A-Z][a-zA-Z\s]+,\s[A-Z][a-zA-Z\s]+)/g);
                if (locationMatches) {
                    addMapButton(actionContainer, locationMatches[0]);
                }
            }
            
            const dateRegex = /(?:schedule|meeting on|deadline for)\s(.*?)(?:\.|at\s\d{1,2}:\d{2}\s[AP]M|next\s\w+)/i;
            const dateMatch = textContent.match(dateRegex);
            if (dateMatch) {
                addCalendarButton(actionContainer, dateMatch[0], textContent);
            }

            addRegenerateButton(actionContainer, messageElement);

            // Append "Was this helpful?" feedback row at the bottom of the assistant message
            try {
                const bubble = messageElement.querySelector('.rounded-lg');
                if (bubble) {
                    const helpful = document.createElement('div');
                    helpful.className = 'helpful-feedback mt-3 text-sm text-theme-tertiary flex gap-3 items-center';
                    helpful.innerHTML = `
                      <span>Was this helpful?</span>
                      <button class="help-btn px-3 py-1 rounded-md bg-theme-tertiary hover:bg-theme-quaternary"> Yes</button>
                      <button class="help-btn px-3 py-1 rounded-md bg-theme-tertiary hover:bg-theme-quaternary"> No</button>
                    `;
                    bubble.appendChild(helpful);

                    helpful.querySelectorAll('.help-btn').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const isYes = btn.textContent.includes('Yes') || btn.textContent.includes('');
                            localStorage.setItem('helpful-feedback-' + Date.now(), isYes ? 'yes' : 'no');
                            helpful.innerHTML = `<span class="text-theme-success">Thanks for your feedback!</span>`;
                        });
                    });

                    // Ensure action buttons render below the helpful row
                    const actionContainer = messageElement.querySelector('.action-buttons');
                    if (actionContainer) {
                        bubble.appendChild(actionContainer);
                    }
                }
            } catch {}
        }
        
        function addStandardActionButtons(container, text, messageId) {
            const likeBtn = document.createElement('button');
            likeBtn.title = "Like response";
            likeBtn.className = "like-btn";
            likeBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                </svg>
            `;
            likeBtn.onclick = () => handleLikeDislike(messageId, 'like', likeBtn);
            container.appendChild(likeBtn);

            const dislikeBtn = document.createElement('button');
            dislikeBtn.title = "Dislike response";
            dislikeBtn.className = "dislike-btn";
            dislikeBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"></path>
                </svg>
            `;
            dislikeBtn.onclick = () => handleLikeDislike(messageId, 'dislike', dislikeBtn);
            container.appendChild(dislikeBtn);

            const copyBtn = document.createElement('button');
            copyBtn.title = "Copy response";
            copyBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>
                <span class="copy-feedback">Copied!</span>
            `;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(text).then(() => {
                    const feedback = copyBtn.querySelector('.copy-feedback');
                    feedback.classList.add('show');
                    setTimeout(() => feedback.classList.remove('show'), 2000);
                });
            };
            container.appendChild(copyBtn);
        }

        function handleLikeDislike(messageId, action, button) {
            // Remove active class from both buttons
            const message = document.getElementById(messageId);
            const likeBtn = message.querySelector('.like-btn');
            const dislikeBtn = message.querySelector('.dislike-btn');
            
            if (action === 'like') {
                if (button.classList.contains('active')) {
                    button.classList.remove('active');
                } else {
                    button.classList.add('active');
                    dislikeBtn.classList.remove('active');
                }
            } else {
                if (button.classList.contains('active')) {
                    button.classList.remove('active');
                } else {
                    button.classList.add('active');
                    likeBtn.classList.remove('active');
                }
            }
        }

        function addRegenerateButton(container, messageElement) {
            const regenerateBtn = document.createElement('button');
            regenerateBtn.title = "Regenerate response";
            regenerateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>`;
            regenerateBtn.onclick = () => handleRegenerateResponse(messageElement);
            container.appendChild(regenerateBtn);
        }

        async function handleRegenerateResponse(messageElement) {
            if (!currentChatId || !currentUser) return;
            
            const currentMessages = allChats[currentChatId].messages || [];
            let lastUserMessageIndex = -1;
            
            for (let i = currentMessages.length - 1; i >= 0; i--) {
                if (currentMessages[i].role === 'user') {
                    lastUserMessageIndex = i;
                    break;
                }
            }
            
            if (lastUserMessageIndex === -1) return;
            
            const aiMessageIndex = lastUserMessageIndex + 1;
            if (aiMessageIndex < currentMessages.length) {
                currentMessages.splice(aiMessageIndex, 1);
            }
            
            messageElement.remove();
            
            toggleForm(false);
            generationControls.classList.remove('hidden');
            stopGenerationFlag = false;
            isGenerating = true;
            updateScrollButton();
            
            appendLoadingIndicator();
            
            if (!isUserScrolledUp) {
                scrollToBottomInstant();
            }
            
            try {
                const apiMessages = allChats[currentChatId].messages.map(({ role, parts }) => ({ role, parts }));
                
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(buildModelRequestPayload(apiMessages)),
                });
                
                removeLoadingIndicator();
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'An unknown API error occurred.');
                }
                
                const data = await response.json();
                const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (aiResponseText) {
                    const aiMessageId = appendMessage({text: ''}, 'model');
                    const aiMessageElement = document.getElementById(aiMessageId);
                    const contentContainer = aiMessageElement.querySelector('.prose');
                    
                    const finalText = await streamResponseSafe(contentContainer, aiResponseText, aiMessageId);
                    
                    enhanceResponseMessage(aiMessageElement, finalText);
                    
                    const aiMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                    allChats[currentChatId].messages.push(aiMessage);
                    
                    await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);
                    
                    showNotification('Response regenerated', 'success');
                } else {
                    appendMessage({text: "I couldn't generate a response. The response was empty."}, 'model-error');
                }
            } catch (error) {
                console.error("Error regenerating response:", error);
                removeLoadingIndicator();
                appendMessage({text: `Error: ${error.message}`}, 'model-error');
                showNotification('Error regenerating response', 'error');
            } finally {
                generationControls.classList.add('hidden');
                toggleForm(true);
                isGenerating = false;
                updateScrollButton();
            }
        }

        function addChartButton(container, tableElement) {
             const chartBtn = document.createElement('button');
             chartBtn.title = "Visualize Chart";
             chartBtn.className = "interactive-btn";
             chartBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg><span>Visualize</span>`;
             chartBtn.onclick = () => showChartModal(tableElement);
             container.appendChild(chartBtn);
             captureChartPreview(tableElement.outerHTML, 'Latest table preview');
        }

        function addJsonExplorerButton(container, jsonText) {
            const jsonBtn = document.createElement('button');
            jsonBtn.title = "View JSON";
            jsonBtn.className = "interactive-btn";
            jsonBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg><span>View JSON</span>`;
            
            jsonBtn.onclick = () => showJsonExplorerModal(jsonText);
            container.appendChild(jsonBtn);
        }
        
        function addMapButton(container, location) {
            const mapBtn = document.createElement('button');
            mapBtn.title = `Show ${location} on Map`;
            mapBtn.className = "interactive-btn";
            mapBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`;
            mapBtn.onclick = () => showMapModal(location);
            container.appendChild(mapBtn);
        }
        
        function addCalendarButton(container, eventText, fullContext) {
            const calendarLink = createGoogleCalendarLink(eventText, fullContext);
            if (!calendarLink) return;

            const calendarBtn = document.createElement('a');
            calendarBtn.href = calendarLink;
            calendarBtn.target = "_blank";
            calendarBtn.rel = "noopener noreferrer";
            calendarBtn.title = "Add to Calendar";
            calendarBtn.className = "interactive-btn";
            calendarBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8"  x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`;
            container.appendChild(calendarBtn);
        }

        function showInteractiveModal(title) {
            interactiveModalTitle.textContent = title;
            interactiveModal.classList.remove('hidden');
            interactiveModal.classList.add('flex');
        }

        function hideInteractiveModal() {
            interactiveModal.classList.add('hidden');
            interactiveModal.classList.remove('flex');
            interactiveModalBody.innerHTML = '';
            interactiveModalFooter.innerHTML = '';
            interactiveModalFooter.classList.add('hidden');
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            visualizerSteps = [];
            currentVisStep = 0;
            if (monacoEditor) {
                monacoEditor.dispose();
                monacoEditor = null;
            }
        }
        
        function showChartModal(table) {
            showInteractiveModal("Chart Visualization");
            interactiveModalBody.innerHTML = '<div class="p-4 h-full"><canvas id="chart-canvas"></canvas></div>';
            interactiveModalFooter.classList.remove('hidden');

            const ctx = document.getElementById('chart-canvas').getContext('2d');
            const data = parseTableForChart(table);
            if (!data) {
                hideInteractiveModal();
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, ticks: { color: 'rgb(var(--text-primary))' }, grid: { color: 'rgb(var(--border-primary))'} },
                        x: { ticks: { color: 'rgb(var(--text-primary))' }, grid: { color: 'rgb(var(--border-primary))'} }
                    },
                    plugins: { legend: { labels: { color: 'rgb(var(--text-primary))' } } }
                }
            });

            ['bar', 'line', 'pie', 'doughnut'].forEach(type => {
                const btn = document.createElement('button');
                btn.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                btn.className = 'px-3 py-1 rounded-md bg-theme-quaternary hover:bg-theme-tertiary transition-colors text-theme-primary text-sm';
                btn.onclick = () => {
                    chartInstance.config.type = type;
                    chartInstance.update();
                };
                interactiveModalFooter.appendChild(btn);
            });
        }
        
        function showMapModal(location) {
            showInteractiveModal(`Map: ${location}`);
            interactiveModalBody.innerHTML = `<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(location)}&hl=es;z=14&amp&output=embed" class="w-full h-full border-0" loading="lazy"></iframe>`;
        }

        function showJsonExplorerModal(jsonText) {
             showInteractiveModal("JSON Explorer");
             interactiveModalBody.classList.add('p-4');
            try {
                const jsonObj = JSON.parse(jsonText);
                const formattedHtml = formatJsonToHtml(jsonObj);
                interactiveModalBody.innerHTML = `<div class="json-formatter">${formattedHtml}</div>`;
            } catch (e) {
                interactiveModalBody.innerHTML = `<p class="text-theme-error">Error parsing JSON: ${e.message}</p><pre class="mt-4 text-theme-quaternary">${jsonText}</pre>`;
            }
        }

        function showCodePreviewModal(code, language) {
            showInteractiveModal("Live Code Preview");
            const bodyContent = language === 'javascript' ? `<canvas id="chartCanvas"></canvas><script>${code}<\/script>` : code;
            const fullHtml = `
                <html>
                    <head>
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
                        <script src="https://d3js.org/d3.v7.min.js"><\/script>
                        <style>body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #fff; color: #000; overflow: auto; } canvas { display: block; }</style>
                    </head>
                    <body>
                        ${bodyContent}
                    </body>
                </html>`;
            interactiveModalBody.innerHTML = `<iframe srcdoc='${fullHtml.replace(/'/g, "&apos;")}' class="w-full h-full border-0" ></iframe>`;
        }
        
        async function showCodeVisualizationModal(code, language) {
            showInteractiveModal(`${language.charAt(0).toUpperCase() + language.slice(1)} Code Editor & Visualizer`);
            currentLanguage = language;
            
            interactiveModalBody.innerHTML = `<div class="flex items-center justify-center h-full">
                <dotlottie-player src="https://lottie.host/42a90344-ccc5-4d2a-92e2-1a62cef7473c/MqjsTEGKMS.lottie" background="transparent" speed="1" style="width: 200px; height: 200px;" loop autoplay></dotlottie-player>
            </div>`;

            await renderMonacoVisualizerUI(code, language);
            await generateVisualization(code, language);
        }

        async function renderMonacoVisualizerUI(code, language) {
            interactiveModalBody.innerHTML = `
                <div id="code-visualizer-container">
                    <div id="monaco-editor-container">
                        <div id="editor-toolbar">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-theme-secondary">Language:</span>
                                <select id="language-selector" class="monaco-editor-toolbar-btn">
                                    <option value="javascript" ${language === 'javascript' ? 'selected' : ''}>JavaScript</option>
                                    <option value="python" ${language === 'python' ? 'selected' : ''}>Python</option>
                                    <option value="java" ${language === 'java' ? 'selected' : ''}>Java</option>
                                    <option value="c" ${language === 'c' ? 'selected' : ''}>C</option>
                                    <option value="cpp" ${language === 'cpp' ? 'selected' : ''}>C++</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="run-code-btn" class="monaco-editor-toolbar-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                </button>
                                <label class="flex items-center gap-1 text-sm">
                                    <input type="checkbox" id="auto-run-checkbox" ${isAutoRunEnabled ? 'checked' : ''}>
                                    <span class="text-theme-secondary">Auto-run</span>
                                </label>
                            </div>
                        </div>
                        <div id="monaco-editor"></div>
                    </div>
                    <div id="visualizer-explanation-pane">
                        <h4 class="font-bold text-theme-primary mb-2">Execution Step</h4>
                        <p id="step-explanation" class="text-theme-secondary">Click "Run & Visualize" to see step-by-step execution</p>
                    </div>
                    <div id="visualizer-state-pane">
                        <h4 class="font-bold text-theme-primary mb-2">Variables & Output</h4>
                        <div id="variables-display" class="mb-4">
                            <p class="text-theme-quaternary text-sm">No variables yet</p>
                        </div>
                        <div id="output-panel">
                            <h5 class="font-bold text-theme-tertiary mb-1">Output:</h5>
                            <div id="output-content" class="text-theme-quaternary text-sm">No output yet</div>
                        </div>
                    </div>
                </div>
            `;
            
            const editorContainer = document.getElementById('monaco-editor');
            monacoEditor = await createMonacoEditor(editorContainer, code, language);
            
            interactiveModalFooter.innerHTML = `
                <button id="vis-prev-btn" class="px-4 py-2 rounded-md bg-theme-quaternary hover:bg-theme-tertiary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                <span id="vis-step-counter" class="text-sm text-theme-quaternary">Step 0/0</span>
                <button id="vis-next-btn" class="px-4 py-2 rounded-md bg-theme-quaternary hover:bg-theme-tertiary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                <button id="reset-visualization-btn" class="px-4 py-2 rounded-md bg-theme-accent hover:bg-theme-accent-hover text-theme-inverse transition-colors">Reset</button>
            `;
            interactiveModalFooter.classList.remove('hidden');

            setupMonacoEventListeners();
        }

        function setupMonacoEventListeners() {
            document.getElementById('language-selector').addEventListener('change', async (e) => {
                const newLanguage = e.target.value;
                currentLanguage = newLanguage;
                monaco.editor.setModelLanguage(monacoEditor.getModel(), newLanguage);
                
                if (isAutoRunEnabled) {
                    await generateVisualization(monacoEditor.getValue(), newLanguage);
                }
            });

            document.getElementById('run-code-btn').addEventListener('click', async () => {
                const code = monacoEditor.getValue();
                await generateVisualization(code, currentLanguage);
            });

            document.getElementById('auto-run-checkbox').addEventListener('change', (e) => {
                isAutoRunEnabled = e.target.checked;
                if (isAutoRunEnabled) {
                    let timeout;
                    monacoEditor.onDidChangeModelContent(() => {
                        clearTimeout(timeout);
                        timeout = setTimeout(async () => {
                            const code = monacoEditor.getValue();
                            await generateVisualization(code, currentLanguage);
                        }, 1000);
                    });
                }
            });

            document.getElementById('vis-prev-btn').addEventListener('click', () => {
                if (currentVisStep > 0) {
                    currentVisStep--;
                    updateVisualizerStep();
                }
            });

            document.getElementById('vis-next-btn').addEventListener('click', () => {
                if (currentVisStep < visualizerSteps.length - 1) {
                    currentVisStep++;
                    updateVisualizerStep();
                }
            });

            document.getElementById('reset-visualization-btn').addEventListener('click', () => {
                currentVisStep = 0;
                if (visualizerSteps.length > 0) {
                    updateVisualizerStep();
                }
            });
        }

        async function generateVisualization(code, language) {
            if (!code.trim()) {
                document.getElementById('step-explanation').textContent = 'No code to visualize';
                return;
            }

            document.getElementById('step-explanation').innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-theme-accent"></div>
                    <span>Generating visualization...</span>
                </div>
            `;

            const prompt = `
                Analyze the following ${language} code and generate a step-by-step execution trace.
                For each step, provide the line number being executed, a simple one-sentence explanation of what the line does, the state of global variables as an array of objects (where each object has a 'key' and a stringified 'value'), and any text that is printed to standard output.
                Only include variables that have been initialized.
                The very first step should be "Initial State" on line 0, showing the state before any code runs.
                The very last step should be "Final State", showing the final variable values and the complete output after the script finishes.
            `;
            
            const payload = {
              contents: [{
                role: 'user',
                parts: [
                  { text: prompt },
                  { text: `\`\`\`${language}\n${code}\n\`\`\`` }
                ]
              }],
              generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: "OBJECT",
                  properties: {
                    "steps": {
                      type: "ARRAY",
                      items: {
                        type: "OBJECT",
                        properties: {
                          "line": { "type": "INTEGER" },
                          "explanation": { "type": "STRING" },
                          "globals": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "key": { "type": "STRING" },
                                    "value": { "type": "STRING" }
                                }
                            }
                          },
                          "output": { "type": "STRING" }
                        }
                      }
                    }
                  }
                }
              }
            };

            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API error during visualization.');
                }
                const data = await response.json();
                const traceText = data.candidates[0].content.parts[0].text;
                const trace = JSON.parse(traceText);
                
                if (trace.steps && trace.steps.length > 0) {
                    visualizerSteps = trace.steps;
                    currentVisStep = 0;
                    updateVisualizerStep();
                    highlightCodeLines();
                } else {
                    throw new Error("AI could not generate a valid visualization trace.");
                }

            } catch (error) {
                console.error("Code visualization error:", error);
                document.getElementById('step-explanation').innerHTML = `<span class="text-theme-error">Error: Could not visualize code. ${error.message}</span>`;
            }
        }

        function highlightCodeLines() {
            if (monacoEditor) {
                monacoEditor.deltaDecorations(monacoEditor.getModel().getAllDecorations().map(d => d.id), []);
            }
        }

        function updateVisualizerStep() {
            const step = visualizerSteps[currentVisStep];
            if (!step) return;

            document.getElementById('step-explanation').textContent = step.explanation;

            const variablesDisplay = document.getElementById('variables-display');
            const globalsArray = step.globals || [];
            if (globalsArray.length > 0) {
                let variablesHtml = '';
                for (const variable of globalsArray) {
                    variablesHtml += `<div class="variable flex justify-between py-1"><span class="var-name font-mono text-theme-accent">${variable.key}</span> <span class="var-value font-mono text-theme-primary">${variable.value}</span></div>`;
                }
                variablesDisplay.innerHTML = variablesHtml;
            } else {
                variablesDisplay.innerHTML = '<p class="text-theme-quaternary text-sm">No variables initialized yet</p>';
            }

            const outputContent = document.getElementById('output-content');
            if (step.output) {
                outputContent.innerHTML = `<div class="output-line success">${step.output}</div>`;
            } else {
                outputContent.innerHTML = '<span class="text-theme-quaternary text-sm">No output yet</span>';
            }

            if (monacoEditor && step.line > 0 && step.explanation !== "Final State") {
                const decorations = [{
                    range: new monaco.Range(step.line, 1, step.line, 1),
                    options: {
                        isWholeLine: true,
                        className: 'highlighted-line',
                        glyphMarginClassName: 'highlighted-line-glyph'
                    }
                }];
                monacoEditor.deltaDecorations([], decorations);
                monacoEditor.revealLineInCenter(step.line);
            }

            document.getElementById('vis-step-counter').textContent = `Step ${currentVisStep + 1} of ${visualizerSteps.length}`;
            document.getElementById('vis-prev-btn').disabled = currentVisStep === 0;
            document.getElementById('vis-next-btn').disabled = currentVisStep === visualizerSteps.length - 1;
        }

        function parseTableForChart(table) {
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            if (headers.length < 2 || rows.length === 0) {
                showNotification("Table not suitable for charting.", "error");
                return null;
            }

            const labels = rows.map(row => row.cells[0].textContent.trim());
            const datasets = [];

            for (let i = 1; i < headers.length; i++) {
                const data = rows.map(row => parseFloat(row.cells[i].textContent.trim().replace(/[^0-9.-]+/g,"")) || 0);
                const colorVal1 = Math.floor(Math.random() * 256);
                const colorVal2 = Math.floor(Math.random() * 256);
                const colorVal3 = Math.floor(Math.random() * 256);
                datasets.push({
                    label: headers[i],
                    data: data,
                    backgroundColor: `rgba(${colorVal1}, ${colorVal2}, ${colorVal3}, 0.5)`,
                    borderColor: `rgba(${colorVal1}, ${colorVal2}, ${colorVal3}, 1)`,
                    borderWidth: 1
                });
            }

            return { labels, datasets };
        }
        
        function formatJsonToHtml(obj) {
            if (obj === null) return `<span class="null">null</span>`;
            if (typeof obj === 'string') return `<span class="string">"${obj.replace(/"/g, '\\"')}"</span>`;
            if (typeof obj === 'number') return `<span class="number">${obj}</span>`;
            if (typeof obj === 'boolean') return `<span class="boolean">${obj}</span>`;

            if (Array.isArray(obj)) {
                if (obj.length === 0) return '[]';
                let content = obj.map(item => `<li>${formatJsonToHtml(item)}</li>`).join('');
                return `<details open><summary class="inline-block">Array(${obj.length}) [</summary><ul class="pl-4">${content}</ul>]</details>`;
            }

            if (typeof obj === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '{}';
                let content = keys.map(key => `<li><span class="key">"${key}"</span>: ${formatJsonToHtml(obj[key])}</li>`).join('');
                return `<details open><summary class="inline-block">Object {</summary><ul class="pl-4">${content}</ul>}</details>`;
            }
            
            return obj.toString();
        }

        function createGoogleCalendarLink(text, context) {
            let date = new Date();
            let title = "New Event";
            const titleMatch = context.match(/(?:deadline for|meeting on|schedule)\s(.*?)(?=\sfor|\son|\sat)/i);
            if (titleMatch) title = titleMatch[1];

            const timeMatch = text.match(/(\d{1,2})(?::(\d{2}))?\s?(am|pm)/i);
            if (timeMatch) {
                let hours = parseInt(timeMatch[1]);
                const minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
                const ampm = timeMatch[3].toLowerCase();
                if (ampm === 'pm' && hours < 12) hours += 12;
                if (ampm === 'am' && hours === 12) hours = 0;
                date.setHours(hours, minutes, 0, 0);
            }

            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayMatch = text.match(new RegExp(`next (${days.join('|')})`, 'i'));
            if (dayMatch) {
                const targetDay = days.indexOf(dayMatch[1].toLowerCase());
                const currentDay = date.getDay();
                let dayDifference = targetDay - currentDay;
                if (dayDifference <= 0) dayDifference += 7;
                date.setDate(date.getDate() + dayDifference);
            }

            const startDate = date.toISOString().replace(/-|:|\.\d{3}/g, '');
            date.setHours(date.getHours() + 1);
            const endDate = date.toISOString().replace(/-|:|\.\d{3}/g, '');

            const details = `Event details: ${context}`;
            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(details)}`;
            return url;
        }

        function handleTextareaKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey && !submitButton.disabled) {
                e.preventDefault();
                handleSendMessage();
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
            textarea.style.overflowY = textarea.scrollHeight > 200 ? 'auto' : 'hidden';
        }

        function updateSendButtonState() {
            const hasText = chatInput.value.trim().length > 0;
            const hasFile = attachedFiles && attachedFiles.length > 0;
            const canSend = hasText || hasFile;

            submitButton.disabled = !canSend;
            submitButton.classList.toggle('bg-theme-tertiary', !canSend);
            submitButton.classList.toggle('hover:bg-theme-accent', canSend);
            submitButton.classList.toggle('bg-theme-quaternary', canSend);
        }
        
        function makeTablesResponsive(element) {
            if (!element) return;
            element.querySelectorAll('table').forEach(table => {
                if (table.parentElement.classList.contains('table-responsive-wrapper')) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'table-responsive-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
        }

        function enhanceCodeBlocks(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;

            messageElement.querySelectorAll('pre').forEach(block => {
                const code = block.querySelector('code');
                if (!code || block.querySelector('.code-btn-wrapper')) return;

                const btnWrapper = document.createElement('div');
                btnWrapper.className = 'code-btn-wrapper';
                
                const codeText = code.innerText;
                const language = Array.from(code.classList).find(c => c.startsWith('language-'))?.replace('language-', '');

                if (['html', 'markup', 'xml'].includes(language)) {
                    const previewBtn = document.createElement('button');
                    previewBtn.className = 'code-action-btn';
                    previewBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg> <span>Preview</span>`;
                    previewBtn.addEventListener('click', () => showCodePreviewModal(codeText, language));
                    btnWrapper.appendChild(previewBtn);
                }
                
                if (['javascript', 'html'].includes(language) && /(new Chart|d3\.select)/.test(codeText)) {
                     const vizBtn = document.createElement('button');
                    vizBtn.className = 'code-action-btn';
                    vizBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg><span>Visualize</span>`;
                    vizBtn.addEventListener('click', () => showCodePreviewModal(codeText, language));
                    btnWrapper.appendChild(vizBtn);
                }
                
                if (vizLanguages.includes(language)) {
                     const vizBtn = document.createElement('button');
                    vizBtn.className = 'code-action-btn';
                    vizBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m10 8 6 4-6 4z"/></svg><span>Edit & Visualize</span>`;
                    vizBtn.addEventListener('click', () => showCodeVisualizationModal(codeText, language));
                    btnWrapper.appendChild(vizBtn);
                }

                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-action-btn';
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg> 
                    <span>Copy</span>
                    <span class="copy-feedback">Copied!</span>
                `;
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(codeText).then(() => {
                        const feedback = copyBtn.querySelector('.copy-feedback');
                        feedback.classList.add('show');
                        setTimeout(() => feedback.classList.remove('show'), 2000);
                    }).catch(err => {
                        showNotification('Failed to copy code', 'error');
                    });
                });
                btnWrapper.appendChild(copyBtn);

                // Add Run button for JavaScript snippets (sandboxed)
                if (language === 'js' || language === 'javascript') {
                    const runBtn = document.createElement('button');
                    runBtn.className = 'code-action-btn';
                    runBtn.innerHTML = `
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                      </svg>
                      <span>Run</span>
                    `;
                    runBtn.addEventListener('click', () => {
                        const iframe = document.createElement('iframe');
                        iframe.sandbox = 'allow-scripts';
                        iframe.style.width = '100%';
                        iframe.style.height = '120px';
                        iframe.style.border = '1px solid rgba(200,200,200,0.3)';
                        iframe.style.borderRadius = '8px';
                        iframe.style.marginTop = '8px';
                        block.appendChild(iframe);
                        const doc = iframe.contentDocument || iframe.contentWindow.document;
                        doc.open();
                        doc.write(`<script>try {${codeText}} catch(err) {document.body.innerHTML = '<pre style="color:red">'+err+'</pre>';}<\/script>`);
                        doc.close();
                    });
                    btnWrapper.appendChild(runBtn);
                }

                block.appendChild(btnWrapper);
            });
        }
        
        function createHistoryItemElement(chat, isActive) {
            const li = document.createElement('li');
            li.className = 'history-item-wrapper';
            li.dataset.chatId = chat.id;

            // Set medical attribute for styling
            if (chat.isMedical) {
                li.dataset.medical = 'true';
            }
            
            // Set active class
            if (isActive) {
                li.classList.add('active');
            }

            const titleText = chat.title || 'New Chat';

            // 1. Content (Icon + Title)
            const contentDiv = document.createElement('div');
            contentDiv.className = 'history-item-content';
            contentDiv.onclick = () => loadChat(chat.id); // Click on content loads chat

            // Medical Icon (conditionally added)
            if (chat.isMedical) {
                const icon = document.createElement('svg');
                icon.className = 'history-item-icon';
                icon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                icon.setAttribute('width', '16');
                icon.setAttribute('height', '16');
                icon.setAttribute('viewBox', '0 0 24 24');
                icon.setAttribute('fill', 'none');
                icon.setAttribute('stroke', 'currentColor');
                icon.setAttribute('stroke-width', '2');
                icon.setAttribute('stroke-linecap', 'round');
                icon.setAttribute('stroke-linejoin', 'round');
                icon.innerHTML = `<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>`;
                contentDiv.appendChild(icon);
            }

            const titleSpan = document.createElement('span');
            titleSpan.className = 'history-item-title';
            titleSpan.textContent = titleText;
            contentDiv.appendChild(titleSpan);

            // 2. Actions
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'history-item-actions'; // Your existing styles will target this

            const pinBtn = document.createElement('button');
            pinBtn.type = 'button';
            pinBtn.className = pinnedChatIds.has(chat.id) ? 'pin-btn active' : 'pin-btn';
            pinBtn.title = pinnedChatIds.has(chat.id) ? 'Unpin chat' : 'Pin chat';
            pinBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9l-5 4.87L17.18 22 12 18.27 6.82 22 8 13.87 3 9l6.91-.74L12 2z"/></svg>`;
            pinBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                togglePinChat(chat.id);
            });
            actionsContainer.appendChild(pinBtn);

            const renameBtn = document.createElement('button');
            renameBtn.className = 'edit-btn'; // Use existing style
            renameBtn.title = 'Rename chat';
            renameBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
            renameBtn.onclick = (e) => {
                e.stopPropagation();
                handleRename(chat.id, contentDiv); // Pass contentDiv to handleRename
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn'; // Use existing style
            deleteBtn.title = 'Delete chat';
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                showDeleteModal(chat.id);
            };

            actionsContainer.appendChild(renameBtn);
            actionsContainer.appendChild(deleteBtn);

            // Assemble the <li>
            li.appendChild(contentDiv);
            li.appendChild(actionsContainer);

            return li;
        }

        function getStoredPinnedChats() {
            try {
                const stored = JSON.parse(localStorage.getItem('pinnedChats') || '[]');
                return Array.isArray(stored) ? stored : [];
            } catch (error) {
                console.warn('Failed to parse pinned chats from storage', error);
                return [];
            }
        }

        function persistPinnedChats() {
            if (!window?.localStorage) return;
            try {
                localStorage.setItem('pinnedChats', JSON.stringify(Array.from(pinnedChatIds)));
            } catch (error) {
                console.warn('Error persisting pinned chats', error);
            }
        }

        function chatHasMedia(chat) {
            if (!chat || !Array.isArray(chat.messages)) return false;
            return chat.messages.some(msg => {
                return msg.parts?.some(part => part.inlineData);
            });
        }

        function matchesHistoryFilter(chat) {
            if (!chat) return false;
            if (currentHistoryFilter === 'pinned') return pinnedChatIds.has(chat.id);
            if (currentHistoryFilter === 'medical') return Boolean(chat.isMedical);
            if (currentHistoryFilter === 'multimedia') return chatHasMedia(chat);
            return true;
        }

        function renderHistoryFilters() {
            if (!historyFilterBar) return;
            historyFilterBar.innerHTML = historyFiltersConfig.map(filter => `
                <button type="button" class="history-filter-btn ${currentHistoryFilter === filter.id ? 'active' : ''}" data-filter="${filter.id}">
                    ${filter.label}
                </button>
            `).join('');
        }

        function renderHistoryQuickAccess(sortedChats) {
            if (!historyQuickAccess) return;
            historyQuickAccess.innerHTML = '';
            const pinnedChats = sortedChats.filter(chat => pinnedChatIds.has(chat.id));
            if (pinnedChats.length === 0) {
                historyQuickAccess.innerHTML = '<p class="text-xs text-theme-tertiary"></p>';
                return;
            }

            pinnedChats.slice(0, 4).forEach(chat => {
                const quickItem = document.createElement('div');
                quickItem.className = 'history-quick-item';
                quickItem.setAttribute('role', 'button');
                quickItem.tabIndex = 0;
                quickItem.addEventListener('click', () => loadChat(chat.id));

                const textWrapper = document.createElement('div');
                const titleEl = document.createElement('span');
                titleEl.className = 'history-quick-item-title';
                titleEl.textContent = chat.title || 'New Chat';
                const metaEl = document.createElement('span');
                metaEl.className = 'history-quick-item-meta';
                metaEl.textContent = formatChatDate(chat.createdAt);
                textWrapper.appendChild(titleEl);
                textWrapper.appendChild(metaEl);

                const pinBtn = document.createElement('button');
                pinBtn.type = 'button';
                pinBtn.className = pinnedChatIds.has(chat.id) ? 'pin-btn active' : 'pin-btn';
                pinBtn.title = pinnedChatIds.has(chat.id) ? 'Unpin chat' : 'Pin chat';
                pinBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9l-5 4.87L17.18 22 12 18.27 6.82 22 8 13.87 3 9l6.91-0.74L12 2z"/></svg>`;
                pinBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    togglePinChat(chat.id);
                });

                quickItem.appendChild(textWrapper);
                quickItem.appendChild(pinBtn);
                historyQuickAccess.appendChild(quickItem);
            });
        }

        function formatChatDate(timestamp) {
            if (!timestamp) return 'No date';
            const date = timestamp?.toDate ? timestamp.toDate() : new Date(timestamp);
            if (isNaN(date.getTime())) return 'No date';
            return date.toLocaleDateString();
        }

        function togglePinChat(chatId) {
            if (!chatId) return;
            if (pinnedChatIds.has(chatId)) {
                pinnedChatIds.delete(chatId);
            } else {
                pinnedChatIds.add(chatId);
            }
            persistPinnedChats();
            renderHistoryFilters();
            renderHistorySidebar();
        }

        function renderHistorySidebar() {
            const searchTerm = searchHistoryInput.value.toLowerCase();
            
            const listToday = document.getElementById('history-list-today');
            const listWeek = document.getElementById('history-list-week');
            const listOlder = document.getElementById('history-list-older');
            const groupToday = listToday.closest('.history-group');
            const groupWeek = listWeek.closest('.history-group');
            const groupOlder = listOlder.closest('.history-group');
            const historyContainer = document.getElementById('history-container');

            listToday.innerHTML = '';
            listWeek.innerHTML = '';
            listOlder.innerHTML = '';

            const sortedChats = Object.values(allChats).sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                return dateB - dateA;
            });

            renderHistoryFilters();
            renderHistoryQuickAccess(sortedChats);

            clearAllBtn.style.display = sortedChats.length > 0 ? 'flex' : 'none';

            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);

            let foundToday = 0;
            let foundWeek = 0;
            let foundOlder = 0;
            let foundMatchingFilter = false;

            sortedChats.forEach(chat => {
                const titleText = chat.title || 'New Chat';
                const matchesSearch = !searchTerm || titleText.toLowerCase().includes(searchTerm) || (chat.messages || [])
                    .map(msg => (msg.parts?.map(p => p.text || '').join(' ') || '').toLowerCase())
                    .join(' ')
                    .includes(searchTerm);
                const passesFilter = matchesHistoryFilter(chat);
                if (!matchesSearch || !passesFilter) return;

                foundMatchingFilter = true;
                const isActive = chat.id === currentChatId;
                const chatDate = chat.createdAt?.toDate ? chat.createdAt.toDate() : new Date(0);

                const li = createHistoryItemElement(chat, isActive);
                if (chatDate >= startOfToday) {
                    listToday.appendChild(li);
                    foundToday++;
                } else if (chatDate >= startOfWeek) {
                    listWeek.appendChild(li);
                    foundWeek++;
                } else {
                    listOlder.appendChild(li);
                    foundOlder++;
                }
            });

            groupToday.classList.toggle('hidden', foundToday === 0);
            groupWeek.classList.toggle('hidden', foundWeek === 0);
            groupOlder.classList.toggle('hidden', foundOlder === 0);

            let noResultsEl = historyContainer.querySelector('.no-results-message');
            const shouldShowNoResults = !foundMatchingFilter && (searchTerm || currentHistoryFilter !== 'all');
            if (shouldShowNoResults) {
                if (!noResultsEl) {
                    noResultsEl = document.createElement('p');
                    noResultsEl.className = 'no-results-message text-theme-quaternary text-sm text-center p-4';
                    historyContainer.appendChild(noResultsEl);
                }
                noResultsEl.textContent = 'No chats found.';
                noResultsEl.style.display = 'block';
            } else if (noResultsEl) {
                noResultsEl.style.display = 'none';
            }

            animateHistoryLists();
            updateAnalyticsPanel();
        }

        function updateAnalyticsPanel() {
            if (!analyticsTotalChats) return;
            const chats = Object.values(allChats);
            const totalChats = chats.length;
            const totalMessages = chats.reduce((sum, chat) => sum + (chat.messages?.length || 0), 0);
            let attachmentCount = 0;
            const responseLengths = [];
            chats.forEach(chat => {
                (chat.messages || []).forEach(msg => {
                    if (msg.role === 'model') {
                        const text = (msg.parts || []).map(part => part.text || '').join('');
                        responseLengths.push(text.length);
                    }
                    attachmentCount += (msg.parts || []).filter(part => part.inlineData).length;
                });
            });
            const avgResponse = responseLengths.length ? Math.round(responseLengths.reduce((a, b) => a + b, 0) / responseLengths.length) : 0;

            analyticsTotalChats.textContent = String(totalChats);
            analyticsTotalMessages.textContent = String(totalMessages);
            analyticsAvgResponse.textContent = `${avgResponse} chars`;
            analyticsAttachmentCount.textContent = String(attachmentCount);
        }

        function captureChartPreview(html, label = 'Latest chart preview') {
            if (!analyticsChartPreview) return;
            lastChartPreviewHtml = html || '';
            analyticsChartCaption.textContent = label;
            analyticsChartPreview.innerHTML = lastChartPreviewHtml || '<p class="text-xs text-theme-quaternary">No chart preview available.</p>';
            if (pinLastChartBtn) {
                pinLastChartBtn.disabled = !lastChartPreviewHtml;
            }
        }

        function pinLastChart() {
            if (!lastChartPreviewHtml) {
                showNotification('No chart to pin', 'info');
                return;
            }
            analyticsPinnedChartHtml = lastChartPreviewHtml;
            analyticsChartCaption.textContent = 'Pinned chart';
            analyticsChartPreview.innerHTML = analyticsPinnedChartHtml;
            showNotification('Chart pinned', 'success');
        }
        
        async function handleRename(chatId, titleContainer) {
            const currentTitle = allChats[chatId].title || 'New Chat';
            
            // Find the title span within the container
            const titleSpan = titleContainer.querySelector('.history-item-title');
            // Find the icon if it exists
            const icon = titleContainer.querySelector('.history-item-icon');

            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'w-full bg-theme-quaternary text-theme-primary text-sm rounded px-1 py-0 flex-1';
            
            // Hide the title and icon
            if (titleSpan) titleSpan.style.display = 'none';
            if (icon) icon.style.display = 'none';

            // Add the input after the icon (if it exists) or at the start
            if (icon) {
                icon.after(input);
            } else {
                titleContainer.prepend(input);
            }
            
            input.focus();
            input.select();
            
            const saveRename = async () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== currentTitle) {
                    await updateDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "chats", chatId), { title: newTitle });
                    allChats[chatId].title = newTitle;
                    showNotification('Chat renamed!', 'success');
                }
                // Re-render the whole sidebar to restore structure
                renderHistorySidebar();
            };
            
            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveRename();
                } else if (e.key === 'Escape') {
                    // Re-render to cancel
                    renderHistorySidebar();
                }
            });
        }

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
        }

        function toggleForm(isEnabled) {
            chatInput.disabled = !isEnabled;
            micBtn.disabled = !isEnabled;
            attachFileBtn.disabled = !isEnabled;
            if(isEnabled) {
                updateSendButtonState();
                chatInput.focus();
            } else {
                submitButton.disabled = true;
            }
        }

        async function startNewChat() {
            if (currentUser) {
                const timestamp = new Date();
                const newChatRef = await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"), {
                    title: "New Chat",
                    createdAt: timestamp,
                    isMedical: isMedicalMode
                });
                
                currentChatId = newChatRef.id;
                allChats[currentChatId] = {
                    id: currentChatId,
                    createdAt: { toDate: () => timestamp },
                    title: "New Chat",
                    messages: [],
                    isMedical: isMedicalMode
                };
            } else {
                currentChatId = null;
            }

            if (isMedicalMode) {
                showMedicalWelcomeContent();
            } else {
                showWelcomeContent();
            }
            renderHistorySidebar();
            removeAttachedFile();
            if (isTTSActive) {
                stopTTS();
            }
            showNotification('Started new chat', 'success');
            exportBtn.disabled = true;

            if (window.innerWidth < 1024) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.add('hidden');
            }
        }

        async function loadChat(chatId) {
            if (!currentUser || !allChats[chatId]) return;
            currentChatId = chatId;
            // chatContainer.innerHTML = '';
            showChatSkeletonLoader(); // show skeleton loader immediately
            exportBtn.disabled = false;

            if (isTTSActive) {
                stopTTS();
            }

            const chatIsMedical = allChats[chatId].isMedical || false;
            if (chatIsMedical !== isMedicalMode) {
                isMedicalMode = chatIsMedical;
                medicalModeIndicator.classList.toggle('hidden', !isMedicalMode);
                
                if (isMedicalMode) {
                    medicalAiBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    medicalAiBtn.classList.add('bg-green-800', 'hover:bg-green-900');
                    chatAiBtn.classList.remove('hidden');
                    updateInputPlaceholder('Ask about symptoms, medications, health advice...');
                } else {
                    medicalAiBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    medicalAiBtn.classList.remove('bg-green-800', 'hover:bg-green-900');
                    chatAiBtn.classList.add('hidden');
                    updateInputPlaceholder('Enter Your Prompt...');
                }
            }

            if (!allChats[chatId].messages || allChats[chatId].messages.length === 0) {
                const messagesQuery = query(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", chatId, "messages"));
                const messagesSnapshot = await getDocs(messagesQuery);
                const messages = messagesSnapshot.docs.map(doc => doc.data()).sort((a,b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));
                allChats[chatId].messages = messages;
            }
            // hide skeleton before rendering actual messages
            hideChatSkeletonLoader();
            
            allChats[chatId].messages.forEach(msg => {
                 const textContent = msg.parts.find(p => p.text)?.text || '[Multimedia Content]';
                 const messageElementId = appendMessage({ text: textContent }, msg.role);
                 const messageElement = document.getElementById(messageElementId);
                 if (msg.role === 'model') {
                     enhanceResponseMessage(messageElement, textContent);
                 }
            });

            renderHistorySidebar();
            scrollToBottomInstant();
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        async function loadChatsFromFirestore() {
            if (!currentUser) return;
            const chatsQuery = query(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            allChats = {};
            querySnapshot.forEach((doc) => {
                allChats[doc.id] = { id: doc.id, ...doc.data(), messages: [] };
            });

            loadMostRecentChat();
        }

        function loadMostRecentChat() {
            const sortedChats = Object.values(allChats).sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
            if (sortedChats.length > 0) {
                loadChat(sortedChats[0].id);
            } else {
                startNewChat();
            }
        }

        function showDeleteModal(chatId) {
            chatIdToDelete = chatId;
            deleteModalTitle.textContent = chatId ? "Delete Chat?" : "Delete All Chats?";
            deleteModalText.textContent = `This will permanently delete ${chatId ? 'this conversation' : 'all conversations'}. This action cannot be undone.`;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }

        function hideDeleteModal() {
            chatIdToDelete = null;
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
        }

        function showPreviewModal(htmlCode) {
            const fullHtml = `<html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><script src="https://cdn.tailwindcss.com"><\/script></head><body>${htmlCode}</body></html>`;
            previewIframe.srcdoc = fullHtml;
            previewModal.classList.remove('hidden');
            previewModal.classList.add('flex');
        }

        function hidePreviewModal() {
            previewIframe.srcdoc = '';
            previewModal.classList.add('hidden');
            previewModal.classList.remove('flex');
        }

        async function confirmDeletion() {
            if (chatIdToDelete) {
                await handleSingleDelete();
            } else {
                await handleDeleteAll();
            }
        }

        async function handleSingleDelete() {
            if (!chatIdToDelete || !currentUser) return;
            const idToDelete = chatIdToDelete;
            const wasCurrentChat = idToDelete === currentChatId;
            await deleteDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "chats", idToDelete));
            delete allChats[idToDelete];
            hideDeleteModal();
            renderHistorySidebar();
            if (wasCurrentChat) {
                loadMostRecentChat();
            }
            showNotification('Chat deleted', 'success');
        }

        async function handleDeleteAll() {
            if(!currentUser) return;
            const chatsQuery = query(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deletePromises);
            allChats = {};
            hideDeleteModal();
            renderHistorySidebar();
            startNewChat();
            showNotification('All chats deleted', 'success');
        }

        function toggleVoiceRecognition() {
            if (micIcon.classList.contains('mic-active')) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    micIcon.classList.add('mic-active', 'animate-pulse');
                    showNotification('Listening... Speak now', 'info');
                } catch(e) { 
                    console.error("Could not start recognition:", e);
                    showNotification('Voice recognition not available', 'error');
                }
            }
        }

        function handleVoiceResult(event) {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript;
            updateSendButtonState();
            autoResizeTextarea(chatInput);
            showNotification(`Voice input: "${transcript}"`, 'success');
        }
        
        function handleExport(format) {
            if (!currentChatId) {
                showNotification("No active chat to export.", "error");
                return;
            }

            const chat = allChats[currentChatId];
            const title = chat.title || 'chat-export';
            const messages = chat.messages || [];
            let content = '';

            if (format === 'txt') {
                content = messages.map(msg => {
                    const sender = msg.role === 'user' ? 'User' : (chat.isMedical ? 'Medical AI' : 'Chat@AI');
                    const text = msg.parts.find(p => p.text)?.text || '[Multimedia Content]';
                    return `${sender}:\n${text}\n\n--------------------------------\n\n`;
                }).join('');
            } else if (format === 'md') {
                content = `# ${title}\n\n`;
                if (chat.isMedical) {
                    content += `**Medical AI Chat Export**\n\n`;
                    content += ` **Medical Disclaimer**: This conversation contains AI-generated health information for educational purposes only. Always consult healthcare professionals for medical advice.\n\n---\n\n`;
                }
                content += messages.map(msg => {
                    const sender = msg.role === 'user' ? '> **User**' : (chat.isMedical ? '**Medical AI**' : '**Chat@AI**');
                    const text = msg.parts.find(p => p.text)?.text || '`[Multimedia Content]`';
                    return `${sender}\n\n${text}\n\n---\n\n`;
                }).join('');
            } else if (format === 'pdf') {
                exportToPdf(title, messages, chat.isMedical);
                return;
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`Chat exported as ${format.toUpperCase()}`, 'success');
        }
        
        function exportToPdf(title, messages, isMedical = false) {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             let y = 15;
             const pageHeight = doc.internal.pageSize.height;
             const margin = 10;
             const maxWidth = doc.internal.pageSize.width - margin * 2;
             
             doc.setFontSize(18);
             doc.text(title, margin, y);
             y += 15;
             
             if (isMedical) {
                 doc.setFontSize(12);
                 doc.text('Medical AI Chat Export', margin, y);
                 y += 10;
                 doc.setFontSize(10);
                 const disclaimer = 'Medical Disclaimer: This conversation contains AI-generated health information for educational purposes only. Always consult healthcare professionals for medical advice.';
                 const disclaimerLines = doc.splitTextToSize(disclaimer, maxWidth);
                 doc.text(disclaimerLines, margin, y);
                 y += (disclaimerLines.length * 4) + 10;
             }
             
             messages.forEach(msg => {
                if (y > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                 
                const sender = msg.role === 'user' ? 'User' : (isMedical ? 'Medical AI' : 'Chat@AI');
                const text = msg.parts.find(p => p.text)?.text || '[Multimedia Content]';

                doc.setFontSize(12).setFont(undefined, 'bold');
                doc.text(sender, margin, y);
                y += 6;
                
                doc.setFontSize(10).setFont(undefined, 'normal');
                const lines = doc.splitTextToSize(text, maxWidth);
                doc.text(lines, margin, y);
                y += (lines.length * 4.5) + 10;
             });
             
             doc.save(`${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
             showNotification('Chat exported as PDF', 'success');
        }

        function appendLoadingIndicator() {
            const loadingHtml = `
                <div id="loading-indicator" class="flex items-center gap-2 sm:gap-3">
                    <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full ${isMedicalMode ? 'bg-green-600' : 'bg-theme-accent'} flex items-center justify-center shadow-md">
                       ${isMedicalMode ? 
                         `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                            <path d="M12 5L8 21l4-7 4 7-4-16"/>
                          </svg>` :
                         `<img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full shadow-md" />`
                       }
                    </div>
                    <div class="rounded-lg max-w-lg flex items-center justify-center">
                        <dotlottie-player src="https://lottie.host/42a90344-ccc5-4d2a-92e2-1a62cef7473c/MqjsTEGKMS.lottie" background="transparent" speed="1" style="width: 120px; height: 120px;" loop autoplay></dotlottie-player>
                    </div>
                </div>`;
            chatContainer.insertAdjacentHTML('beforeend', loadingHtml);
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.remove();
        }

        // --- MICRO-ANIMATIONS & RIPPLE ---
        function attachRipple() {
            document.addEventListener('click', (e) => {
                const target = e.target.closest('button, .btn, [data-ripple], .code-action-btn, .edit-btn, .delete-btn');
                if (!target || target.classList.contains('no-ripple')) return;
                target.classList.add('ripple-container');

                const rect = target.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const ripple = document.createElement('span');
                ripple.className = 'ripple';
                ripple.style.width = ripple.style.height = size + 'px';
                const x = (e.clientX - rect.left) - size / 2;
                const y = (e.clientY - rect.top) - size / 2;
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                target.appendChild(ripple);
                ripple.addEventListener('animationend', () => ripple.remove());
            }, { capture: false });
        }

        function animateHistoryLists() {
            const ids = ['history-list-today', 'history-list-week', 'history-list-older'];
            ids.forEach((id) => {
                const list = document.getElementById(id);
                if (!list) return;
                const items = Array.from(list.children);
                items.forEach((li, idx) => {
                    if (li.dataset.animated === 'true') return;
                    li.dataset.animated = 'true';
                    li.classList.add('history-animate-enter');
                    // Staggered enter
                    setTimeout(() => {
                        li.style.transition = 'opacity 300ms ease, transform 300ms ease';
                        li.classList.add('history-animate-active');
                        li.classList.remove('history-animate-enter');
                    }, 40 * idx);
                });
            });
        }

        function initializeMicroAnimations() {
            attachRipple();
            // Run a first pass for any pre-rendered history items
            animateHistoryLists();
        }

        // --- SKELETON LOADER FUNCTIONS ---
        function showChatSkeletonLoader() {
            const loaderHtml = `
                <div class="skeleton-message animate-pulse">
                    <div class="skeleton-avatar"></div>
                    <div class="skeleton-bubble">
                        <div class="skeleton-line" style="width: 80%;"></div>
                        <div class="skeleton-line mt-2" style="width: 60%;"></div>
                    </div>
                </div>
                <div class="skeleton-message user animate-pulse">
                    <div class="skeleton-bubble">
                        <div class="skeleton-line" style="width: 70%;"></div>
                    </div>
                    <div class="skeleton-avatar"></div>
                </div>
                <div class="skeleton-message animate-pulse">
                    <div class="skeleton-avatar"></div>
                    <div class="skeleton-bubble">
                        <div class="skeleton-line" style="width: 90%;"></div>
                        <div class="skeleton-line mt-2" style="width: 50%;"></div>
                        <div class="skeleton-line mt-2" style="width: 70%;"></div>
                    </div>
                </div>
            `;
            chatContainer.innerHTML = loaderHtml;
        }

        function hideChatSkeletonLoader() {
            chatContainer.innerHTML = '';
        }

        // --- PROMPT & SCHEDULER HELPERS ---
        const tagColors = {
            'code': 'tag-code',
            'drafting': 'tag-drafting',
            'marketing': 'tag-marketing',
            'medical': 'tag-medical',
            'data': 'tag-data'
        };

        function getPromptTags(prompt) {
            return (prompt.tags && prompt.tags.length > 0) ? prompt.tags : ['other'];
        }

        function renderTagChips(tags, isFilter = false, activeFilter = '') {
            return tags.map(tag => {
                const tagClass = tagColors[tag.toLowerCase()] || 'tag-other';
                const activeClass = isFilter && tag.toLowerCase() === activeFilter ? 'active' : '';
                const tagValue = tag.charAt(0).toUpperCase() + tag.slice(1);
                return `<span class="tag-chip ${tagClass} ${activeClass}" data-tag="${tag}">${tagValue}</span>`;
            }).join('');
        }

        function getAllTags() {
            const allTags = new Set(['all']);
            userPrompts.forEach(prompt => {
                getPromptTags(prompt).forEach(tag => allTags.add(tag.toLowerCase()));
            });
            return Array.from(allTags);
        }

        function calculateNextRunTime(task) {
            const { date, time, repeat } = task;
            const now = new Date();
            const nextRun = new Date(`${date} ${time}`);
            if (!task.isActive) return 'Paused';
            if ((repeat === 'once' || repeat === 'none') && nextRun.getTime() < now.getTime()) return 'Completed';
            const diffMs = nextRun.getTime() - now.getTime();
            if (diffMs <= 0) return 'Running Now / Due';
            const diffMins = Math.round(diffMs / 60000);
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;
            if (hours > 24) return `Next: ${new Date(date).toLocaleDateString()} ${time}`;
            if (hours > 0) return `In ${hours}h ${minutes}m`;
            return `In ${minutes}m`;
        }

        async function toggleTaskActive(id) {
            const task = scheduledTasks.find(t => t.id === id);
            if (!task) return;
            task.isActive = !task.isActive;
            await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), { scheduledTasks: scheduledTasks }, { merge: true });
            renderScheduledTasks();
            showNotification(`Task '${task.name}' ${task.isActive ? 'activated' : 'paused'}`, 'info');
        }
        window.toggleTaskActive = toggleTaskActive;

        // --- FEATURE TOUR FUNCTIONS ---
        function startFeatureTour() {
            if (typeof Shepherd === 'undefined') return;
            const tour = new Shepherd.Tour({
                useModalOverlay: true,
                defaultStepOptions: { cancelIcon: { enabled: true }, classes: 'shepherd-element', scrollTo: { behavior: 'smooth', block: 'center' } }
            });
            tour.addStep({ title: 'Welcome to Chat@AI!', text: "Let's quickly walk through a few key features to get you started.", attachTo: { element: '.welcome-card', on: 'bottom' }, buttons: [{ action() { return this.next(); }, text: 'Start Tour', classes: 'shepherd-button-primary' }] });
            tour.addStep({ title: 'Special AI Modes', text: 'You can switch to our specialized **Medical AI** for health-related questions. Your regular chat AI is always here too.', attachTo: { element: '#medical-ai-btn', on: 'right' }, buttons: [{ action() { return this.back(); }, classes: 'shepherd-button', text: 'Back' }, { action() { return this.next(); }, classes: 'shepherd-button-primary', text: 'Next' }] });
            tour.addStep({ title: 'Your Prompt Library', text: 'Save and reuse your favorite prompts here. This is great for saving time with frequent tasks!', attachTo: { element: '#prompt-library-btn', on: 'right' }, buttons: [{ action() { return this.back(); }, classes: 'shepherd-button', text: 'Back' }, { action() { return this.next(); }, classes: 'shepherd-button-primary', text: 'Next' }] });
            tour.addStep({ title: 'Schedule Prompts', text: 'Automate tasks by scheduling a prompt to run at a specific date and time.', attachTo: { element: '#scheduler-btn', on: 'right' }, buttons: [{ action() { return this.back(); }, classes: 'shepherd-button', text: 'Back' }, { action() { return this.next(); }, classes: 'shepherd-button-primary', text: 'Next' }] });
            tour.addStep({ title: 'Start Chatting!', text: "You're all set. Type your first message here to begin. You can also attach files or use your voice!", attachTo: { element: '#chat-input-area', on: 'top' }, buttons: [{ action() { return this.back(); }, classes: 'shepherd-button', text: 'Back' }, { action() { localStorage.setItem('hasCompletedTour', 'true'); return this.complete(); }, classes: 'shepherd-button-primary', text: 'Finish' }] });
            tour.start();
        }
        function runTourIfFirstTime() { try { if (localStorage.getItem('hasCompletedTour')) return; setTimeout(() => { if (document.getElementById('medical-ai-btn')) startFeatureTour(); }, 1000); } catch(e) { /* no-op */ } }

        function addEventListeners() {
            // Auth form switching
            showSignupBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });
            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });

            // Auth form submission
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);

            // Password visibility toggle
            document.getElementById('login-password-toggle').addEventListener('click', () => togglePasswordVisibility('login-password'));
            document.getElementById('signup-password-toggle').addEventListener('click', () => togglePasswordVisibility('signup-password'));

            // Advanced Auth UI Listeners
            signupPasswordInput.addEventListener('input', updatePasswordStrength);
            signupEmailInput.addEventListener('input', validateEmail);
            signupPasswordConfirmInput?.addEventListener('input', validatePasswordConfirm);
            forgotPasswordLink?.addEventListener('click', handleForgotPassword);
            googleSigninBtn?.addEventListener('click', handleGoogleSignin);
            resendVerificationBtn?.addEventListener('click', handleResendVerification);
            refreshVerificationBtn?.addEventListener('click', handleRefreshVerification);
            verifySignoutBtn?.addEventListener('click', handleLogout);

            // Profile & Logout
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('show');
                exportDropdown.classList.remove('show');
                themeDropdown.classList.remove('show');
            });
            logoutBtn.addEventListener('click', handleLogout);
            homeBtn.addEventListener('click', handleHome);
            
            // Profile Settings
            profileSettingsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                profileDropdown.classList.remove('show');
                showProfileSettings();
            });
            
            // Theme Selector
            themeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                themeDropdown.classList.toggle('show');
                profileDropdown.classList.remove('show');
                exportDropdown.classList.remove('show');
            });
            themeDropdown.addEventListener('click', (e) => {
                const themeOption = e.target.closest('.theme-option');
                if (themeOption) {
                    handleThemeChange(themeOption.dataset.theme);
                }
            });
            
            // Export Dropdown
            exportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportDropdown.classList.toggle('show');
                profileDropdown.classList.remove('show');
                themeDropdown.classList.remove('show');
            });
            exportDropdown.addEventListener('click', (e) => {
                const format = e.target.closest('.dropdown-item')?.dataset.format;
                if(format) {
                    handleExport(format);
                }
            });

            document.addEventListener('click', (e) => {
                 if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
                 if (!exportBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
                    exportDropdown.classList.remove('show');
                }
                 if (!themeBtn.contains(e.target) && !themeDropdown.contains(e.target)) {
                    themeDropdown.classList.remove('show');
                }
            });

            // Chat app event listeners
            chatForm.addEventListener('submit', handleSendMessage);
            newChatBtn.addEventListener('click', startNewChat);
            medicalAiBtn.addEventListener('click', toggleMedicalMode);
            chatAiBtn.addEventListener('click', switchToChatAI);
            menuBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            clearAllBtn.addEventListener('click', () => showDeleteModal(null));
            confirmDeleteBtn.addEventListener('click', confirmDeletion);
            cancelDeleteBtn.addEventListener('click', hideDeleteModal);
            closePreviewBtn.addEventListener('click', hidePreviewModal);
            stopGeneratingBtn.addEventListener('click', () => {
                stopGenerationFlag = true;
                if (isTTSActive) {
                    stopTTS();
                }
                showNotification('Generation stopped', 'info');
            });

            chatInput.addEventListener('input', () => {
                autoResizeTextarea(chatInput);
                updateSendButtonState();
            });

            // Paste images from clipboard (bonus feature)
            chatInput.addEventListener('paste', (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;

                for (const item of items) {
                    if (item.type.indexOf('image') === 0) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file) {
                            const fileId = `file-${Date.now()}-${Math.random().toString(36).slice(2,9)}`;
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                const base64Data = event.target.result.split(',')[1];
                                attachedFiles.push({ id: fileId, base64: base64Data, mimeType: file.type, name: file.name || 'pasted-image.png' });
                                displayFilePreview();
                                updateSendButtonState();
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                }
            });
            chatInput.addEventListener('keydown', handleTextareaKeydown);

            // Multimedia listeners
            attachFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            // Delegated listener: catch clicks on dynamic remove buttons inside filePreview
            filePreview.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('button[data-file-id]');
                if (removeBtn) {
                    removeAttachedFile(removeBtn.dataset.fileId);
                }
            });

            if (recognition) {
                micBtn.addEventListener('click', toggleVoiceRecognition);
                recognition.onresult = handleVoiceResult;
                recognition.onend = () => {
                    micIcon.classList.remove('mic-active', 'animate-pulse');
                    showNotification('Voice input ended', 'info');
                };
                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    micIcon.classList.remove('mic-active', 'animate-pulse');
                    showNotification('Voice recognition error', 'error');
                };
            } else {
                 micBtn.disabled = true;
            }

            // Delegated Listeners for dynamic content
            chatContainer.addEventListener('click', (e) => {
                const suggestionCard = e.target.closest('.suggestion-card');
                if (suggestionCard) {
                    fillSuggestion(suggestionCard.dataset.suggestion);
                    return;
                }
            });
            
            closeInteractiveModalBtn.addEventListener('click', hideInteractiveModal);

            // Enhanced Features Event Listeners
            promptLibraryBtn.addEventListener('click', showPromptLibrary);
            const imageGenBtn = document.getElementById('image-gen-btn');
            // --- Dropzone Overlay Drag & Drop Logic ---
            const dropzoneOverlay = document.getElementById('dropzone-overlay');
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            document.addEventListener('dragenter', (e) => {
                if (e.dataTransfer && e.dataTransfer.types.includes('Files')) {
                    dropzoneOverlay.style.opacity = '1';
                    dropzoneOverlay.style.pointerEvents = 'auto';
                }
            });
            document.addEventListener('dragleave', (e) => {
                if (e.target === document.documentElement) {
                    dropzoneOverlay.style.opacity = '0';
                    dropzoneOverlay.style.pointerEvents = 'none';
                }
            });
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzoneOverlay.style.opacity = '0';
                dropzoneOverlay.style.pointerEvents = 'none';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const fileList = new DataTransfer();
                    for (let i = 0; i < files.length; i++) {
                        fileList.items.add(files[i]);
                    }
                    handleDroppedFiles(fileList.files);
                }
            });

            // FAB removed: related JS was removed to prevent errors from missing FAB elements.

            // --- Handle Dropped Files ---
            function handleDroppedFiles(files) {
                if (!files || files.length === 0) return;
                for (const file of files) {
                    const fileId = `file-${Date.now()}-${Math.random()}`;
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64Data = event.target.result.split(',')[1];
                        const fileData = {
                            id: fileId,
                            base64: base64Data,
                            mimeType: file.type,
                            name: file.name
                        };
                        attachedFiles.push(fileData);
                        displayFilePreview();
                        updateSendButtonState();
                    };
                    reader.readAsDataURL(file);
                }
            }
            if (imageGenBtn) imageGenBtn.addEventListener('click', () => { if (typeof showImageGen === 'function') showImageGen(); });
            schedulerBtn.addEventListener('click', showScheduler);

            // Profile Settings Modal
            document.getElementById('close-profile-settings-btn').addEventListener('click', hideProfileSettings);
            document.getElementById('cancel-profile-settings-btn').addEventListener('click', hideProfileSettings);
            document.getElementById('save-profile-settings-btn').addEventListener('click', saveProfileSettings);
            document.getElementById('upload-avatar-btn').addEventListener('click', () => document.getElementById('avatar-upload').click());
            document.getElementById('avatar-upload').addEventListener('change', handleAvatarUpload);

            // Toggle switches
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                });
            });

            // Prompt Library Modal
            document.getElementById('close-prompt-library-btn').addEventListener('click', hidePromptLibrary);
            document.getElementById('add-prompt-btn').addEventListener('click', () => showAddPrompt());
            document.getElementById('search-prompts').addEventListener('input', renderPromptLibrary);
            // Category filter removed; tag filter bar handles filtering now

            // Add Prompt Modal
            document.getElementById('close-add-prompt-btn').addEventListener('click', hideAddPrompt);
            document.getElementById('cancel-add-prompt-btn').addEventListener('click', hideAddPrompt);
            document.getElementById('save-prompt-btn').addEventListener('click', savePrompt);

            // Scheduler Modal
            document.getElementById('close-scheduler-btn').addEventListener('click', hideScheduler);
            document.getElementById('add-schedule-btn').addEventListener('click', () => showAddSchedule());

            // Add Schedule Modal
            document.getElementById('close-add-schedule-btn').addEventListener('click', hideAddSchedule);
            document.getElementById('cancel-add-schedule-btn').addEventListener('click', hideAddSchedule);
            document.getElementById('save-schedule-btn').addEventListener('click', saveScheduledTask);

            historyFilterBar?.addEventListener('click', (e) => {
                const filterBtn = e.target.closest('.history-filter-btn[data-filter]');
                if (filterBtn) {
                    currentHistoryFilter = filterBtn.dataset.filter;
                    renderHistoryFilters();
                    renderHistorySidebar();
                }
            });

            resetHistoryFiltersBtn?.addEventListener('click', () => {
                currentHistoryFilter = 'all';
                renderHistoryFilters();
                renderHistorySidebar();
            });

            pauseAllSchedulesBtn?.addEventListener('click', pauseAllSchedules);
            resumeAllSchedulesBtn?.addEventListener('click', resumeAllSchedules);
            duplicateAllSchedulesBtn?.addEventListener('click', duplicateAllSchedules);
            viewTodaySchedulesBtn?.addEventListener('click', toggleTimelineFilterMode);
            pinLastChartBtn?.addEventListener('click', pinLastChart);

            ttsPreviewBtn?.addEventListener('click', previewTTSVoice);
            ttsQueueAddBtn?.addEventListener('click', queueLatestAssistantResponse);
            ttsClearQueueBtn?.addEventListener('click', () => {
                voiceQueue = [];
                renderVoiceQueue();
                showNotification('Voice queue cleared', 'info');
            });
            voiceQueueList?.addEventListener('click', (e) => {
                const playBtn = e.target.closest('[data-play-id]');
                const removeBtn = e.target.closest('[data-remove-id]');
                if (playBtn) {
                    playVoiceQueueItem(playBtn.dataset.playId);
                } else if (removeBtn) {
                    removeVoiceQueueItem(removeBtn.dataset.removeId);
                }
            });
        }

        // --- INITIALIZATION ---
        function init() {
            marked.setOptions({
                gfm: true,
                breaks: true,
                sanitizer: (html) => html,
                highlight: function (code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                }
            });
            initializeTheme();
            initializeMonaco();
            initializeTTS();
            initializeScrollHandling();
            initializePhotoSearch();
            addEventListeners();
            initializeMicroAnimations();
            if (pinLastChartBtn) pinLastChartBtn.disabled = true;
            checkAPIStatus();
            checkAuthState();
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
